myApp.controller("CVehicleController",["$scope","myService","$rootScope","$store","$http","$window","moment","$filter","$q","$parse",function(n,t,i,r,u,f,e,o,s){function a(){t.getQuoteDescription("MOTOR_OWNER_TYPE",n.new.Quote.OwnerType).then(function(t){n.new.Quote.ddOwnerTypeDesc=t.Description;n.CVehicle.ddBodyTypeDesc=v(n.CVehicle.ddBodyType)})}function v(n){return n=="Y"||n=="TRUE"?"Yes":n=="N"||n=="FALSE"?"No":void 0}var l;r.bind(i,"checkRefresh",0);n.wording={};n.CVehicle={};n.Proposer={};n.MakeList={};n.AddOnList=[];n.commissionRates={};n.new={Quote:{},Premium:{},Proposer:{},Address:{}};n.new.Quote.Mileage_Premium=0;n.CVehicle.ddOwnerTypeID=2;n.CVehicle.ddBusinessNatureID=31;n.CVehicle.ddDriverID=0;n.CVehicle.ddManufacturerID="";n.CVehicle.ddEngCapID=0;n.CVehicle.ddvBodyID=1;n.CVehicle.ddBodyTypeID=1;n.CVehicle.ddGearTypeID="";n.CVehicle.Model_Factor=1;n.CVehicle.ddVehicleModel="";n.CVehicle.ddUnladen="";n.CVehicle.ddLanden="";n.CVehicle.Tonnage;n.CVehicle.ddRegYearID=(new Date).getFullYear()-2;n.CVehicle.ddClaimsNoID=0;n.CVehicle.ddClaimsAmountID=0;n.CVehicle.ddDemeritPointID="";n.CVehicle.ddNCDEntitlementID=4;n.CVehicle.ddAuthorizedWS="";n.Proposer.ddGender="M";n.Proposer.ddIsMarried=2;n.Proposer.ddDrivingExperienceID=5;n.Proposer.ddNationalityID=0;n.fulfill="E";n.CVehicle.OT_isIndividual=!0;n.CVehicle.OT_isCompany=!1;n.showAgentSlider=!1;n.weightmsg="Invalid Maximum Unladen Weight";n.CVehicle.maxTonnage=5;$(".app-loading").show();n.CVehicle.ddNCDEntitlement=[];n.CVehicle.ddRegYear=[];n.fulfill="E";n.UseAddOn="N";n.CVehicle.startDate=e().format("DD/MM/YYYY");n.Proposer.Dob=e().subtract(40,"years").format("DD/MM/YYYY");n.ShowSaveQuote=!0;t.getQuoteDropDown_M("MOTOR_NCD_ENTITLEMENT").then(function(r){n.CVehicle.ddNCDEntitlement=r;t.getQuoteDropDown_M("PMOTOR_OCCUPATION").then(function(r){n.ddOccupationNature=r;t.getQuoteDropDown_M("COMMERCIAL_CLAIM_AMOUNT").then(function(r){n.ddClaimsAmount=r;t.getQuoteDropDown_M("MOTOR_OWNER_TYPE").then(function(r){n.ddOwnerType=r;t.getQuoteDropDown_M("PMOTOR_DEMERIT_FREE").then(function(r){n.CVehicle.ddDemerit=r;t.getQuoteDropDown_M("COMMERCIAL_BODY_TYPE_B2C").then(function(r){n.CVehicle.ddBodyType=r;t.getMotorMakeList(i.CommercialMakeType).then(function(i){n.ddMakeList=i;t.getQuoteDropDown_M("Vehicle_Addon_Person").then(function(i){n.ddAddonPerson=i;t.getQuoteDropDown_M("PMOTOR_DRIVING_EXPERIENCE").then(function(i){n.ddDrvingExperience=i;t.getQuoteDropDown_M("MARITAL_STATUS").then(function(i){n.ddMaritalStatus=i;t.getQuoteDropDown_M("COMMON_GENDER").then(function(i){n.ddGenderOpt=i;t.getQuoteDropDown_M("PMOTOR_DRIVER").then(function(i){n.ddDriver=i;t.getQuoteDropDown_M("COMMERCIAL_BUSINESS_NATURE").then(function(i){n.ddBusinessNature=i;t.getQuoteDropDown_M("PMOTOR_CLAIM").then(function(i){n.ddClaimsNo=i;var r=$("#pId").val();t.getCommissionRates(r).then(function(t){t!=""&&(n.channelFactor=t.channelFactor.Channel_Factor,n.commissionRates=t.commissionRates)});n.saveStorage()})})})})})})})})})})})})})});n.saveStorage=function(){n.CVehicle.ddMakeDescID=n.ddMakeList[0].Description;n.CVehicle.ddvMakeID=n.ddMakeList[0].Id;t.GetCommercialVehicleDefaultValues().then(function(t){var f,u;t!=""&&(t.CVehicle_Param!=null&&(n.sessionData=t,n.CVehicle.ddvMakeID=t.CVehicle_Param.Manufacturer,f=o("filter")(n.ddMakeList,{Id:n.CVehicle.ddvMakeID},!0),f.length&&(n.CVehicle.ddMakeDescID=f[0].Description),n.CVehicle.ddRegYearID=t.CVehicle_Param.RegYear,n.CVehicle.ddNCDEntitlementID=t.CVehicle_Param.NCDEntitlement,n.Proposer.ddDrivingExperienceID=t.CVehicle_Param.ddDrivingExperienceID,n.CVehicle.ddOwnerTypeID=t.CVehicle_Param.OwnerType,n.Proposer.ddIsMarried=t.Proposer.ddIsMarried,n.Proposer.ddGender=t.Proposer.ddGender,n.CVehicle.ddBodyTypeID=t.CVehicle_Param.vBody,n.CVehicle.ddVehicleModel=t.CVehicle_Param.vModel,n.CVehicle.ddUnladen=t.CVehicle_Param.Max_Unladen_Weight,n.CVehicle.ddLanden=t.CVehicle_Param.Max_Laden_Weight,n.CVehicle.Tonnage=t.CVehicle_Param.Tonnage,t.CVehicle_Param.BusinessNature!=null&&(n.CVehicle.ddBusinessNatureID=t.CVehicle_Param.BusinessNature),t.CVehicle_Param.Registration_No!=null&&t.CVehicle_Param.Registration_No!=""&&(n.new.Quote.Registration_No=t.CVehicle_Param.Registration_No),t.CVehicle_Param.Driver!=null&&t.CVehicle_Param.Driver!=0&&(n.CVehicle.ddDriverID=t.CVehicle_Param.Driver),t.CVehicle_Param.Demerit_Point!=null&&t.CVehicle_Param.Demerit_Point!=0&&(n.CVehicle.ddDemeritPointID=t.CVehicle_Param.Demerit_Point),t.CVehicle_Param.ClaimsNo!=null&&t.CVehicle_Param.ClaimsNo!=0&&(n.CVehicle.ddClaimsNoID=t.CVehicle_Param.ClaimsNo),t.CVehicle_Param.ClaimsAmount!=null&&t.CVehicle_Param.ClaimsAmount!=0&&(n.CVehicle.ddClaimsAmountID=t.CVehicle_Param.ClaimsAmount),t.CVehicle_Param.commissionRate!=0&&t.CVehicle_Param.commissionRate!=null&&(n.new.Quote.commissionRate=t.CVehicle_Param.commissionRate),t.CVehicle_Param.Excess!=0&&t.CVehicle_Param.Excess!=null&&(n.new.Quote.Excess=t.CVehicle_Param.Excess),t.CVehicle_Param.addOnList!=null&&(n.SavedAddOn=t.CVehicle_Param.addOnList)),t.Proposer!=null&&(u=t,u.Proposer.ddNameID!=""&&(n.Proposer.ddNameID=o("uppercase")(u.Proposer.ddNameID)),u.Proposer.ddNRICID!=""&&(n.Proposer.ddNRICID=o("uppercase")(u.Proposer.ddNRICID)),u.Proposer.Dob!=""&&(n.Proposer.Dob=u.Proposer.Dob),u.Proposer.ddGender!=""&&(n.Proposer.ddGender=u.Proposer.ddGender),u.Proposer.ddEligibleID!=""&&(n.Proposer.ddEligibleID=u.Proposer.ddEligibleID),u.Proposer.ddEmail!=""&&(n.Proposer.ddEmail=u.Proposer.ddEmail),u.Proposer.ddMobileID!=""&&(n.Proposer.ddMobileID=u.Proposer.ddMobileID),u.Proposer.ddPostalCodeID!=""&&(n.Proposer.ddPostalCodeID=u.Proposer.ddPostalCodeID),u.Proposer.ddIsMarried!=0&&(n.Proposer.ddIsMarried=u.Proposer.ddIsMarried),u.Proposer.ddNationalityID!=0&&(n.Proposer.ddNationalityID=u.Proposer.ddNationalityID),u.Proposer.ddSmokeCode!=""&&(n.Proposer.ddSmokeCode=u.Proposer.ddSmokeCode),u.Proposer.CouponCode!=""&&(n.Proposer.CouponCode=u.Proposer.CouponCode)));r.bind(n,"Proposer.ddNameID",n.Proposer.ddNameID);r.bind(n,"Proposer.ddGender",n.Proposer.ddGender);r.bind(n,"Proposer.Dob",n.Proposer.Dob);r.bind(n,"Proposer.ddSmokeCode",n.Proposer.ddSmokeCode);r.bind(n,"Proposer.occupation",n.Proposer.occupation);r.bind(n,"Proposer.ddEligibleID",n.Proposer.ddEligibleID);r.bind(n,"Proposer.ddNRICID",n.Proposer.ddNRICID);r.bind(n,"Proposer.ddMobileID",n.Proposer.ddMobileID);r.bind(n,"Proposer.ddEmail",n.Proposer.ddEmail);r.bind(n,"Proposer.ddNationalityID",n.Proposer.ddNationalityID);r.bind(n,"Proposer.ddIsMarried",n.Proposer.ddIsMarried);r.bind(n,"Proposer.ddPostalCodeID",n.Proposer.ddPostalCodeID);n.addYearsToEdate(n.CVehicle.startDate);r.bind(n,"CVehicle.startDate",n.CVehicle.startDate);r.bind(n,"CVehicle.endDate",n.CVehicle.endDate);r.bind(n,"CVehicle.ddDriverID",n.CVehicle.ddDriverID);r.bind(n,"CVehicle.ddManufacturerID",n.CVehicle.ddManufacturerID);r.bind(n,"CVehicle.ddvMakeID",n.CVehicle.ddvMakeID);r.bind(n,"CVehicle.ddvBodyID",n.CVehicle.ddBodyTypeID);r.bind(n,"CVehicle.ddMakeDescID",n.CVehicle.ddMakeDescID);r.bind(n,"CVehicle.ddBodyTypeID",n.CVehicle.ddBodyTypeID);r.bind(n,"CVehicle.ddVehicleModel",n.CVehicle.ddVehicleModel);r.bind(n,"CVehicle.ddUnladen",n.CVehicle.ddUnladen);r.bind(n,"CVehicle.ddLanden",n.CVehicle.ddLanden);r.bind(n,"CVehicle.ddRegYearID",n.CVehicle.ddRegYearID);r.bind(n,"CVehicle.ddClaimsNoID",n.CVehicle.ddClaimsNoID);r.bind(n,"CVehicle.ddClaimsAmountID",n.CVehicle.ddClaimsAmountID);r.bind(n,"CVehicle.ddNCDEntitlementID",n.CVehicle.ddNCDEntitlementID);r.bind(n,"CVehicle.ddEngCapID",n.CVehicle.ddEngCapID);r.bind(n,"CVehicle.ddGearTypeID",n.CVehicle.ddGearTypeID);r.bind(n,"CVehicle.ddDemeritPointID",n.CVehicle.ddDemeritPointID);r.bind(n,"CVehicle.ddOwnerTypeID",n.CVehicle.ddOwnerTypeID);r.bind(n,"CVehicle.ddBusinessNatureID",n.CVehicle.ddBusinessNatureID);r.bind(n,"Proposer.ddDrivingExperienceID",n.Proposer.ddDrivingExperienceID);r.bind(n,"CVehicle.fulfillment",n.CVehicle.fulfillment);n.setWording();n.GoToQuote();n.updateWording();i.$broadcast("clickBirthdayEvent");i.$broadcast("clickNewStartDateEvent");document.getElementById("input_eDate").style.opacity="0.4";n.getRegYear();n.getMakeList("C");n.$watch("MakeList.selected",function(t){n.getMakeDetails(angular.fromJson(t))});n.CVehicle.ddvMakeID!=""&&(n.MakeList.selected={Id:n.CVehicle.ddvMakeID,Description:n.CVehicle.ddMakeDescID},n.getMakeDetails(n.MakeList.selected));$("md-autocomplete md-autocomplete-wrap input").on("click touchstart",function(){$("md-autocomplete-wrap button").trigger("click")});$(".app-loading").hide()})};n.updateWording=function(){n.CVehicle.ddOwnerTypeID==i.Motor_Individual?(n.wording.owner="The Insured",n.wording.namedriver="named",n.wording.my="the"):(n.wording.owner="The company",n.wording.namedriver="main",n.wording.my="The")};n.setWording=function(){n.wording.IWantA="The Insured wants a/an";n.wording.IAm="The Insured";n.wording.am="is";n.wording.my="his or her";n.wording.weAre="They are";n.wording.pickYourPlan="Pick the Plan";n.wording.My="The";n.wording.benefitsForYourTravel="Benefits for the travel";n.wording.IOrAnyInsuredPerson="The Insured Person(s) and Applicant/Proposer";n.wording.I="The Insured";n.wording.forYourCar="";n.wording.yourLegalLiability="The Insured's liability";n.wording.you="Insured";n.wording.myWorkshop="Workshop";n.wording.owner="The Insured";n.wording.namedriver="named"};n.GoToQuote=function(){n.CVehicle.fulfillment!=!0?($("#motor-disclaimer").modal({backdrop:"static",keyboard:!1}),n.fulfill=="Y"?($("#motor-disclaimer").modal("hide"),$(".step1").show(),n.CVehicle.fulfillment=!0):n.fulfill=="E"||($("#motor-disclaimer").modal("hide"),$("#callbackmodal").modal({backdrop:"static"}))):$(".step1").show()};n.backToDisclaimer=function(){$("#callbackmodal").modal("hide");$("#motor-disclaimer").modal({backdrop:"static",keyboard:!1})};n.DetailsInfo=function(r){if(r){$(".app-loading").show();$("#my-contact-form #contact-form-button").remove();var u=" Name: [ "+n.feedbackName+" ] <br/> Phone: [ "+n.feedbackPhone+" ] <br/> Message: [ "+n.feedbackMsg+" ]<br/>Best time to call: [ "+n.feedbackTime+" ] ";t.sendFeeback(i.productConfig.Product_Name,u).then(function(){window.location="//www.etiqa.com.sg"})}};n.isInvalid=function(t){return n.proposerForm[t].$invalid&&n.proposerForm[t].$touched};n.isValid=function(t){return n.proposerForm[t].$valid};n.addYearsToEdate=function(t){if(t!=null&&t!=""){var i=e(t,"DD/MM/YYYY").add(1,"year").subtract(t.substr(0,5)=="29/02"?0:1,"days"),r=e(i).format("DD/MM/YYYY");n.CVehicle.endDate=r}};n.getRegYear=function(){var i=(new Date).getFullYear(),r,t;for(n.CVehicle.ddRegYear=[],r=i-25,t=r;t<=i;t++)n.CVehicle.ddRegYear.push({Id:t,Description:t})};n.changeClaimsNo=function(){var t=n.CVehicle.ddClaimsNoID;t==0?n.CVehicle.ddClaimsAmountID=0:n.CVehicle.ddClaimsAmountID==0&&(n.CVehicle.ddClaimsAmountID=500)};n.getMakeList=function(t){var i=s.defer(),r,u;return t?(r=[],u=t.toLowerCase(),r=n.ddMakeList.filter(function(n){return n.Description.toLowerCase().indexOf(u)>-1}),i.resolve(r)):n.ddMakeList!=null&&i.resolve(n.ddMakeList),i.promise};n.isMakeSelected=function(){return n.MakeList.selected!=undefined?n.MakeList.selected.Make_id==""?!1:!0:!1};n.getMakeDetails=function(t){t!=null&&(n.CVehicle.ddvMakeID=t.Id,n.CVehicle.ddMakeDescID=t.Description)};n.checkWeight=function(){n.weightmsg="Invalid Maximum Unladen Weight";n.quoteForm.dd_Unladen.$setValidity("unladen",!0);parseInt(n.CVehicle.ddUnladen)>parseInt(n.CVehicle.ddLanden)&&(n.quoteForm.dd_Unladen.$setValidity("unladen",!1),n.weightmsg="Maximum Laden Weight must be greater than Maximum Unladen Weight")};n.checkTonnage=function(){return n.CVehicle.Tonnage=(parseFloat(n.CVehicle.ddLanden)-parseFloat(n.CVehicle.ddUnladen))/1016,parseFloat(n.CVehicle.Tonnage)>0&&parseFloat(n.CVehicle.Tonnage)<=n.CVehicle.maxTonnage?!0:!1};n.backtoPlanSelection=function(){$(".app-loading").show();n.UseAddOn="N";n.new.Quote.addOnList=[];n.new.Quote.AuthWorkshop=0;n.CalculatePrice("Quotation")};n.GetQuote=function(r){var u,c,l,e,s,h,f;if($(".app-loading").show(),$("#SaveQuoteButton").show(),u="",r||(u+="Please fill in the form.  <br/>"),c=n.isMakeSelected(),c||(u+="Please fill in the make.  <br/>"),l=n.checkTonnage(),l==!1&&(u+="Invalid tonnage.<br/>The tonnage should not exceed 5 tonnes.<br/>"),n.quoteForm.$error!=undefined&&n.quoteForm.$error.required!=undefined)for(e=0;e<n.quoteForm.$error.required.length;e++)field=n.quoteForm.$error.required[e].$name,field=="gender"&&(n.genderInvalid=!0),n.quoteForm[field].$touched=!0;if(n.quoteForm.$pending!=undefined&&n.quoteForm.$pending.unique!=undefined)for(s=0;s<n.quoteForm.$pending.unique.length;s++)field=n.quoteForm.$pending.unique[s].$name,n.quoteForm[field].$touched=!0,n.quoteForm[field].$invalid=!0;if(n.quoteForm.$error!=undefined&&n.quoteForm.$error.Underwriter!=undefined)for(h=0;h<n.quoteForm.$error.Underwriter.length;h++)field=n.quoteForm.$error.Underwriter[h].$name,n.quoteForm[field].$touched=!0;r=n.quoteForm.$valid;r&&u==""&&c?$(".step1 .form-group").hasClass("has-error")?($(".app-loading").hide(),t.alertMsg("Please complete this form before submit")):(n.commissionRates!=null?n.commissionRates.Flexi_Commission==1?(n.new.Quote.defaultCommissionRate=n.commissionRates.Default_Commission_Rate,n.new.Quote.commissionRate||(n.new.Quote.commissionRate=n.commissionRates.Default_Commission_Rate)):n.new.Quote.commissionRate=-1:n.new.Quote.commissionRate=-1,n.new.Quote.channelFactor=n.channelFactor,n.CVehicle.ddOwnerTypeID==i.Motor_Company?(n.new.Quote.Driver=n.CVehicle.ddDriverID,n.new.Proposer={},n.new.Quote.IsMainDriver="N"):(n.new.Proposer={},n.new.Quote.IsMainDriver="Y",n.new.Quote.Driver=n.CVehicle.ddDriverID,n.new.Proposer.Dob=n.Proposer.Dob,n.new.Proposer.ddGender=n.Proposer.ddGender,n.new.Proposer.ddIsMarried=n.Proposer.ddIsMarried,f=o("filter")(n.ddMaritalStatus,{Id:n.Proposer.ddIsMarried},!0),f.length&&(n.new.Proposer.ddIsMarriedCode=f[0].Code),n.new.Proposer.drivingExperience=n.Proposer.ddDrivingExperienceID),n.new.Quote.OccupationNature=n.CVehicle.ddBusinessNatureID,n.new.Quote.sDate=n.CVehicle.startDate,n.new.Quote.eDate=n.CVehicle.endDate,n.new.Quote.Manufacturer=n.CVehicle.ddvMakeID,n.new.Quote.ClaimsNo=n.CVehicle.ddClaimsNoID,n.new.Quote.ClaimsAmount=n.CVehicle.ddClaimsAmountID,n.new.Quote.NCDEntitlement=n.CVehicle.ddNCDEntitlementID,f=o("filter")(n.CVehicle.ddNCDEntitlement,{Id:n.CVehicle.ddNCDEntitlementID},!0),f.length&&(n.new.Quote.NCDCode=f[0].Code,n.CVehicle.ddNCDEntitlementDesc=f[0].Description),n.new.Quote.RegYear=n.CVehicle.ddRegYearID,n.new.Quote.EngCap=n.CVehicle.ddEngCapID,n.new.Quote.vBody=n.CVehicle.ddBodyTypeID,n.new.Quote.BodyType=n.CVehicle.ddBodyTypeID,n.new.Quote.vModel=n.CVehicle.ddVehicleModel,n.new.Quote.AuthWorkshop=0,n.new.Quote.Demerit_Point=n.CVehicle.ddDemeritPointID,n.new.Quote.OwnerType=n.CVehicle.ddOwnerTypeID,n.new.Quote.BusinessNature=n.CVehicle.ddBusinessNatureID,n.new.Quote.ddDrivingExperienceID=n.Proposer.ddDrivingExperienceID,n.new.Quote.discount_rate=0,n.new.Quote.Max_Laden_Weight=n.CVehicle.ddLanden,n.new.Quote.Max_Unladen_Weight=n.CVehicle.ddUnladen,n.new.Quote.Tonnage=n.CVehicle.Tonnage,t.getDiscountRate(i.productConfig.Product_Id).then(function(t){t.length!=0&&(n.new.Quote.discount_rate=t[0].discount_rate,n.new.Quote.campaign_id=t[0].Campaign_Id,n.new.Quote.campaign=t[0].Campaign_Description);a();n.new.Quote.addOnList=[];n.CalculatePrice("Quotation")})):(u==""&&(u="Please fill in the form."),t.alertMsg(u),$(".app-loading").hide())};n.CalculatePrice=function(r){var f=JSON.stringify(n.new.Quote),e=JSON.stringify(n.new.Proposer);u.post(i.baseURL+"/quotation/GetCommercialMotorPlanPrice",{Quote:f,Proposer:e,product_Id:i.productConfig.Product_Id}).success(function(u){var f,e,o,s;if(u!="")if(result=angular.fromJson(u),n.planPrice=[],result.P_CoverageCount>0){for(f=0;f<=result.P_CoverageCount-1;f++)if(result.P_Is_Plan_Valid[f]=="1"&&n.planPrice.push({Prem:result.P_Prem[f],BasePrem:result.P_BasePrem[f],Gst:result.P_Gst[f],NetPrem:result.P_NetPrem[f],DisPrem:result.P_DisPrem[f],TotalPrem:result.P_TotalPrem[f],Excess:result.P_Excess[f],MinExcess:result.P_Min_Excess[f],MaxExcess:result.P_Max_Excess[f],Coverage:result.P_Coverage[f],Coverage_Name:"",AWS:"",NCD_Amount:result.P_NCD_Amount[f],campaign:n.new.Quote.campaign,campaign_id:n.new.Quote.campaign_id}),n.new.Quote.Cover!=undefined&&n.new.Quote.Cover!=null&&result.P_Coverage[f]==n.new.Quote.Cover&&(n.new.Quote.totalPrem=result.P_TotalPrem[f],n.AddOnList!=undefined&&n.AddOnList!=null))for(e=0;e<n.AddOnList.length;e++)if(result.AddList!=null)for(o=0;o<result.AddList[f].length;o++)s=result.AddList[f],n.AddOnList[e].AddOn_Code==s[o].AddOn_Code&&(n.AddOnList[e].premium=s[o].premium);r=="Quotation"&&angular.forEach(n.planPrice,function(r,u){t.getQuoteDescription("MOTOR_COVER_PACKAGE",r.Coverage).then(function(t){t!=null&&(parseInt(r.Coverage)==i.Motor_Cover_CO&&n.new.Quote.AuthWorkshop==1&&(n.planPrice[u].AWS=" (Authorised Workshop)"),n.planPrice[u].Coverage_Name=t.Description);u===n.planPrice.length-1&&(n.P_planName=n.planPrice[0].Coverage_Name+n.planPrice[0].AWS,$("#gotostep2").trigger("click"),$(".stepNav li:nth-child(1)").removeClass("active"),$(".stepNav li:nth-child(2)").addClass("active"),$(".app-loading").hide(),(n.new.Quote.Cover==undefined||n.new.Quote.Cover==null)&&(n.new.Quote.Cover=n.planPrice[0].Coverage),$(".app-loading").hide())})})}else r=="Quotation"&&$(".app-loading").hide();else r=="Quotation"&&$(".app-loading").hide()}).error(function(){r=="Quotation"&&$(".app-loading").hide()})};l=function(){n.ChangeAddOn()};n.ChangeAddOn=function(){n.new.Quote.addOnList=n.AddOnList;n.CalculatePrice()};n.ChooseAddOn=function(t){n.AddOnList[t].value=n.AddOnList[t].No_Insured==0?0:1;n.new.Quote.addOnList=n.AddOnList;n.CalculatePrice()};n.createAgentCommissionSlider=function(){if(n.new.Quote.channelFactor=n.channelFactor,n.commissionRates!=null){if(n.commissionRates.Flexi_Commission==1){h.noUiSlider!=undefined&&h.noUiSlider.destroy();n.new.Quote.defaultCommissionRate=n.commissionRates.Default_Commission_Rate;var t=n.commissionRates.Default_Commission_Rate;n.new.Quote.commissionRate!=null&&n.new.Quote.commissionRate!=0&&(t=n.new.Quote.commissionRate);n.showAgentSlider=!0;noUiSlider.create(h,{start:t*100,step:1,connect:!0,range:{min:n.commissionRates.Min_Commission_Rate*100,max:n.commissionRates.Max_Commission_Rate*100},pips:{mode:"steps",stepped:!0,density:4}});h.noUiSlider.on("slide",y);h.noUiSlider.on("change",p)}}else n.showAgentSlider=!1,n.new.Quote.commissionRate=-1};var h=document.getElementById("commissionSlider"),c=document.getElementById("sliderRegular"),y=function(){n.$apply(function(){n.new.Quote.commissionRate=(h.noUiSlider.get()/100).toFixed(2)})},p=function(){n.ChangeAddOn()},w=function(){n.$apply(function(){n.new.Quote.Excess=parseInt(c.noUiSlider.get())})},l=function(){n.ChangeAddOn()};n.AddOn=function(r){if(n.new.Quote.indexSelected=r,n.new.Quote.Cover=n.planPrice[r].Coverage,n.new.Quote.totalPrem=n.planPrice[r].TotalPrem,$(".app-loading").show(),n.createAgentCommissionSlider(),n.UseAddOn=="N"){if(parseInt(n.new.Quote.Cover)==i.Motor_Cover_CO&&((n.new.Quote.Excess==0||n.new.Quote.Excess==null)&&(n.new.Quote.Excess=n.planPrice[0].Excess),c.noUiSlider!=undefined&&c.noUiSlider.destroy(),n.planPrice[0].MinExcess!=n.planPrice[0].MaxExcess)){noUiSlider.create(c,{start:parseInt(n.new.Quote.Excess),step:50,connect:!0,range:{min:parseInt(n.planPrice[0].MinExcess),max:parseInt(n.planPrice[0].MaxExcess)},pips:{mode:"steps",stepped:!0,density:4}});c.noUiSlider.on("slide",w);c.noUiSlider.on("change",l)}n.UseAddOn="Y";t.GetProductAddOn(i.productConfig.Product_Id,n.planPrice[r].Coverage,n.new.Quote.NCDEntitlement,0).then(function(t){var f,u;if(t.length!=0)for($("#add-on").trigger("click"),$(".stepNav li:nth-child(2)").removeClass("active"),$(".stepNav li:nth-child(3)").addClass("active"),n.AddOnList=[],f=0,n.SavedAddOn!=null&&n.SavedAddOn!=undefined&&(f=n.SavedAddOn.length),u=0;u<t.length;u++)u<f?n.SavedAddOn[u].AddOn_Id==t[u].AddOn_Id?n.AddOnList.push({value:parseInt(n.SavedAddOn[u].value),premium:n.SavedAddOn[u].premium,AddOn_Code:n.SavedAddOn[u].AddOn_Code,AddOn_Description:n.SavedAddOn[u].AddOn_Description,AddOn_Id:n.SavedAddOn[u].AddOn_Id,No_Insured:n.SavedAddOn[u].No_Insured}):n.AddOnList.push({value:"0",premium:0,AddOn_Code:t[u].AddOn_Code,AddOn_Description:t[u].AddOn_Description,AddOn_Id:t[u].AddOn_Id,No_Insured:0}):n.AddOnList.push({value:"0",premium:0,AddOn_Code:t[u].AddOn_Code,AddOn_Description:t[u].AddOn_Description,AddOn_Id:t[u].AddOn_Id,No_Insured:0}),u===t.length-1&&(n.SavedAddOn!=null&&n.SavedAddOn.length!=0&&(n.new.Quote.addOnList=n.AddOnList,n.CalculatePrice()),$(".app-loading").hide());else parseInt(n.new.Quote.Cover)==i.Motor_Cover_CO||n.commissionRates.Flexi_Commission?($("#add-on").trigger("click"),$(".stepNav li:nth-child(2)").removeClass("active"),$(".stepNav li:nth-child(3)").addClass("active"),$(".app-loading").hide()):n.createApplication(r)})}else n.createApplication(r)};n.backToQuote=function(){$(".stepNav li:nth-child(2)").removeClass("active");$(".stepNav li:nth-child(1)").addClass("active")};n.changePlan=function(t){n.P_planName=n.planPrice[t].Coverage_Name;n.P_planName_AWS=n.planPrice[t].AWS};n.createApplication=function(r){$(".app-loading").show();typeof googleClickTrace=="function"&&googleClickTrace(i.productConfig.Product_Name,i.productConfig.Product_Id,n.planPrice[r].TotalPrem,i.productConfig.Category_Name,i.productConfig.Controller);n.new.Quote.Cover=n.planPrice[r].Coverage;n.new.Quote.productPlan=n.P_planName;n.new.Quote.OwnerType=n.CVehicle.ddOwnerTypeID;n.new.Quote.BusinessNature=n.CVehicle.ddBusinessNatureID;n.new.Quote.vMake=n.CVehicle.ddMakeDescID;n.new.Quote.vMakeID=n.CVehicle.ddvMakeID;n.new.Quote.vModel=n.new.Quote.vMake+" "+n.CVehicle.ddVehicleModel;n.new.Quote.NCDAmount=n.planPrice[r].NCD_Amount;n.new.Quote.Amount=n.planPrice[r].Prem;n.new.Quote.net_amount=n.planPrice[r].NetPrem;n.new.Quote.discount_amount=n.planPrice[r].DisPrem;n.new.Quote.base_prem=n.planPrice[r].BasePrem;n.new.Quote.totalPrem=n.planPrice[r].TotalPrem;n.new.Quote.riderPrem=n.planPrice[r].RiderPrem;n.new.Quote.rider_discountPrem=n.planPrice[r].RiderDisPrem;n.new.Quote.net_riderPrem=n.planPrice[r].NetRiderPrem;n.new.Quote.Excess=n.planPrice[r].Excess;n.new.Quote.unnamedExcess=n.planPrice[r].unnamed_Driver_Excess;n.new.Quote.youngDriverExcess=n.planPrice[r].young_Driver_Excess;n.planPrice[r].Mileage_Premium&&(n.new.Quote.Mileage_Premium=n.planPrice[r].Mileage_Premium);n.new.Quote.Windscreen=n.planPrice[r].Windscreen;n.new.Quote.Excess2=n.planPrice[r].Excess2;n.new.Quote.Max_Laden_Weight=n.CVehicle.ddLanden;n.new.Quote.Max_Unladen_Weight=n.CVehicle.ddUnladen;n.new.Quote.Tonnage=n.CVehicle.Tonnage;n.new.Quote.Valet_parking_Excess=n.planPrice[r].Valet_parking_Excess;n.new.Quote.gst=n.planPrice[r].Gst;n.new.Quote.campaign_id=n.planPrice[r].campaign_id;n.new.Quote.addOnList=n.AddOnList;n.new.Quote.SafeDriverDiscount=n.planPrice[r].Safe_Drive=="1"?"True":"False";n.new.Quote.SafeDrivePrem=n.planPrice[r].Safe_Drive_Prem;n.new.Quote.SafeDriveRate=n.planPrice[r].Safe_Drive_Rate;n.new.Quote.referral=i.productConfig.referral;n.new.Quote.referral_id=i.productConfig.referral_id;n.Proposer.CouponCode!=""&&(n.new.Proposer.CouponCode=n.Proposer.CouponCode);var e=JSON.stringify(n.new.Quote),o=JSON.stringify(n.new.Proposer);u({method:"post",url:i.baseURL+"/application"+i.productConfig.Product_URL,data:{Quote:e,Proposer:o},headers:{"X-Requested-With":"XMLHttpRequest",RequestVerificationToken:n.antiForgeryToken}}).success(function(){f.location.href=i.baseURL+"/application"+i.productConfig.Product_URL}).error(function(n){$(".app-loading").hide();console.log(n);t.alertMsg("Error occurred, please try again later.")})};n.SaveCarQuote=function(){n.CVehicle.ddOwnerTypeID==i.Motor_Company&&($("#SaveCarQuoteMainDriverNameId").show(),$("#SaveCarQuoteProposerNameId").hide(),$("#SaveCarQuoteCompanyNameDivID").show(),$("SaveCarQuoteCompanyNameDivID").attr("required",!0));$("SaveCarQuoteCompanyNameDivID").attr("required",!1);$("#SaveCarQuotePopUp").modal({backdrop:"static",keyboard:!1})};n.CancelSaveCar=function(){$("#SaveCarQuotePopUp").modal("hide");$("#SaveCarQuoteMainDriverNameId").hide();$("#SaveCarQuoteProposerNameId").show();$("#SaveCarQuoteCompanyNameDivID").hide()};n.DownloadSaveQuote=function(){n.FilePath!=undefined&&n.SaveQuoteNo!=undefined&&(f.location.href=i.baseURL+"/application/DownLoadMOMFile/"+n.FilePath+"/"+n.SaveQuoteNo+".pdf/")};n.SubmitSaveCar=function(){var r;if(!n.SaveCarQuoteForm.$invalid){$("#SaveCarQuotePopUp").modal("hide");$(".app-loading").show();r=n.new.Quote.indexSelected;n.new.Quote.Cover=n.planPrice[r].Coverage;n.new.Quote.OwnerType=n.CVehicle.ddOwnerTypeID;n.new.Quote.BusinessNature=n.CVehicle.ddBusinessNatureID;n.new.Quote.OccupationNature=n.CVehicle.ddBusinessNatureID;n.new.Quote.vMake=n.CVehicle.ddMakeDescID;n.new.Quote.vMakeID=n.CVehicle.ddvMakeID;n.new.Quote.ddVehicleModel=n.new.Quote.ddVehicleModel;n.new.Quote.Max_Laden_Weight=n.CVehicle.ddLanden;n.new.Quote.Max_Unladen_Weight=n.CVehicle.ddUnladen;n.new.Quote.Tonnage=n.CVehicle.Tonnage;n.new.Quote.NCDAmount=n.planPrice[r].NCD_Amount;n.new.Quote.Amount=n.planPrice[r].Prem;n.new.Quote.net_amount=n.planPrice[r].NetPrem;n.new.Quote.discount_amount=n.planPrice[r].DisPrem;n.new.Quote.base_prem=n.planPrice[r].BasePrem;n.new.Quote.totalPrem=n.planPrice[r].TotalPrem;n.new.Quote.riderPrem=n.planPrice[r].RiderPrem;n.new.Quote.rider_discountPrem=n.planPrice[r].RiderDisPrem;n.new.Quote.net_riderPrem=n.planPrice[r].NetRiderPrem;n.new.Quote.Excess=n.planPrice[r].Excess;n.new.Quote.unnamedExcess=n.planPrice[r].unnamed_Driver_Excess;n.new.Quote.youngDriverExcess=n.planPrice[r].young_Driver_Excess;n.planPrice[r].Mileage_Premium&&(n.new.Quote.Mileage_Premium=n.planPrice[r].Mileage_Premium);n.new.Quote.Windscreen=n.planPrice[r].Windscreen;n.new.Quote.Excess2=n.planPrice[r].Excess2;n.new.Quote.Valet_parking_Excess=n.planPrice[r].Valet_parking_Excess;n.new.Quote.gst=n.planPrice[r].Gst;n.new.Quote.campaign_id=n.planPrice[r].campaign_id;n.new.Quote.addOnList=n.AddOnList;n.new.Quote.SafeDriverDiscount=n.planPrice[r].Safe_Drive=="1"?"True":"False";n.new.Quote.SafeDrivePrem=n.planPrice[r].Safe_Drive_Prem;n.new.Quote.SafeDriveRate=n.planPrice[r].Safe_Drive_Rate;n.new.Quote.referral=i.productConfig.referral;n.new.Quote.referral_id=i.productConfig.referral_id;n.Proposer.ddNameID=n.SaveCarQuoteName;n.Proposer.drivingExperience=n.Proposer.ddDrivingExperienceID;n.new.Quote.Registration_No=n.SaveCarQuoteVehicleNo;n.new.Quote.Product_id=i.productConfig.Product_Id;var f=JSON.stringify(n.new.Quote),e=JSON.stringify(n.Proposer),o=JSON.stringify([]);u({method:"post",url:i.baseURL+"/quotation/SaveCarQuote",data:{Quote:f,Proposer:e,Insured:o},headers:{"X-Requested-With":"XMLHttpRequest",RequestVerificationToken:n.antiForgeryToken}}).success(function(t){$("#tab-content").hide();$(".app-loading").hide();$("#SaveQuoteSuccessPage").show();sessionStorage.clear();n.SaveQuoteNo=t.QuoteNo;n.FilePath=t.FilePath}).error(function(n){$(".app-loading").hide();console.log(n);t.alertMsg("Error occurred, please try again later.")})}}}]);myApp.controller("applicationCVehicleController",["$scope","myService","$rootScope","$store","$http","$window","$filter",function(n,t,i,r,u,f,e){function s(){t.getQuoteDescription("MOTOR_COVER_PACKAGE",n.new.Quote.Cover).then(function(i){n.new.Quote.descCover=i.Description;t.getQuoteDescription("MOTOR_NCD_ENTITLEMENT",n.new.Quote.NCDEntitlement).then(function(i){n.CVehicle.NCD_ENTITLEMENTDesc=i.Description;n.new.Proposer.ddIsMarried!=null&&t.getQuoteDescription("MARITAL_STATUS",n.new.Proposer.ddIsMarried).then(function(t){n.ddIsMarriedDesc=t.Description});t.getQuoteDescription("COMMERCIAL_BUSINESS_NATURE",n.new.Quote.occupationNature).then(function(i){n.ddoccupationNatureDesc=i.Description;t.getQuoteDescription("COMMERCIAL_BODY_TYPE_B2C",n.new.Quote.vBody).then(function(t){n.CVehicle.ddBodyTypeDesc=t.Description})})})});n.genderDesc=h(n.new.Proposer.ddGender);n.CVehicle.MyWorkShop=n.new.Quote.AuthWorkshop=="0"?"Yes":"No"}function h(n){return n=="Y"||n=="TRUE"?"Yes":n=="N"||n=="FALSE"?"No":n=="F"?"Female":n=="M"?"Male":void 0}$(".app-loading").show();n.Proposer={};n.wording={};r.bind(n,"SignInStatus",i.SignInStatus);i.isMemberSignUpOn=!1;t.getConfigVal("MEMBER_APP_FEATURE_ENABLE").then(function(n){i.isMemberSignUpOn=n.toUpperCase()});n.start8pattern=/[8-9]+[0-9]{7}/;n.CVehicle={};n.CVehicle.ddEngineNoID="";n.CVehicle.ddVehicleID="";n.CVehicle.ddChasisNoID="";n.CVehicle.ddNCDVehicleNoID="";n.CVehicle.ddFinanceID="";n.CVehicle.ddIsFinance="";n.CVehicle.ddOldPolicyNo="";n.OT_isIndividual=!1;n.OT_isCompany=!1;n.NCD_mismatch=!1;n.AddOnIndex={};n.AddOnIndex.ThirdPartyWorkingRisk=0;n.AddOnIndex.AirsideCover=1;n.AddOnIndex.PersonalAccidentBenefit=2;t.getNationality().then(function(i){n.ddNationality=i;t.getQuoteDropDown_M("COMMON_SALUTATION").then(function(i){n.ddSalutation=i;t.getQuoteDropDown_M("COMMON_ELIGIBLE").then(function(i){n.ddEligible=i;t.getQuoteDropDown_M("PMOTOR_DRIVING_EXPERIENCE").then(function(t){n.ddDrivingExperience=t;n.getSessionData()})})})});n.ddRelationship=[{ddRelationshipID:2,ddRelationshipName:"Spouse"},{ddRelationshipID:3,ddRelationshipName:"Child"},{ddRelationshipID:4,ddRelationshipName:"Others"},{ddRelationshipID:5,ddRelationshipName:"Employee"}];n.pdpaList=[{code:"PhoneCall",description:"Phone Call",selected:""},{code:"DirectMail",description:"Direct Mail",selected:""},{code:"SMS_MMS",description:"SMS/MMS",selected:""},{code:"Email",description:"Email",selected:""},{code:"Fax",description:"Fax",selected:""}];n.travel_pdpa_disable=!1;var o={};n.totalInsured=[];n.new={Quote:{},Proposer:{},Address:{}};n.setWording=function(){n.productConfig.IsB2C?(n.wording.my="My",n.wording.myPlanSelection="My Plan Selection"):(n.wording.my="The Insured's",n.wording.myPlanSelection="Plan Selection")};n.getSessionData=function(){u.post(i.baseURL+"/application/GetCommercialVehicleSession",{}).success(function(t){if(t!=""){n.setWording();o=angular.fromJson(t);n.new.Proposer=o.Proposer;n.Proposer=o.Proposer;r.bind(n,"Proposer.ddNameID",n.Proposer.ddNameID);r.bind(n,"Proposer.ddEligibleID",n.Proposer.ddEligibleID);r.bind(n,"Proposer.ddNRICID",n.Proposer.ddNRICID);r.bind(n,"Proposer.Dob",n.Proposer.Dob);r.bind(n,"Proposer.ddEmail",n.Proposer.ddEmail);r.bind(n,"Proposer.ddMobileID",n.Proposer.ddMobileID);r.bind(n,"Proposer.ddUnitID",n.Proposer.ddUnitID);r.bind(n,"Proposer.ddPostalCodeID",n.Proposer.ddPostalCodeID);r.bind(n,"Proposer.ddBlockID",n.Proposer.ddBlockID);r.bind(n,"Proposer.ddStreetID",n.Proposer.ddStreetID);r.bind(n,"Proposer.ddBuildingID",n.Proposer.ddBuildingID);n.new.Quote=o.CVehicle_Param;o.CVehicle_Param.Registration_No!=null&&o.CVehicle_Param.Registration_No!=""&&(n.CVehicle.ddVehicleID=o.CVehicle_Param.Registration_No);n.new.Quote.discount_rate!=undefined&&(n.new.Quote.discount_rate=n.new.Quote.discount_rate*100);r.bind(n,"CVehicle.ddVehicleID",n.CVehicle.ddVehicleID);r.bind(n,"CVehicle.ddEngineNoID",n.CVehicle.ddEngineNoID);r.bind(n,"CVehicle.ddChasisNoID",n.CVehicle.ddChasisNoID);r.bind(n,"CVehicle.ddNCDVehicleNoID",n.CVehicle.ddNCDVehicleNoID);r.bind(n,"CVehicle.ddIsFinance",n.CVehicle.ddIsFinance);r.bind(n,"CVehicle.ddFinanceID",n.CVehicle.ddFinanceID);r.bind(n,"CVehicle.ddOldPolicyNo",n.CVehicle.ddOldPolicyNo);s();n.saveStorage();googleAddToCartTrace(i.productConfig.Product_Name,i.productConfig.Product_Id,n.new.Quote.Amount,i.productConfig.Category_Name,i.productConfig.Controller,1,n.new.Quote.productPlan)}else n.backToSelectPlan(),sessionStorage.clear()}).error(function(t){alert("Your session has expired. Please try again.");n.backToSelectPlan();sessionStorage.clear();console.log(t)})};n.getNumOfDriver=function(){var f,u;for((n.new.Quote.Driver==undefined||n.new.Quote.Driver=="")&&(n.new.Quote.Driver=0),f=parseInt(n.new.Quote.Driver),u=1;u<=f;u++)r.bind(n,"totalInsured["+(u-1)+"].name",""),r.bind(n,"totalInsured["+(u-1)+"].eligible",""),r.bind(n,"totalInsured["+(u-1)+"].NRIC",""),r.bind(n,"totalInsured["+(u-1)+"].drivingExperience",""),r.bind(n,"totalInsured["+(u-1)+"].drivingExperienceDesc",""),r.bind(n,"totalInsured["+(u-1)+"].dob",""),r.bind(n,"totalInsured["+(u-1)+"].relationship",i.relationship_Other);n.new.Quote.Demerit_Point!=null&&t.getQuoteDescription("PMOTOR_DEMERIT_FREE",n.new.Quote.Demerit_Point).then(function(t){n.CVehicle.ddDemeritPointDesc=t.Description});n.new.Proposer.drivingExperience!=null&&t.getQuoteDescription("PMOTOR_DRIVING_EXPERIENCE",n.new.Proposer.drivingExperience).then(function(t){n.CVehicle.ddDrivingExperienceDesc=t.Description})};n.getDrivingExp=function(t,i){var r=e("filter")(n.ddDrivingExperience,{Id:i},!0);r.length&&(n.totalInsured[t].drivingExperienceDesc=r[0].Description)};n.saveStorage=function(){n.new.Quote.OwnerType!=""&&n.new.Quote.OwnerType!=undefined&&(n.getNumOfDriver(),n.new.Quote.OwnerType==i.Motor_Individual?(n.OT_isIndividual=!0,n.OT_isCompany=!1,(n.new.Quote.Driver==undefined||n.new.Quote.Driver=="")&&(n.new.Quote.Driver=0)):(n.OT_isIndividual=!1,n.OT_isCompany=!0));r.bind(n,"Proposer.ddComNameID","");r.bind(n,"Proposer.ddComNRICID","");r.bind(n,"Proposer.ddMobileID","");r.bind(n,"Proposer.ddEmail","");r.bind(n,"Proposer.ddUnitID","");r.bind(n,"Proposer.ddPostalCodeID","");r.bind(n,"Proposer.ddBlockID","");r.bind(n,"Proposer.ddStreetID","");r.bind(n,"Proposer.ddBuildingID","");i.$broadcast("clickPostalCodeEvent");n.Proposer.ddEmail!=""&&n.chkEmail(n.Proposer.ddEmail);$(".app-loading").hide();$("#step3_click").click();$(".stepNav li:nth-child(1)").removeClass("active");$(".stepNav li:nth-child(3)").addClass("active")};n.isSignUp=function(t){t?(i.SignUp=!0,n.chkEmail(n.Proposer.ddEmail)):(i.SignUp=!1,n.chkEmail(n.Proposer.ddEmail))};n.chkEmail=function(r){if(n.ContactForm!=undefined&&n.ContactForm.ddEmail_id!=undefined&&r!=""&&r!=undefined)if(i.SignUp==!0){var u=i.MemberUserType;t.chkUserExist(r,u).then(function(t){var i=t;i?(n.ContactForm.ddEmail_id.$setValidity("email",!1),$("#userExist").removeClass("ng-hide")):(n.ContactForm.ddEmail_id.$setValidity("email",!0),$("#userExist").addClass("ng-hide"))})}else i.SignUp==!1&&(n.ContactForm.ddEmail_id.$setValidity("email",!0),$("#userExist").addClass("ng-hide"))};i.$on("CallParentChkEmail",function(){n.chkEmail(n.Proposer.ddEmail)});n.backToSelectPlan=function(){$(".app-loading").show();f.location.href=i.baseURL+"/quotation"+i.productConfig.Product_URL};n.isInvalid=function(t){return n.ContactForm[t].$invalid&&n.ContactForm[t].$touched};n.isValid=function(t){return n.ContactForm[t].$valid};n.toSummary=function(r){var o;$(".app-loading").show();var f="",e="",u=!0;r||(f+="Please fill in all the highlighted details in red.  <br/>");n.mainForm.$error!=undefined&&angular.forEach(n.mainForm.$error,function(t,r){for(var f,u=r,o=0;o<n.mainForm.$error[u].length;o++)for(form=n.mainForm.$error[u][o].$name,f=0;f<n[form].$error[u].length;f++)e=n[form].$error[u][f].$name,e=="ddEligible_id"&&($("md-input-container md-select[name='ddEligible_id']").parent().addClass("has-error"),$("md-input-container md-select[name='ddEligible_id']").parent().removeClass("has-success")),i.isEmpty(e)||(n[form][e].$touched=!0,n[form][e].$invalid=!0)});r&&f==""&&u==!0?$(".step3 .form-group").hasClass("has-error")?($(".app-loading").hide(),t.alertMsg("Please complete this form before submit")):n.new.Quote.NCDEntitlement!=1?($(".app-loading").show(),o="",o=n.new.Quote.OwnerType==i.Motor_Company?n.Proposer.ddComNRICID:n.Proposer.ddNRICID,t.checkNCDEnquiry(n.CVehicle.ddNCDVehicleNoID,o,n.new.Quote.NCDCode,i.productConfig.Product_Id).then(function(i){i!="SYS_ERROR"?i=="MATCH"||i=="LAPSED"||i=="CANCELLED"?(n.calculatePrice(),u=!0):i=="MISMATCH"?(t.classicAlertMsg('The NCD value provided does not match with Merimen. Please click "Back To Quote" button to enter the correct NCD.'),$(".alertMsgQuote_ok").click(function(){n.backToSelectPlan()}),$(".alertMsgQuote_ok").text("Back to quote"),u=!1):(t.classicAlertMsg("We are not able to verify your NCD with Merimen. Please make sure that you have entered the correct NRIC/Fin No., Car Registration Number and the NCD correctly."),$(".alertMsgQuote_ok").click(function(){n.backToSelectPlan()}),$(".alertMsgQuote_ok").text("Back to quote"),u=!1):(t.alertMsg("Some error occur, please try again."),u=!1);u||$(".app-loading").hide()})):n.calculatePrice():(f==""&&(f="Please fill in all the highlighted details in red."),t.alertMsg(f),$(".app-loading").hide())};n.calculatePrice=function(){n.new.Quote.Registration_No=n.CVehicle.ddVehicleID;n.new.Quote.old_Policy_No=n.CVehicle.ddOldPolicyNo;n.new.Quote.ddNCDVehicleNoID=n.CVehicle.ddNCDVehicleNoID;n.new.Quote.EngineNo=n.CVehicle.ddEngineNoID;n.new.Quote.ChasisNo=n.CVehicle.ddChasisNoID;n.new.Quote.OwnerType==i.Motor_Individual?(n.new.Proposer.ddSalutationID=n.Proposer.ddSalutationID,n.new.Proposer.ddNameID=n.Proposer.ddNameID,n.new.Proposer.ddLastNameID=n.Proposer.ddLastNameID,n.new.Proposer.ddEligibleID=n.Proposer.ddEligibleID,n.new.Proposer.ddNRICID=n.Proposer.ddNRICID,n.new.Proposer.Dob=n.Proposer.Dob,n.new.Proposer.ddGender=n.Proposer.ddGender,n.new.Quote.ddIsMarried=n.new.Proposer.ddIsMarried):(n.new.Proposer.ddSalutationID="",n.new.Proposer.ddNameID=n.Proposer.ddComNameID,n.new.Proposer.ddEligibleID="",n.new.Proposer.ddNRICID=n.Proposer.ddComNRICID,n.new.Proposer.Dob="",n.new.Proposer.ddGender="");n.new.Proposer.MemberSignUp=i.SignUp;n.new.Proposer.ddEmail=n.Proposer.ddEmail;n.new.Proposer.ddMobileID=n.Proposer.ddMobileID;n.new.Address.ddUnitID=n.Proposer.ddUnitID;n.new.Address.ddPostalCodeID=n.Proposer.ddPostalCodeID;n.new.Address.ddBlockID=n.Proposer.ddBlockID;n.new.Address.ddStreetID=n.Proposer.ddStreetID;n.new.Address.ddBuildingID=n.Proposer.ddBuildingID;$("#gotostep4").trigger("click");$(".stepNav li:nth-child(3)").removeClass("active");$(".stepNav li:nth-child(4)").addClass("active");$(".app-loading").hide();window.scrollTo(0,0)};n.backToApplication=function(){$(".step3").show();$(".step4").hide()};n.Pdpa={};n.setConsent=function(t){t=="Y"?(n.Pdpa.consent="Y",n.pdpaList[0].selected="Y",n.pdpaList[1].selected="Y",n.pdpaList[2].selected="Y",n.pdpaList[3].selected="Y",n.pdpaList[4].selected="Y",n.Pdpa.PhoneCall="Y",n.Pdpa.DirectMail="Y",n.Pdpa.SMS_MMS="Y",n.Pdpa.Email="Y",n.Pdpa.Fax="Y",$(".travel-pdpa").css("opacity","1"),n.travel_pdpa_disable=!1,n.pdpaVal="Y"):t=="N"&&($(".travel-pdpa").css("opacity","0.6"),n.pdpaList[0].selected="N",n.pdpaList[1].selected="N",n.pdpaList[2].selected="N",n.pdpaList[3].selected="N",n.pdpaList[4].selected="N",n.Pdpa.consent="N",n.Pdpa.PhoneCall="N",n.Pdpa.DirectMail="N",n.Pdpa.SMS_MMS="N",n.Pdpa.Email="N",n.Pdpa.Fax="N",n.travel_pdpa_disable=!0,n.pdpaVal="N")};(i.SignUp==undefined||i.SignUp=="")&&(i.SignUp=!1);n.AddProduct=function(r,e){if(n.new.Quote.OwnerType==i.Motor_Company&&(e==undefined&&(e="N"),n.setConsent(e)),n.Pdpa.consent=="Y")if(n.pdpaList[0].selected=="Y"||n.pdpaList[1].selected=="Y"||n.pdpaList[2].selected=="Y"||n.pdpaList[3].selected=="Y"||n.pdpaList[4].selected=="Y")n.Pdpa.PhoneCall=n.pdpaList[0].selected=="Y"?"Y":"N",n.Pdpa.DirectMail=n.pdpaList[1].selected=="Y"?"Y":"N",n.Pdpa.SMS_MMS=n.pdpaList[2].selected=="Y"?"Y":"N",n.Pdpa.Email=n.pdpaList[3].selected=="Y"?"Y":"N",n.Pdpa.Fax=n.pdpaList[4].selected=="Y"?"Y":"N";else return t.alertMsg("Please check at least one Channel!"),!1;if(r&&n.new.Quote.Amount!="")if(e!=undefined){$(".app-loading").show();n.new.Address.newAddress=i.memberNewAddress;n.new.Address.updateAddressId=n.existAddress;n.new.Quote.Product_id=i.productConfig.Product_Id;n.new.Quote.Category_id=i.productConfig.Category_Id;var o=JSON.stringify([n.new.Quote]),s=JSON.stringify(n.new.Proposer),h=JSON.stringify(n.new.Address),c=JSON.stringify(n.totalInsured),l=JSON.stringify(n.Pdpa);u({method:"post",url:i.baseURL+"/application/AddApplicationData",data:{Quote:o,Proposer:s,Address:h,Insured:c,Pdpa:l,Product_id:i.productConfig.Product_Id},headers:{"X-Requested-With":"XMLHttpRequest",RequestVerificationToken:n.antiForgeryToken}}).success(function(n){n!="error"?n.newProposalNo!=undefined?t.checkBlackList(n.newProposalNo).then(function(r){r==!0?i.productConfig.IsB2C?t.alertMsgBackHome("We are unable to proceed with your application."):t.alertMsgBackAgent("We regret that we are unable to proceed with the application as this applicant is under our monitoring list.For the further assistance, please contact your Account Manager."):f.location=t.dataValidation(i.baseURL+n.urlLink)}):i.productConfig.IsB2C?t.alertMsgBackHome("We are unable to proceed with your application."):t.alertMsgBackAgent("Session timeout. We are unable to proceed with your application."):(t.alertMsg("Some error occur, please try again."),$(".save-loading").hide())}).error(function(n){$(".app-loading").hide();t.alertMsg("Some error occur, please try again.");console.log(n)})}else t.alertMsg("Please ensure you have checked the box to receive our communications, and also read, understood and agreed with the Terms and Conditions.");else t.alertMsg("Please fill in all the highlighted details in red.")};n.termsMore=function(){$("#motor-disclaimer").is(":visible")?$("#motor-disclaimer").modal("hide"):$("#motor-disclaimer").modal({backdrop:"static"})};n.Disagree=function(){$("#motor-disclaimer").modal("hide");n.termChecked=!1};n.Agree=function(){$("#motor-disclaimer").modal("hide");n.termChecked=!0};i.memberNewAddress=!1;n.existAddress=$("#addressId").val();r.bind(n,"existAddress",n.existAddress);n.checkExistAddress=function(r){r==0?(i.memberNewAddress=!0,n.Proposer.ddUnitID="",n.Proposer.ddPostalCodeID="",n.Proposer.ddBlockID="",n.Proposer.ddStreetID="",n.Proposer.ddBuildingID=""):(i.memberNewAddress=!1,t.getAddress(r).then(function(t){var i=t;i!=""&&i!=undefined?(n.Proposer.ddUnitID=i.Unit_No,n.Proposer.ddPostalCodeID=i.Postal_Code,n.Proposer.ddBlockID=i.Block,n.Proposer.ddStreetID=i.Street,n.Proposer.ddBuildingID=i.Building):(n.Proposer.ddUnitID="",n.Proposer.ddPostalCodeID="",n.Proposer.ddBlockID="",n.Proposer.ddStreetID="",n.Proposer.ddBuildingID="")}))};window.addEventListener("beforeunload",function(){n.Proposer.ddEmail!=null&&n.Proposer.ddEmail!=""&&emarsys(i.productConfig.Product_Id,n.Proposer.ddEmail,n.new.Quote.Amount,"ApplicationPage")})}])