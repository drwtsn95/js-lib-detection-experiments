
RightNow.EventProvider=RightNow.Widgets.extend({constructor:function(){this._events={};this._eventHandlers={};this._eventFilters={}},_addEventHandler:function(a,b){this._eventHandlers[a]=b;return this},_getEventHandlers:function(a){return this._eventHandlers[a]||{}},_addSubscribersFilter:function(a,b,d){if(!b||"function"!==typeof b)throw Error("Subscriber filters must be functions.");this._eventFilters[a]||(this._eventFilters[a]=[]);this._eventFilters[a].push({handler:b,context:d});return this},_getFilteredSubscriberIndices:function(a){var b=this._events[a];a=this._eventFilters[a];var d=[],c;if(a)for(var f=0;f<a.length;f++)c=a[f],c=c.handler.call(c.context,b),this.Y.Array.each(c,function(a){isNaN(a)||d.push(a)},this);return d},fire:function(a,b,d){var c=this._getEventHandlers(a),f=this._getFilteredSubscriberIndices(a),g=this._events[a],e=!0,k=[];c.pre&&(e=c.pre.call(this,b));if(!1!==e){if(g){d="undefined"!==typeof d?[b,d]:[b];for(var e=0,l=g.length,h,m;e<l;e++)-1===this.Y.Array.indexOf(f,e)&&(h=g[e],m=h.handler.call(h.context||window,a,d),h.once&&k.push(e),c.during&&c.during.call(this,m));if(l=k.length)for(e=0;e<l;e++)g.splice(k[e]-e,1)}c.post&&c.post.call(this,b)}return this},on:function(a,b,d,c){this._events[a]=this._events[a]||[];if(b&&"function"===typeof b)return this._events[a].push({handler:b,context:d,once:c}),this;throw Error("Handler specified isn't a callable function");},once:function(a,b,d){return this.on(a,b,d,!0)},detach:function(a,b,d){if(b&&"function"===typeof b){var c;if(c=this._events[a])for(a=c.length-1;0<=a;a--)c[a].handler!==b||d&&d!==c[a].context||c.splice(a,1);return this}throw Error("Handler specified isn't a callable function");}});
RightNow.RequiredLabel=function(){var a=new EJS({text:'<span class="rn_Required" aria-label="<%= requiredLabel %>"><%= requiredMarkLabel %></span>'});EJS.Helpers.prototype.getRequiredLabel=function(b,c){return a.render({requiredLabel:b||RightNow.Interface.getMessage("REQUIRED_LBL"),requiredMarkLabel:c||RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL")})}};
(function(){var l=function(){var b={},a={},f={};return{getDeferred:function(k,d){if(b[k])return b[k];a[d]=a[d]||{events:[]};a[d].form=k;return{on:function(b,c,h){if(c&&"function"===typeof c)return a[d].events.push({name:b,handler:c,context:h}),this;throw Error("Handler specified isn't a callable function");},addField:function(a,c){if(a&&c&&"object"===typeof c)f[k]||(f[k]={}),f[k][a]=c;else throw Error("A non-object field cannot be added to a form");}}},getInstance:function(a){return b[a]},newInstance:function(a,d){d instanceof RightNow.Form&&(b[a]=d)},getDeferredEvents:function(b){var d,e,c={};for(d in a)if(e=a[d],a.hasOwnProperty(d)&&e.form===b&&e.events.length){e=e.events;for(var h=0;h<e.length;h++)c[e[h].name]=c[e[h].name]||[],c[e[h].name].push(e[h])}return c},getDeferredFields:function(a){return f[a]}}}(),g=function(){function b(c,a,b,d){var e={},f=c.getAttribute("target");c.all("input, select, textarea").each(function(c){var a=c.get("type");""!==c.get("name")&&"submit"!==a&&"image"!==a&&(e[c.get("name")]=c.get("value"))});c=a+RightNow.Url.convertToSegment(e)+b;RightNow.Url.getSession()&&(c=RightNow.Url.addParameter(c,"session",RightNow.Url.getSession()));c=d.Y.Node.create("<a class='rn_Hidden'>form</a>").setAttribute("href",c);f&&c.setAttribute("target",f);d.Y.one(document.body).append(c);c=d.Y.Node.getDOMNode(c);document.createEvent?(d=document.createEvent("MouseEvents"),d.initEvent("click",!1,!1),c.dispatchEvent(d)):c.fireEvent("onclick")}function a(c){this.fire("response",new RightNow.Event.EventObject(this,{data:c}))}function f(c){this.fire("responseError",new RightNow.Event.EventObject(this,{data:c}))}function k(c,h,b){if(RightNow.Event.noSessionCookies())for(var d=0,e=b.length;d<e;d++)if("Contact.Login"===b[d].name){document.cookie="cp_login_start=1;path=/";break}b=RightNow.JSON.stringify(b);var k={form:b,updateIDs:RightNow.JSON.stringify({asset_id:RightNow.Url.getParameter("asset_id"),qid:RightNow.Url.getParameter("qid"),product_id:RightNow.Url.getParameter("product_id"),serial_no:RightNow.Url.getParameter("serial_no"),i_id:RightNow.Url.getParameter("i_id"),user_id:RightNow.Url.getParameter("user")})},g={scope:h,json:!0,successHandler:a,failureHandler:f};b=RightNow.UI.Form;null!=b.smartAssistant&&(k.smrt_asst=b.smartAssistant);null!==b.smartAssistantToken&&(k.saToken=b.smartAssistantToken);h.data.attrs.flash_message&&(k.flash_message=h.data.attrs.flash_message);h._originalEventObject&&(h._originalEventObject.data.timeout&&(g.timeout=h._originalEventObject.data.timeout),g=function(c,a){var b=["challengeHandler","challengeHandlerContext"],h,d;for(h=0;h<b.length;++h)d=b[h],c[d]=a[d]||void 0;return c}(g,h._originalEventObject));RightNow.Form.formToken.onNewToken(function(a){k.f_tok=a;RightNow.Ajax.makeRequest(c,k,g)})}var d={},e={};return{submitForm:function(c,a,d){var f=d.Y.one("#"+c),g=f.getAttribute("method"),m=f.getAttribute("action");c=e[c];a=a||"";if(m&&!d.data.attrs.on_success_url)if("post"===g.toLowerCase()||!RightNow.Text.beginsWith(m,"/")&&RightNow.Url.isExternalUrl(m)){a&&f.set("action",m+a);for(a=0;a<c.length;a++)(g=c[a])&&g.value&&((m=f.one('input[name="'+g.name+'"]')||f.one('textarea[name="'+g.name+'"]'))?m.set("value",g.value):f.append(d.Y.Node.create('<input type="hidden" name="'+g.name+'" value="'+d.Y.Escape.html(g.value)+'"/>')));f.submit()}else b(f,m,a,d);else k((m||"/ci/ajaxRequest/sendForm")+a,d,c)},resetValidatedFields:function(a){e[a]=[]},addValidatedField:function(a,b){e[a]||this.resetFormFields(a);delete b.data.form;e[a].push(b.data)},getValidatedFields:function(a){return RightNow.Lang.cloneObject(e[a])},addField:function(a,b,f){d[a]||(d[a]={});d[a][b]=f},findField:function(a,b){return d[a][b]},getAllFields:function(a){return d[a]||{}}}}();RightNow.Form=RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this._challengeDivID=this.data.attrs.challenge_location;this._parentForm=RightNow.UI.findParentForm(this.baseSelector);this.Y.one("#"+this._parentForm).on("submit",function(a){a.halt()});this._errorMessageDiv=this.Y.one("#"+this.data.attrs.error_location);this._formButton=this.Y.one(this.baseSelector+"_Button");this._errorMessageDiv||(this._errorMessageDiv=this.Y.Node.create("<div id='rn_"+this.instanceID+"_ErrorLocation'>"),this._formButton.insert(this._errorMessageDiv,"before"));if(this._parentForm){if(l.getInstance(this._parentForm))throw Error("Can't have two different FormSubmits for a single form");l.newInstance(this._parentForm,this)}else throw RightNow.UI.addDevelopmentHeaderError(RightNow.Interface.getMessage("FORMSUBMIT_PLACED_FORM_UNIQUE_ID_MSG")),Error("An inappropriate form was specified");this._events=l.getDeferredEvents(this._parentForm);this.Y.Object.each(l.getDeferredFields(this._parentForm),function(a,b){g.addField(this._parentForm,b,a)},this);this._widgetInstantiationComplete=RightNow.Widgets.isWidgetInstantiationComplete();if(!this._widgetInstantiationComplete)RightNow.Event.on("evt_WidgetInstantiationComplete",function(){this._widgetInstantiationComplete=!0},this);this._addSubscribersFilter("submit",this._filterSubmittedWidgets,this);this._addEventHandler("submit",{pre:function(a){RightNow.Form.formToken.requestNewToken();g.resetValidatedFields(this._parentForm);this._challengeDivID&&(a.challengeHandler=RightNow.Event.createDelegate(this,this._challengeHandler));this._originalEventObject=a},during:function(a){!1===a?this._eventCanceled=!0:a instanceof RightNow.Event.EventObject&&g.addValidatedField(this._parentForm,a)},post:function(a){var b=this._eventCanceled?"fail":"pass";this._eventCanceled=!1;this.fire("validation:"+b,a)}})._addEventHandler("send",{post:function(a){this._eventCanceled||g.submitForm(this._parentForm,this.data.attrs.add_params_to_url,this);this._eventCanceled=!1},during:function(a){!1===a&&(this._eventCanceled=!0)}})._addEventHandler("collect",{pre:function(){this._collectedFields=[]},during:function(a){a&&this._collectedFields.push(a)},post:function(a){this.fire("submit",a)}})._addEventHandler("formUpdated");if(this.data.js.challengeProvider){try{this._challengeProvider=eval(this.data.js.challengeProvider)}catch(b){throw"Failed while trying to parse a challenge provider.  "+b;}this._createChallengeDiv();this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options);this.on("submit",this._onValidateChallengeResponse,this)}if(!this.data.js.f_tok)throw Error("This widget is required to have a `f_tok` form submission token");RightNow.Form.formToken.init(this.data.js.f_tok,this.data.js.formExpiration)}},_filterSubmittedWidgets:function(b){var a=g.getAllFields(this._parentForm),f=[];this.Y.Object.each(a,function(a,d){this.Y.Array.each(b,function(b,c){b.context===a&&-1===this.Y.Array.indexOf(this._collectedFields,d)&&f.push(c)},this)},this);return f},getValidatedFields:function(){return g.getValidatedFields(this._parentForm)},addField:function(b,a){g.addField(this._parentForm,b,a)},findField:function(b){if(!this._widgetInstantiationComplete)throw Error("Widget instantiation has not completed. This method can only be used after all widgets are constructed");return g.findField(this._parentForm,b)},hide:function(){RightNow.UI.hide(this._formButton)},show:function(){RightNow.UI.show(this._formButton)},disable:function(){this._formButton.set("disabled",!0)},enable:function(){this._formButton.set("disabled",!1)},_createChallengeDiv:function(){this.Y.one("#"+this._challengeDivID)||this._formButton.insert(this.Y.Node.create("<div id='"+this._challengeDivID+"' tabindex='-1'>"),"before")},_reportChallengeError:function(b){b=b||RightNow.Interface.getMessage("PLS_VERIFY_REQ_ENTERING_TEXT_IMG_MSG");this._errorMessageDiv.append("<div><b><a id ='rn_ChallengeErrorLink' href='javascript:void(0);'>"+b+"</a></b></div>");this.Y.one("#rn_ChallengeErrorLink").on("click",RightNow.Event.createDelegate(this,function(){this._challengeProvider.focus(this._challengeDivID);return!1}))},_challengeHandler:function(b,a,f){this._createChallengeDiv();this._challengeProvider||(this._challengeProvider=RightNow.UI.AbuseDetection.getChallengeProvider(b),this.on("submit",this._onValidateChallengeResponse,this),this._challengeProvider.create(this._challengeDivID,RightNow.UI.AbuseDetection.options));this._reportChallengeError(RightNow.UI.AbuseDetection.getDialogCaption(b));this.fire("validation:fail")},_onValidateChallengeResponse:function(){new RightNow.Event.EventObject(this,{data:{form:!1}});var b=this._challengeProvider.getInputs(this._challengeDivID);if(b.abuse_challenge_response)for(var a in b)b.hasOwnProperty(a)&&RightNow.Ajax.addRequestData(a,b[a])}},{find:function(b,a,f){if(b=RightNow.UI.findParentForm(b))return f?b:l.getDeferred(b,a);throw Error("You're using a form that doesn't have a proper form submit button or an id");},formToken:function(){function b(b,h){var e=h[0];if(e.data.newToken&&(!e.w_id||"RightNow.Form"===e.w_id)){a=e.data.newToken;e=f;g=(new Date).getTime()+e;for(var e=0,l=d.length,n;e<l;e++)n=d[e],n.callback.call(n.context,a);d=[]}}var a,f,g,d=[],e;return{init:function(c,d){a=c;var l=f=d;g=(new Date).getTime()+l;e||(RightNow.Event.on("evt_formTokenUpdate",b),e=!0)},requestNewToken:function(){(new Date).getTime()>=g&&RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject({instanceID:"RightNow.Form"},{data:{formToken:a}}))},onNewToken:function(b,e){(new Date).getTime()>=g?d.push({callback:b,context:e}):setTimeout(function(){b.call(e,a)},1)}}}()})})();
RightNow.Field=RightNow.Field||RightNow.EventProvider.extend({overrides:{constructor:function(){this.parent();this.data.js.name&&(this._fieldName=this.data.js.name,this._inputSelector=this.baseSelector+"_"+this._fieldName.replace(/\./g,"\\."),this.parentForm().addField(this._fieldName,this),this._addEventHandler("change"),this._addEventHandler("constraintChange",{post:function(){this.parentForm().fire("formUpdated")}}),this.parentForm().on("collect",this.onCollect,this));this.excludeFromValidation=this.data.attrs.hide_on_load||!1}},setConstraints:function(a){this.Y.Object.each({required:function(a){return"false"===a?!1:!!a},required_lvl:function(a){return parseInt(a,10)},min_required_attachments:function(a){return parseInt(a,10)}},function(b,c){a[c]&&(a[c]=b(a[c]))});this.fire("constraintChange",a);this.Y.Object.each(a,function(a,c){this.fire("constraintChange:"+c,{constraint:a})},this);this.parentForm().fire("formUpdated")},onCollect:function(){return this.isVisible()?this._fieldName:!1},isVisible:function(){return!this.excludeFromValidation},hide:function(){RightNow.UI.hide(this.baseSelector);this.excludeFromValidation=!0;var a=this.Y.one("#"+this.lastErrorLocation);this.lastErrorLocation&&a&&a.all("[data-field='"+this._fieldName+"']").remove();this.parentForm().fire("formUpdated")},show:function(){RightNow.UI.show(this.baseSelector);this.excludeFromValidation=!1;this.parentForm().fire("formUpdated")},getFieldName:function(){return this._fieldName},parentForm:function(a){return RightNow.Form.find(a||this.baseDomID,this.instanceID)},getParentFormID:function(){return RightNow.Form.find(this.baseDomID,this.instanceID,!0)},createEventObject:function(){return new RightNow.Event.EventObject(this,{data:{name:this.data.js.name,value:this.getValue(),required:this._isRequired(),form:this._parentForm}})},is:function(a){var b=this.data.js.type;return"text"===a?"Integer"===b||"String"===b||"Thread"===b:"selection"===a?"Boolean"===b||"NamedIDLabel"===b||"Country"===b||"StateOrProvince"===b:"date"===a?"Date"===b||"DateTime"===b:"email"===a?this.isCommonEmailType()||!0===this.data.js.email:"url"===a?this.data.js.url?!0:!1:"product"===a?"ServiceProduct"===b:"category"===a?"ServiceCategory"===b:"attachment"===a?"FileAttachmentIncident"===b:"password"===a?"Contact.NewPassword"===this._fieldName||"Contact.NewPassword_Validate"===this._fieldName:!1},isCommonEmailType:function(){return"Contact.Emails.PRIMARY.Address"===this._fieldName||"Contact.Emails.ALT1.Address"===this._fieldName||"Contact.Emails.ALT2.Address"===this._fieldName||"Incident.CustomFields.c.alternateemail"===this._fieldName},_isRadio:function(){var a=this.input.get("type");return this.Y.Lang.isArray(a)&&"radio"===a[0]},_reportError:function(a){this._errors=this._errors||[];this._errors.push(a)},validate:function(a,b){this._errors=a||[];this._value="undefined"!==typeof b?b:this.getValue();this._checkRequired()||this._checkValue();this.is("email")?this._errors.length||this._checkEmail():this.is("url")?this._errors.length||this._checkUrl():this._checkData();return!this._errors.length},_checkValue:function(){var a,b,c;if("Integer"===this.data.js.type){if(""!==this._value&&"number"!==typeof this._value)return this._reportError(RightNow.Interface.getMessage("VALUE_MUST_BE_AN_INTEGER_MSG"));a=parseInt(this._value,10);b=parseInt(this.data.js.constraints.maxValue,10);c=parseInt(this.data.js.constraints.minValue,10);if(this.Y.Lang.isNumber(b)&&a>b)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_LARGE_MAX_VALUE_MSG")+b+")");if(this.Y.Lang.isNumber(c)&&a<c)return this._reportError(RightNow.Interface.getMessage("VALUE_IS_TOO_SMALL_MIN_VALUE_MSG")+c+")")}else if("Contact.NewPassword"===this.data.js.name&&this.data.js.passwordLength&&(a=RightNow.Text.Encoding.utf8Length(this._value),b=this.data.js.passwordLength,a<b))return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b));if(null!==this._value&&(this.data.js.constraints.maxLength||this.data.js.constraints.minLength)){a=this._value.length;c=this.data.js.constraints.maxLength;b=this.data.js.constraints.minLength;if(c&&c<a)return this._reportError(RightNow.Text.sprintf(1===a-c?RightNow.Interface.getMessage("EXCEEDS_SZ_LIMIT_PCT_D_CHARS_1_LBL"):RightNow.Interface.getMessage("S_SZ_CHARS_CHARS_CHARS_XP_SBM_SZ_XCDD_MSG"),c,a-c));if(b&&b>a)return this._reportError(RightNow.Text.sprintf(1===b-a?RightNow.Interface.getMessage("CONTAIN_1_CHARACTER_MSG"):RightNow.Interface.getMessage("PCT_D_CHARACTERS_MSG"),b))}},_checkData:function(){if(null!==this._value&&""!==this._value){var a=this.data.js.constraints?this.data.js.constraints.regex:null;if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||"Contact.Address.PostalCode"===this._fieldName){if(!/^[-A-Za-z0-9,# +.()]+$/.test(this._value))return this._reportError("Contact.Address.PostalCode"===this._fieldName?RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_POSTAL_CODE_MSG"):RightNow.Interface.getMessage("PCT_S_IS_AN_INVALID_PHONE_NUMBER_MSG"))}else{if(a&&!(new RegExp(a)).test(this._value))return this._reportError("Contact.Login"===this._fieldName?RightNow.Interface.getMessage("PCT_S_CONT_SPACES_DOUBLE_QUOTES_LBL"):RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));if(this.data.js.channelID&&/\s/.test(this._value))return this._reportError(RightNow.Interface.getMessage("CONTAIN_SPACES_PLEASE_TRY_MSG"))}}},_checkEmail:function(){if(this._value)if("Incident.CustomFields.c.alternateemail"===this._fieldName)for(var a=0,b=this._value.split(/[,;]+/),c;a<b.length;a++)(c=this.Y.Lang.trim(b[a]))&&!RightNow.Text.isValidEmailAddress(c)&&this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"));else RightNow.Text.isValidEmailAddress(this._value)||this._reportError(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"))},_checkUrl:function(){null===this._value||""===this._value||RightNow.Text.isValidUrl(this._value)||this._reportError(RightNow.Interface.getMessage("IS_NOT_A_VALID_URL_MSG"))},_isRequired:function(){return this.is("product")||this.is("category")?this.data.attrs.required_lvl&&0<this.data.attrs.required_lvl||!1:this.is("attachment")?this.data.attrs.min_required_attachments&&0<this.data.attrs.min_required_attachments||!1:this.data.attrs.required?!0:!1},_checkRequired:function(){var a=!1;if(this._isRequired())if(this.is("date"))a=!/\d/.test(this._value);else if(""===this._value||!1===this._value||null===this._value)a=!0;a&&this._reportError(this.data.attrs.label_required);return a},getValue:function(){var a;if(this.is("selection"))this.input.size&&this._isRadio()?(a="",this.input.item(0).get("checked")?a=this.input.item(0).get("value"):this.input.item(1).get("checked")&&(a=this.input.item(1).get("value"))):a="checkbox"===this.input.get("type")?this.input.get("checked"):this.input.get("value");else if(this.is("date")){a="";var b={day:32,month:13,year:1900,hour:0,minute:0};this.input.each(function(a){var e=a.get("name").toLowerCase();this.Y.Object.each(b,function(f,d){null!==e.match(new RegExp(d+"$"))&&(b[d]=parseInt(a.get("value"),10))})},this);a=1900<b.year?b.year+"-"+b.month+"-"+b.day+" "+b.hour+":"+b.minute+":00":""}else this.is("product")||this.is("category")?a=this._selectedNode?this._selectedNode.hierValue||0:this._currentValue||0:this.input&&!this.is("attachment")&&(a=this._getTextFieldValue(this.input));return a},politeFocus:function(a){a&&(this.Y.all("[role=alert], [aria-live=assertive]").some(function(a){return!a.hasClass("rn_Hidden")&&(a.get("textContent")||a.get("innerText"))},this)||a.focus())},_getTextFieldValue:function(a){if(!a)return null;this._trimField(a);a=a.get("value");"Integer"===this.data.js.type?a=a&&!isNaN(Number(a))&&parseInt(a,10)===parseFloat(a)?parseInt(a,10):a:this.is("text")&&!this.is("password")&&""===a&&(a=null);return a},_trimField:function(a){a=a||this.input;if(this.is("text")&&!this.is("password")){var b=a.get("value");this.Y.Lang.isUndefined(b)||""===b||a.set("value",this.Y.Lang.trim(b))}},_initializeHint:function(){if(!this.data.attrs.always_show_hint)if(this.Y.Overlay){var a=this.Y.Node.create("<span id='"+this.baseDomID+"_Hint' aria-hidden='true'>"+this.data.attrs.hint+"</span>"),b={node:this.baseSelector,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]};this.data.info&&"RightNow.Widgets.SelectionInput"===this.data.info.class_name&&"Boolean"!==this.data.js.type?(a.addClass("rn_HintBoxRight"),b.node=this.Y.one(this.baseSelector+" select"),b.points=[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]):a.addClass("rn_HintBox");a=new this.Y.Overlay({bodyContent:a,visible:!1,zIndex:3,align:b});if(this.Y.UA.webkit&&("checkbox"===this.input.get("type")||this._isRadio())){for(var c=this.input instanceof this.Y.NodeList?this.input.item(this.input.size()-1):this.input;c.next();)c=c.next();this.input.on("click",function(){c.focus();a.show()})}else this.input.on("focus",function(){a.show()});this.input.on("blur",function(){a.hide()});a.render(this.baseSelector)}else this.input.get("parentNode").append(this.Y.Node.create("<span class='rn_HintText' aria-hidden='true'>"+this.data.attrs.hint+"</span>"))}},{requires:{standard:["overlay"]}});
RightNow.Widgets.SimpleSearch=RightNow.Widgets.extend({constructor:function(){this._searchField=this.Y.one(this.baseSelector+"_SearchField");if(!this._searchField)return;if(this.data.attrs.initial_focus&&this._searchField.focus)
this._searchField.focus();this.Y.Event.attach("click",this._onSearch,this.baseSelector+"_Submit",this);},_onSearch:function(){var searchValue=this._searchField.get('value'),searchString=searchValue===this.data.attrs.label_hint?'':searchValue;if(this.Y.Lang.trim(searchString)===''){RightNow.UI.displayBanner(this.data.attrs.label_enter_search_keyword,{type:'WARNING',focusElement:this._searchField});}
else{var url=this.data.attrs.report_page_url+this._urlParameters(this.Y.merge({kw:searchString,session:RightNow.Url.getSession()},this.data.js.url_parameters));RightNow.Url.navigate(this._addSearchParam(url));}},_urlParameters:function(parameters){var url='';if(typeof parameters==='object'){this.Y.Object.each(parameters,function(value,parameter){url=RightNow.Url.addParameter(url,parameter,value);});}
return url;},_addSearchParam:function(url){var searchParam='/search/1';if(url.indexOf(searchParam)===-1){url+=searchParam;}
return url;}});
RightNow.Widgets.LoginDialog=RightNow.Widgets.extend({constructor:function(){this._dialog=null;this._keyListener=null;this._currentForm='login';this._isSocialAction=false;this._redirectUrl='';this._container=this.Y.one(this.baseSelector);this._formContainer=this.Y.one('.rn_FormContent');this._initializeTriggerLink(this.data.attrs.trigger_element);var createAccountToggle=this.Y.one(this.baseSelector+'_FormTypeToggle');if(createAccountToggle){createAccountToggle.on('click',this._toggleForms,this);}
if(this.data.attrs.open_login_providers){RightNow.Event.on('evt_FederatedProviderSelected',function(){this.Y.Lang.later(200,this,this._adjustForOpenLoginExplanationArea);},this);}
this._conformLoginPlaceholders();RightNow.Event.subscribe("evt_formTokenUpdate",RightNow.Widgets.onFormTokenUpdate,this);if(this.data.js.email_password_message){this._createEmailMessageDialog();}},_createEmailMessageDialog:function(){var dialog=RightNow.UI.Dialog.messageDialog(this.data.js.email_password_message,{title:'Success',width:'100%',height:'100%'});dialog.show();return;},_initializeTriggerLink:function(id){var loginLink=this.Y.one('#'+id);if(loginLink){if(this.data.js.loginLinkOverride){loginLink.set('href',this.data.js.loginLinkOverride);RightNow.Event.on('evt_requireLogin',function(){RightNow.Url.navigate(this.data.js.loginLinkOverride);},this);}
else{RightNow.Event.on('evt_requireLogin',this._onLoginEventFired,this);loginLink.on("click",this._onLoginTriggerClick,this);}}
else{RightNow.Event.on('evt_requireLogin',this._onLoginEventFired,this);}},_toggleForms:function(){var visibleElement;this.Y.Array.each(['.rn_LoginDialogContent','.rn_SignUpDialogContent'],function(selector){var element=this._container.one(' '+selector).toggleClass('rn_Hidden');if(!element.hasClass('rn_Hidden')){visibleElement=element;}},this);visibleElement.one('input').focus();this._currentForm=visibleElement.get('className').toLowerCase().indexOf('login')>-1?'login':'create';if(this._dialog){if(this._dialog.centered){this._dialog.centered();}
this._swapDialogLabelsForForm(this._currentForm);}},_swapDialogLabelsForForm:function(form){var labels=[this.data.attrs.label_login_button,this.data.attrs.label_create_account_button],firstButton;if(form==='create'){labels.reverse();}
this._dialog.getButton(0).setHTML(labels[0]);this._container.one(this.baseSelector+'_FormTypeLabel').setHTML(labels[0]);this._container.one(this.baseSelector+'_FormTypeToggle').setHTML(labels[1]);},_onLoginEventFired:function(evt,args){if(args[0]&&args[0].data){var title=args[0].data.title;if(title){this._setDialogTitleText(title);}
if(args[0].data.isSocialAction){this._urlParamsToAdd=args[0].data.urlParamsToAdd;}}
this._onLoginTriggerClick(null,null,true);},_onLoginTriggerClick:function(event,args,triggeredFromSocialAction){RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject(this,{data:{formToken:this.data.js.f_tok}}));this._dialog||(this._dialog=this._createDialog());this._clearErrorMessage();this._isSocialAction=triggeredFromSocialAction;if(this._currentForm!=='login'){this._toggleForms();}
this._dialog.show();this._toggleWarningMessageOnSocialAction(false);RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);this._container.one(this.baseSelector+'_Form').all('input').some(function(input,index){if(input.get('value')===''||index>0){input.focus();return true;}},this);},_createDialog:function(){var dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,this._container,{buttons:[{text:this.data.attrs.label_login_button,handler:{fn:this._onSubmit,scope:this},name:'submit'},{text:this.data.attrs.label_cancel_button,handler:{fn:this._onCancel,scope:this,href:'javascript:void(0)'}}],width:'100%',height:'100%',fillHeight:'100%'});this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(dialog,this._onSubmit,this);dialog.validate=function(){return false;};RightNow.UI.show(this._container);if(RightNow.Env('module')==='standard'){dialog.cancelEvent.subscribe(this._onCancel,null,this);}
return dialog;},_onCancel:function(){this._clearErrorMessage();RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._toggleWarningMessageOnSocialAction(true);this._dialog.hide();},_clearErrorMessage:function(){var errorNode=this.Y.one(this.baseSelector+"_LoginErrorMessage");if(errorNode)
errorNode.setHTML('').removeClass('rn_MessageBox rn_ErrorMessage');},_shouldIgnoreEnterKey:function(name,event){if(name==="keyPressed"){var target=event[1].target,targetContents=target.getHTML();return(target.get('tagName')==='A'||targetContents===this.data.attrs.label_login_button||targetContents===this.data.attrs.label_cancel_button);}
return false;},_processLoginForm:function(form){var fields={error:false};form.all('input').each(function(input){var name=input.get('name'),nameInfo={value:input.get('value'),id:input.get('id')};if(name!=='Contact.Password')
nameInfo.value=this.Y.Lang.trim(nameInfo.value);fields[name]=nameInfo;if(name==='Contact.Login')
fields.error=this._validateUsername(fields[name].value);},this);return fields;},_validateUsername:function(username){if(username.indexOf(' ')>-1)
return RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_SPACES_MSG"),RightNow.Interface.getMessage("USERNAME_LBL"));if(username.indexOf('"')>-1)
return RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_CONTAIN_DOUBLE_QUOTES_MSG"),RightNow.Interface.getMessage("USERNAME_LBL"));if(username.indexOf("<")>-1||username.indexOf(">")>-1)
return RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_CNT_THAN_MSG"),RightNow.Interface.getMessage("USERNAME_LBL"));},_onSubmit:function(event,args){if(this._shouldIgnoreEnterKey(event,args))return;if(this._currentForm==='social'){this._submitSocialUserInfo();}
else if(this._currentForm==='create'){this._submitCreateAccountForm();}
else{this._submitLoginForm();}},_submitCreateAccountForm:function(){this.Y.Node.getDOMNode(this._container.one('.rn_SignUpDialogContent form button[type="submit"]')).click();},_submitLoginForm:function(){var fields=this._processLoginForm(this.Y.one(this.baseSelector+'_Form')),login=fields['Contact.Login'].value||'',password=(!this.data.attrs.disable_password&&fields['Contact.Password'])?fields['Contact.Password'].value:'';if(fields.error){return this._addLoginErrorMessage(fields.error,fields['Contact.Login'].id);}
var eventObject=new RightNow.Event.EventObject(this,{data:{login:login,password:password,url:window.location.pathname,w_id:this.data.info.w_id,f_tok:this.data.js.f_tok}});if(RightNow.Event.fire("evt_loginFormSubmitRequest",eventObject)){this._sendLoginForm(eventObject);}},_sendLoginForm:function(eventObject){this._toggleLoading(true);RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);!RightNow.Event.noSessionCookies()||RightNow.Event.setTestLoginCookie();RightNow.Ajax.makeRequest(this.data.attrs.login_ajax,eventObject.data,{successHandler:this._onResponseReceived,scope:this,data:eventObject,json:true});if(this.Y.UA.ie>0&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(document.getElementById(this.baseDomID+"_Form"));}},_onResponseReceived:function(response,originalEventObject){if(!RightNow.Event.fire("evt_loginFormSubmitResponse",{data:originalEventObject,response:response})){return;}
this._toggleLoading(false);if(response.success==1)
{this._redirectUrl=this._getRedirectUrl(response);this._dialog.cancelEvent.subscribe(function(){RightNow.Url.navigate(this._redirectUrl);},null,this);if(this._isSocialAction&&this._formContainer){this._toggleLoading(true);this._formContainer.setHTML('');var eventObject=new RightNow.Event.EventObject(this,{data:{url:window.location.pathname,w_id:this.data.info.w_id}});if(RightNow.Event.fire("evt_hasSocialUserRequest",eventObject)){var _self=this;RightNow.Ajax.makeRequest("/ci/ajaxRequest/getNewFormToken",{"formToken":eventObject.data.rn_formToken,"tokenIdentifier":eventObject.data.w_id},{successHandler:function(response){eventObject.data.rn_formToken=response.newToken;RightNow.Ajax.makeRequest(_self.data.attrs.has_social_user_ajax,eventObject.data,{successHandler:_self._onHasSocialUserResponse,scope:_self,data:eventObject,json:true});},scope:this,data:eventObject,json:true});}}
else{this._container&&this._container.set("innerHTML",response.message);RightNow.Url.navigate(this._redirectUrl);}}
else
{RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);this._addLoginErrorMessage(response.message,this._container.one('.rn_LoginDialogContent input').get('id'),response.showLink);}},_getRedirectUrl:function(result){var redirectUrl;result.sessionParm=RightNow.Text.getSubstringAfter(result.sessionParm,'session/');if(this.data.js&&this.data.js.redirectOverride){redirectUrl=RightNow.Url.addParameter(this.data.js.redirectOverride,'session',result.sessionParm);}
else{redirectUrl=this.data.attrs.redirect_url||result.url;if(result.addSession)
redirectUrl=RightNow.Url.addParameter(redirectUrl,'session',result.sessionParm);}
redirectUrl+=this.data.attrs.append_to_url;for(var param in this._urlParamsToAdd){redirectUrl=RightNow.Url.addParameter(redirectUrl,param,this._urlParamsToAdd[param]);}
if(result.forceRedirect){redirectUrl=RightNow.Url.addParameter(result.forceRedirect,'redirect',encodeURIComponent(redirectUrl));}
return redirectUrl;},_onHasSocialUserResponse:function(response,originalEventObject){this._isSocialAction=false;if(!RightNow.Event.fire("evt_loginFormHasSocialUserResponse",{data:originalEventObject,response:response})){return;}
if(response.socialUser===""&&this._formContainer){this._toggleLoading(false);this._currentForm="social";this._createSocialUserForm(this.data.attrs.label_social_user_info_desc);this._removeOpenLogin();}
else{RightNow.Url.navigate(this._redirectUrl);}},_removeOpenLogin:function(){var openLoginContainer=this.Y.one(this.baseSelector+' .rn_OpenLoginAlternative');if(this._formContainer&&openLoginContainer){openLoginContainer.remove();this._formContainer.setStyle('width','100%');}},_createSocialUserForm:function(description){this.Y.augment(this,RightNow.RequiredLabel);var templateData={domPrefix:this.baseDomID,labelDisplayName:RightNow.Interface.getMessage("DISPLAY_NAME_LBL"),socialUserInfoDesc:description},socialUserInfoForm=this.Y.Node.create(new EJS({text:this.getStatic().templates.socialUserForm}).render(templateData)),dialogButtons=this._dialog.getButtons();this._formContainer.setHTML(socialUserInfoForm);this.Y.one(this.baseSelector+'_DisplayName').focus();this.Y.one(this.baseSelector+'_DisplayName').on("blur",this._toggleErrorClass,this);if(dialogButtons.item){this._dialog.removeButton(dialogButtons.item(0)).removeButton(dialogButtons.item(1));this._dialog.addButton({label:this.data.attrs.label_social_user_finish_button,action:this._submitSocialUserInfo,context:this});}
else{dialogButtons[0].ancestor().remove();dialogButtons[1].ancestor().remove();dialogButtons.splice(0,2);var button=this.Y.Node.create('<div class="rn_MobileDialogButton"><button class="rn_Button">'+this.data.attrs.label_social_user_finish_button+'</button></div>');button.on("click",this._submitSocialUserInfo,this);this.Y.one('#'+this._dialog.id).one('.rn_PanelContent').append(button);dialogButtons.push(button);}
this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._onSubmit,this);},_submitSocialUserInfo:function(){var displayName=this.Y.one(this.baseSelector+"_DisplayName");if(displayName){this._dialogContent=this.Y.one(".rn_SocialUserInfoDialogContent");this._toggleLoading(true);var eventObject=new RightNow.Event.EventObject(this,{data:{displayName:this.Y.Lang.trim(displayName.get('value'))||'',url:window.location.pathname,w_id:this.data.info.w_id}});if(RightNow.Event.fire("evt_createSocialUserRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.create_social_user_ajax,eventObject.data,{successHandler:this._onSocialUserInfoResponse,scope:this,data:eventObject,json:true},this);}}},_onSocialUserInfoResponse:function(response,originalEventObject){if(response.success){RightNow.Url.navigate(this._redirectUrl);}
else if(this._errorDisplay=this.Y.one(this.baseSelector+"_SocialUserInfoErrorMessage")){this._toggleLoading(false);this._addLoginErrorMessage(this.data.attrs.label_incorrect_display_name,this.baseDomID+"_DisplayName",true);}},_addLoginErrorMessage:function(message,focusElement,showLink){this._errorDisplay||(this._errorDisplay=this.Y.one(this.baseSelector+"_LoginErrorMessage"));if(this._errorDisplay)
{this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage');if(showLink===false)
{this._errorDisplay.set("innerHTML",message);}
else
{this._errorDisplay.set("innerHTML",'<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>').get("firstChild").focus();}
this._errorDisplay.one("h2")?this._errorDisplay.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):this._errorDisplay.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorDisplay.one("h2").setAttribute('role','alert');}},_toggleLoading:function(turnOn){this._dialogContent||(this._dialogContent=this.Y.one(this.baseSelector+"_LoginContent"));this._dialogContent.all('input')[(turnOn)?'setAttribute':'removeAttribute']('disabled',true);this._container[(turnOn)?'addClass':'removeClass']('rn_ContentLoading');},_setDialogTitleText:function(text){if(this._dialog){this._dialog.setHeader(text);}
else{this.data.attrs.label_dialog_title=text;}},_conformLoginPlaceholders:function(){if(!this.data.attrs.login_field_placeholders||!('placeholder'in document.createElement('input'))){var form=this._container.one(this.baseSelector+'_LoginContent');form.all('label').removeClass('rn_ScreenReaderOnly');form.all('input').removeAttribute('placeholder');}},_adjustForOpenLoginExplanationArea:function(){var selected;this._container.all('.rn_ActionArea').some(function(el){if(el.getComputedStyle('display')!=='none'){selected=el;return true;}});if(selected){this._container.setStyle('minHeight',parseInt(selected.getComputedStyle('height'),10)+selected.get('offsetTop')+50+'px');}},_toggleWarningMessageOnSocialAction:function(shouldHide){if(!(this._isSocialAction&&this.data.attrs.show_social_warning))
return;var warningMessage=this._container.one('.rn_WarningMessage');shouldHide?RightNow.UI.hide(warningMessage):RightNow.UI.show(warningMessage);},_toggleErrorClass:function(){var toggleClass='addClass';if(this.Y.one(this.baseSelector+"_DisplayName").get('value')!==''){toggleClass='removeClass';}
this.Y.one(this.baseSelector+"_DisplayName")[toggleClass]("rn_ErrorField");this.Y.one(this.baseSelector+"_SocialUserInfoForm").one('label')[toggleClass]("rn_ErrorLabel");}});
RightNow.Widgets.OpenLogin=RightNow.Widgets.extend({constructor:function(){this._redirectUrl=this.data.attrs.redirect_url;if(this.data.attrs.one_click_access_enabled){this.Y.Event.attach("click",this._onLogin,this.baseSelector+"_ProviderButton",this);}
else{this.Y.Event.attach("click",this._onClick,this.baseSelector+"_ProviderButton",this);this.Y.Event.attach("click",this._onLogin,this.baseSelector+"_LoginButton",this);}
RightNow.Event.on("evt_requireLogin",this._socialAction,this);RightNow.Event.on("evt_FederatedProviderSelected",function(){this.Y.one(this.baseSelector+"_ActionArea").hide();},this);if(RightNow.Url.getParameter("emailerror")&&this.data.attrs.controller_endpoint.search(/twitter/i)>0){this._displayMessage("email");}
else if(this.data.js&&this.data.js.error){this._displayMessage("error",this.data.js.error);}},_socialAction:function(event,args){var data=(args[0]&&args[0].data)?args[0].data:null;if(data&&data.isSocialAction&&data.urlParamsToAdd){if(this._redirectUrl===''){this._redirectUrl=window.location.pathname;}
for(var param in data.urlParamsToAdd){this._redirectUrl=RightNow.Url.addParameter(this._redirectUrl,param,data.urlParamsToAdd[param]);}}},_onClick:function(event){var actionArea=this.Y.one(this.baseSelector+"_ActionArea");if(this.data.attrs.display_in_dialog){this._dialog=this._dialog||RightNow.UI.Dialog.actionDialog(RightNow.Interface.getMessage("LOGIN_LBL"),actionArea,{buttons:[{text:RightNow.Interface.getMessage("CANCEL_LBL"),handler:function(){this.hide();}}],cssClass:"rn_OpenLogin rn_OpenLoginDialog",navButtons:true,width:'100%'});if(this._dialog.submitEvent){this._dialog.cfg.setProperty("hideaftersubmit",false);this._dialog.submitEvent.subscribe(this._onLogin,null,this);}
this._dialog.show();}
else{RightNow.Event.fire("evt_FederatedProviderSelected",new RightNow.Event.EventObject(this));}
if(this.data.attrs.display_in_dialog){RightNow.UI.show(actionArea);this._selectProvider();}
else{actionArea.setStyle('opacity','0').removeClass("rn_Hidden").show();actionArea.transition({opacity:1,duration:0.1},RightNow.Event.createDelegate(this,this._selectProvider));}},_selectProvider:function(){var loginButton=this.Y.one(this.baseSelector+"_LoginButton");if(!this.data.attrs.openid&&loginButton){this._setAriaSelected(loginButton.set("tabIndex",-1)).focus();}
else if(this.data.attrs.openid&&this.data.attrs.openid_placeholder){this._selectOpenIDProvider();}},_setAriaSelected:function(selectedElement){this._setAriaSelected._items=this._setAriaSelected._items||[];var items=this._setAriaSelected._items,Dom=this.Y.DOM,alreadyInList=false,i,length;for(i=0,length=items.length;i<length;i++){Dom.setAttribute(items[i],'aria-selected','false');if(items[i]===selectedElement.get('id')){alreadyInList=true;}}
if(!alreadyInList){this._setAriaSelected._items.push(selectedElement.get('id'));}
return selectedElement.setAttribute('aria-selected','true');},_displayMessage:function(messageType,errorMessage){if(!this._displayMessage._displayingMessage){this._displayMessage._displayingMessage=true;if(messageType==="email"){this._displayEmailPrompt();}
else if(messageType==="error"){if(RightNow.UI!==undefined&&RightNow.UI.Dialog!==undefined){RightNow.UI.Dialog.messageDialog(errorMessage,{icon:"WARN",title:RightNow.Interface.getMessage("OOPS_LBL"),width:"330px"});}
else{alert(errorMessage);}}}},_displayEmailPrompt:function(){this.Y.augment(this,RightNow.RequiredLabel);var dialog,errorDiv,emailField,Dialog=RightNow.UI.Dialog,inputID=this.baseDomID+"_Email",dialogBody=this.Y.Node.create("<div class='rn_OpenLogin rn_OpenLoginDialog'></div>").set("innerHTML",new EJS({text:this.getStatic().templates.emailPrompt}).render({inputID:inputID,inputLabel:this.data.attrs.label_email_address,promptLabel:this.data.attrs.label_email_prompt})),successHandler=function(serverResponse){if(serverResponse.responseText==="true"){RightNow.Url.navigate(this.data.attrs.redirect_url);}
else{this._submittingEmail=false;dialog.enableButtons();Dialog.messageDialog(serverResponse.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"),{icon:"WARN"});}},submitHandler=function(){if(!this._submittingEmail){this._submittingEmail=true;dialog.disableButtons();emailField=emailField||this.Y.one("#"+inputID);if(emailField&&emailField.get("value")){var email=emailField.set("value",this.Y.Lang.trim(emailField.get("value"))).get("value");if(RightNow.Text.isValidEmailAddress(email)){RightNow.UI.hide(errorDiv);RightNow.Ajax.makeRequest(this.data.attrs.provide_email_ajax,{email:email,userData:RightNow.Url.getParameter("emailerror")},{successHandler:successHandler,scope:this});return;}
else if(errorDiv){errorDiv.removeClass("rn_Hidden").one("a").focus();}
else{errorDiv=this.Y.Node.create("<div class='rn_MessageBox rn_ErrorMessage'>"+"<a href='javascript:void(0);' onclick='document.getElementById(\""+inputID+"\").focus();'>"+
RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"),this.data.attrs.label_email_address)+"</a></div>");dialogBody.insert(errorDiv,'before');errorDiv.one("a").focus();}}
dialog.enableButtons();this._submittingEmail=false;}};dialog=Dialog.actionDialog(this.data.attrs.label_email_prompt_title,dialogBody,{buttons:[{text:this.data.attrs.label_email_prompt_submit_button,handler:{fn:submitHandler,scope:this},isDefault:true},{text:this.data.attrs.label_email_prompt_cancel_button,handler:function(){this.hide();}}],width:"330px"});Dialog.addDialogEnterKeyListener(dialog,submitHandler,this);dialog.show();},_selectOpenIDProvider:function(){if(this.data.attrs.openid_placeholder&&this.data.attrs.openid_placeholder.indexOf("[")>-1){var input=this.Y.one(this.baseSelector+"_ProviderUrl"),start,end,selection;if(input){this._setAriaSelected(input);input.focus();start=input.get("value").indexOf("[");end=input.get("value").indexOf("]")+1;if(input.get("value")&&start>-1&&end>start){input=this.Y.Node.getDOMNode(input);if(window.getSelection){selection=window.getSelection();if(selection.rangeCount>0)
selection.removeAllRanges();input.setSelectionRange(start,end);}
else if(document.selection&&document.selection.createRange){selection=input.createTextRange();selection.collapse(true);selection.moveStart("character",start);selection.moveEnd("character",end-start);selection.select();}}}}},_onLogin:function(evt){evt.preventDefault();if(this._cookiesEnabled()){var input=this.Y.one(this.baseSelector+"_ProviderUrl"),inputValue=((input)?input.set("value",this.Y.Lang.trim(input.get("value"))).get("value"):"");this._goToUrl(inputValue);}
else{RightNow.UI.Dialog.messageDialog(RightNow.Interface.getMessage("COOKIES_ENABLED_BROWSER_ORDER_LOG_MSG"),{icon:"WARN"});}},_goToUrl:function(inputValue){var goToUrl=function(url){if(this.Y.UA.ie){var Url=RightNow.Url,referLink=this.Y.Node.getDOMNode(this.Y.Node.create("<a class='rn_Hidden'></a>").set("href",((Url.getSession())?Url.addParameter(url,"session",Url.getSession()):url)));document.body.appendChild(referLink);referLink.click();}
else{RightNow.Url.navigate(url);}},urlToGoTo="";if(this.data.attrs.openid){if(this.data.attrs.preset_openid_url&&inputValue!==""&&inputValue!==this.data.attrs.openid_placeholder&&!RightNow.Text.isValidUrl(inputValue)){urlToGoTo=this.data.attrs.preset_openid_url.replace(/\[username\]/,inputValue);}
else if(!this.data.attrs.preset_openid_url&&inputValue!==this.data.attrs.openid_placeholder&&RightNow.Text.isValidUrl(inputValue)){urlToGoTo=inputValue;}
if(urlToGoTo){urlToGoTo=encodeURIComponent(urlToGoTo)+"/";}
else{return;}}
goToUrl.call(this,this.data.attrs.controller_endpoint+urlToGoTo+encodeURIComponent(this._redirectUrl));},_cookiesEnabled:function(){var noCookie=function(){return document.cookie==="";},setCookie=function(value){return(document.cookie=value);};if(noCookie()){if(setCookie("cp_login_start=1;path=/")&&noCookie()){return false;}
setCookie("");}
return true;}});
RightNow.Widgets.FormSubmit=RightNow.Form.extend({overrides:{constructor:function(){this.parent();this.inputDataChanged=false;this._formButton=this.Y.one(this.baseSelector+"_Button");this._formSubmitFlag=this.Y.one(this.baseSelector+"_Submission");this._navigateToUrlFlag=false;if(!this._formButton||!this._formSubmitFlag)return;if(this._formSubmitFlag.get("checked")){this._formButton.set("disabled","true");return;}
this.on("validation:fail",this._onFormValidationFail,this).on("validation:fail",this._resetFormButton,this,false).on("validation:pass",this._onFormValidated,this).on("response",this._defaultFormSubmitResponse,this).on("response",this._resetFormButton,this).on("submitRequest",this._onButtonClick,this).on("reset",this._resetFormForSubmission,this).on("responseError",this._onErrorResponse,this).on("formUpdated",this._onFormUpdated,this);this._toggleClickListener(true);RightNow.Event.subscribe("evt_formToggleButton",function(type,args){this._toggleClickListener(args[0]);},this);RightNow.Event.subscribe("evt_formInputDataChanged",function(){this.inputDataChanged=true;},this);if(this.data.attrs.unsaved_data_dialog){var that=this;window.onbeforeunload=function(e){if(that.inputDataChanged){return"";}};}}},_onButtonClick:function(evt){this.inputDataChanged=false;if(evt&&evt.halt){evt.halt();}
if(this._requestInProgress)return false;this._toggleClickListener(false);this._removeFormErrors();if(this.Y.UA.ie&&window.external&&"AutoCompleteSaveForm"in window.external){window.external.AutoCompleteSaveForm(document.getElementById(this._parentForm));}
this._fireSubmitRequest();},_fireSubmitRequest:function(){var eo=new RightNow.Event.EventObject(this,{data:{form:this._parentForm,f_tok:this.data.js.f_tok,error_location:this._errorMessageDiv.get("id"),timeout:this.data.attrs.timeout*1000}});RightNow.Event.fire("evt_formButtonSubmitRequest",eo);this.fire("collect",eo);},_onFormValidated:function(){this._toggleLoadingIndicators(true);this.fire("send",this.getValidatedFields());},_onFormValidationFail:function(){this._displayErrorMessages(this._errorMessageDiv);RightNow.Event.fire("evt_formValidateFailure",new RightNow.Event.EventObject(this));},_clearFlashData:function(){var infoDiv=this.Y.one('.rn_MessageBox.rn_InfoMessage');if(infoDiv){var parentClass=infoDiv.ancestor().getAttribute('class');if(parentClass&&parentClass.search("rn_SmartAssistantDialog")===-1)
infoDiv.set('innerHTML','').removeClass('rn_InfoMessage');}},_absoluteOffset:function(element){var top=0;do{top+=element.get('offsetTop');element=element.get('offsetParent');}
while(element);return top;},_displayErrorMessages:function(messageArea){messageArea.addClass("rn_MessageBox").addClass("rn_ErrorMessage").removeClass("rn_Hidden");this._clearFlashData();if(!this.Y.DOM.inViewportRegion(this.Y.Node.getDOMNode(messageArea),true)){(new this.Y.Anim({node:this.Y.one(document.body),to:{scrollTop:this._absoluteOffset(messageArea)-40},duration:0.5})).run();}
var firstField=messageArea.one("a");if(firstField){firstField.focus();firstField.setAttribute('role','alert');messageArea.removeAttribute('tabIndex');}
else{messageArea.set('tabIndex',0);messageArea.setAttribute('role','alert');messageArea.focus();}
var errorLbl=messageArea.all("div").size()>1?RightNow.Interface.getMessage("ERRORS_LBL"):RightNow.Interface.getMessage("ERROR_LBL");messageArea.prepend("<h2>"+errorLbl+"</h2>");messageArea.one("h2").setAttribute('role','alert');},_defaultFormSubmitResponse:function(type,args){if(this.fire('defaultResponseHandler',args[0])){this._formSubmitResponse(type,args);}},_formSubmitResponse:function(type,args){var responseObject=args[0].data,result;if(!this._handleFormResponseFailure(responseObject)&&responseObject.result){result=responseObject.result;if(!result.sa){if(result.transaction||result.redirectOverride){return this._handleFormResponseSuccess(result);}
else{this._displayErrorDialog();}}}
args[0].data||(args[0].data={});args[0].data.form=this._parentForm;RightNow.Event.fire('evt_formButtonSubmitResponse',args[0]);},_handleFormResponseSuccess:function(result){this._formSubmitFlag.set("checked",true);if(this.data.attrs.label_on_success_banner){RightNow.UI.displayBanner(this.data.attrs.label_on_success_banner,{focusElement:this._formButton}).on('close',function(){this._confirmOnNavigate(result);},this);return;}
this._confirmOnNavigate(result);},_handleFormResponseFailure:function(responseObject){if(!responseObject){this._displayErrorDialog(RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"));return true;}
if(responseObject.errors){var errorMessage="";this.Y.Array.each(responseObject.errors,function(error){errorMessage+="<div><b>"+error.externalMessage+"</b></div>";});this._errorMessageDiv.append(errorMessage);this._onFormValidationFail();return true;}
if(!responseObject.result){this._displayErrorDialog();return true;}
return false;},_navigateToUrl:function(result){var url;if(result.redirectOverride){url=result.redirectOverride+result.sessionParam;}
else if(this.data.attrs.on_success_url){var paramsToAdd='';this.Y.Object.each(result.transaction,function(details){if(details.key){paramsToAdd+='/'+details.key+'/'+details.value;}});if(paramsToAdd){url=this.data.attrs.on_success_url+paramsToAdd+result.sessionParam;}
else{var sessionValue=result.sessionParam.substr(result.sessionParam.lastIndexOf("/")+1);if(!sessionValue&&this.data.js.redirectSession)
sessionValue=this.data.js.redirectSession;url=RightNow.Url.addParameter(this.data.attrs.on_success_url,'session',sessionValue);}}
else{url=window.location+result.sessionParam;}
RightNow.Url.navigate(url+this.data.attrs.add_params_to_url);},_confirmOnNavigate:function(result){if(this.data.attrs.on_success_url!=='none'){if(this.data.attrs.label_confirm_dialog!==''){RightNow.UI.Dialog.messageDialog(this.data.attrs.label_confirm_dialog,{exitCallback:{fn:function(){this._navigateToUrl(result);},scope:this},width:'250px'});}
else{if(this.Y.Lang.trim(this.data.attrs.on_success_url)!==''){this._navigateToUrlFlag=true;}
this._navigateToUrl(result);}}},_resetFormForSubmission:function(){this._navigateToUrlFlag=false;this._removeFormErrors();this._resetFormButton();},_onFormUpdated:function(){if(this._errorMessageDiv.all('[data-field]').size()===0){this._errorMessageDiv.addClass("rn_Hidden").set("innerHTML","");}},_onErrorResponse:function(response){this._displayErrorDialog(response.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG"));this._resetFormButton();},_resetFormButton:function(){if(this._navigateToUrlFlag){return;}
this._toggleLoadingIndicators(false);this._toggleClickListener(true);},_removeFormErrors:function(){this._errorMessageDiv.addClass("rn_Hidden").setHTML("");},_displayErrorDialog:function(message){RightNow.UI.Dialog.messageDialog(message||RightNow.Interface.getMessage('ERROR_PAGE_PLEASE_S_TRY_MSG'),{icon:"WARN"});},_toggleLoadingIndicators:function(turnOn){this._formButton.setHTML((turnOn)?this.data.attrs.label_submitting_message:this.data.attrs.label_button).toggleClass('rn_Loading',turnOn);},_toggleClickListener:function(enable){if(this.Y.UA.ie){this._formButton.set("disabled",false);this.Y.one(this.baseSelector+" button").toggleClass("rn_IeFormButton",!enable);}
else{this._formButton.set("disabled",!enable);}
this._requestInProgress=!enable;this.Y.Event[((enable)?"attach":"detach")]("click",this._onButtonClick,this._formButton,this);}});
RightNow.Widgets.SelectionInput=RightNow.Field.extend({overrides:{constructor:function(){if(this.data.js.readOnly)return;this.parent();var attrs=this.data.attrs;this.input=(this.data.js.type==="Boolean"&&!attrs.display_as_checkbox)?this.Y.all(this._inputSelector+"_1, "+this._inputSelector+"_0"):this.Y.one(this._inputSelector);if(!this.input)return;if(attrs.hint&&!attrs.hide_hint&&!attrs.always_show_hint){this._initializeHint();}
if(attrs.initial_focus&&this.input){if(this.data.js.type==="Boolean"&&this.input[0]&&this.input[0].focus)
this.input[0].focus();else if(this.input.focus)
this.input.focus();}
if(attrs.validate_on_blur&&attrs.required){this.Y.Event.attach('blur',this.blurValidate,this.input instanceof this.Y.NodeList?this.input.item(1):this.input,this);}
this.input.on('change',function(){RightNow.Event.fire("evt_formInputDataChanged",null);this.fire('change',this);},this);this.on("constraintChange",this.constraintChange,this);var fieldName=this.data.js.name;if(fieldName==="Contact.Address.Country"){this.input.on("change",this.countryChanged,this);if(this.input.get('value'))
this.countryChanged();}
else if(fieldName==="Contact.Address.StateOrProvince"){this.currentState=this.input.get('value');RightNow.Event.on("evt_provinceResponse",this.onProvinceResponse,this);}
else if(fieldName==='Incident.StatusWithType.Status'){this.on('change',this.onStatusChanged,this);}
this.parentForm().on("submit",this.onValidate,this);}},swapLabel:function(container,requiredness,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){if(this.data.js.type==='Boolean'&&!this.data.attrs.display_as_checkbox){this.swapLabel(this.Y.one(this.baseSelector+'_Label'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.legend);}
else{this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);}}
this.data.attrs.required=constraint.required;},onValidate:function(type,args){var eo=this.createEventObject(),errors=[];this.toggleErrorIndicator(false);if(!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidationFailure",eo);return false;}
RightNow.Event.fire("evt_formFieldValidationPass",eo);return eo;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation);if(commonErrorDiv){for(var id=((this.input instanceof this.Y.NodeList)?this.input.item(0).get("id"):this.input.get("id")),i=0,message;i<errors.length;i++){message=errors[i];message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;commonErrorDiv.append("<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div>");}}
this.toggleErrorIndicator(true);},toggleErrorIndicator:function(showOrHide){var method=((showOrHide)?"addClass":"removeClass");this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");},blurValidate:function(){this.toggleErrorIndicator(!this.getValue());},countryChanged:function(){var value=this.input.get("value"),fireResponse=function(response,eventObject){RightNow.Event.fire("evt_provinceResponse",response,eventObject);};if(value){var eventObject=new RightNow.Event.EventObject(this,{data:{country_id:value}});if(RightNow.Event.fire("evt_provinceRequest",eventObject)){this._provinces=this._provinces||{};if(this._provinces[value]){return fireResponse(this._provinces[value],eventObject);}
RightNow.Ajax.makeRequest("/ci/ajaxRequestMin/getCountryValues",eventObject.data,{successHandler:function(response){this._provinces[value]=response;fireResponse(response,eventObject);},scope:this,json:true,type:"GETPOST"});}}
else{fireResponse({ProvincesLength:0,Provinces:{}});}},onProvinceResponse:function(type,args){var response=args[0],options='',provinces=response.Provinces,i,length;this.input.set("innerHTML","");if(provinces){if(!this.Y.Lang.isArray(provinces)){var temp=[];this.Y.Object.each(provinces,function(val){temp.push(val);});provinces=temp;}
if(!provinces[0]||(provinces[0].Name!=="--"&&!this.data.hideEmptyOption)){provinces.unshift({Name:"--",ID:""});}
for(i=0,length=provinces.length;i<length;i++){options+="<option value='"+provinces[i].ID+"'>"+provinces[i].Name+"</option>";}
this.input.append(options);this.input.set('value',this.currentState);}
this.currentState='';},onStatusChanged:function(){var threadInput=this.parentForm().findField('Incident.Threads');if(threadInput){threadInput.setConstraints({required:this.input.get('value')==='0'});}}});
RightNow.Widgets.DateInput=RightNow.Field.extend({overrides:{constructor:function(){if(this.data.js.readOnly)return;this.parent();var widgetContainer=this.Y.one(this.baseSelector);if(!widgetContainer)return;this.input=widgetContainer.all('select');if(!this.input)return;if(this.data.attrs.hint&&!this.data.attrs.hide_hint&&!this.data.attrs.always_show_hint){this._initializeHint();}
if(this.data.attrs.initial_focus&&this.input.item(0)&&this.input.item(0).focus){this.input.item(0).focus();}
if(this.data.attrs.validate_on_blur){this.input.item(this.input.size()-1).on('blur',this.blurValidate,this);}
this.input.on('change',function(){RightNow.Event.fire("evt_formInputDataChanged",null);this.fire('change',this);},this);this.on("constraintChange",this.constraintChange,this);this.parentForm().on('submit',this.onValidate,this);}},swapLabel:function(container,requiredness,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_Legend'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.legend);}
this.data.attrs.required=constraint.required;},onValidate:function(type,args){var eo=this.createEventObject(this),errors=[];this.toggleErrorIndicator(false);if(!this.validateValue(errors)||!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eo);return false;}
RightNow.Event.fire("evt_formFieldValidatePass",eo);return eo;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),fieldsToHighlight;if(commonErrorDiv){for(var id=((this.input instanceof this.Y.NodeList)?this.input.item(0).get("id"):this.input.get("id")),i=0,errorString="",message;i<errors.length;i++){message=errors[i];if(typeof message==="object"&&message.ids&&message.message){id=message.ids[0];fieldsToHighlight=message.ids;message=message.message;}
message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}
this.toggleErrorIndicator(true,fieldsToHighlight);},toggleErrorIndicator:function(showOrHide,fieldsToHighlight){var method=((showOrHide)?"addClass":"removeClass");if(fieldsToHighlight){this.input.each(function(field){if(this.Array.indexOf(fieldsToHighlight,field.get("id"))>-1){field[method]("rn_ErrorField");}},this.Y);}
else{this.input[method]("rn_ErrorField");}
this.Y.one(this.baseSelector+"_Legend")[method]("rn_ErrorLabel");},blurValidate:function(){this.toggleErrorIndicator((this.data.attrs.required&&!this.getValue())||!this.validateValue());},validateValue:function(errors){var errorNodes=[];this.input.each(function(input){if(input.get("value")==="")
errorNodes.push(input.get("id"));});if(errorNodes.length&&errorNodes.length!==this.input.size()){errors.push({ids:errorNodes,message:RightNow.Interface.getMessage("PCT_S_IS_NOT_COMPLETELY_FILLED_IN_MSG")});return false;}
else if(errorNodes.length===this.input.size()){return true;}
var year=this._getDateFieldValue('Year'),month=this._getDateFieldValue('Month'),day=this._getDateFieldValue('Day');if(new Date(year,month-1,day).getDate()!==day){errors.push(RightNow.Interface.getMessage("PCT_S_IS_NOT_A_VALID_DATE_MSG"));return false;}
if(this.data.attrs.min_year&&year<=this.data.attrs.min_year){var min=this.data.js.min,hour=this._getDateFieldValue('Hour');if(year<min.year||month<min.month||(month===min.month&&day<min.day)||(hour!==null&&(hour<min.hour&&day<=min.day))){errors.push(RightNow.Text.sprintf(RightNow.Interface.getMessage("VALUE_MIN_VALUE_PCT_S_MSG"),this.data.js.min_val));return false;}}
return true;},_getDateFieldValue:function(fieldName){var element=this.Y.one(this._inputSelector+'_'+fieldName);return(element)?parseInt(element.get('value'),10):null;}});
RightNow.Widgets.PasswordInput=RightNow.Field.extend({overrides:{constructor:function(){this.parent();this.input=this.Y.one(this._inputSelector);if(!this.input)return;this.inputLabel=this.Y.one(this.baseSelector+"_Label");this.currentPasswordField=this.Y.one(this._inputSelector+"_CurrentPassword");this.input.on('change',function(){this.fire('change',this);},this);this.on('constraintChange',this.constraintChange,this);if(this.data.attrs.require_validation){this.validation=this.Y.one(this._inputSelector+"_Validate");this.validationLabel=this.Y.one(this._inputSelector+"_LabelValidate");this.Y.one(this._inputSelector+'_Validate').on('change',function(){this.fire('change',this);},this);}
this.parentForm().on("submit",this.onValidate,this);if(this.data.js.requirements){this.initEvents();}
if(this.data.attrs.initial_focus){if(this.currentPasswordField&&this.currentPasswordField.focus)
this.currentPasswordField.focus();else if(this.input.focus)
this.input.focus();}},validate:function(errors){var attrs=this.data.attrs;this._value=this.input.get('value');this._checkData();if(this._errors){errors=this._errors.slice();}
if(attrs.required){this.toggleErrorIndicator(false,this.input,this.inputLabel);if(!this.input.get('value')){errors.push(attrs.label_required);this.toggleErrorIndicator(true,this.input,this.inputLabel);}}
if(!errors.length&&this.data.js.requirements&&!this.validateInput(true)){errors.push(RightNow.Interface.getMessage("PCT_S_REQUIREMENTS_MET_LBL"));}
if(attrs.require_validation){this.toggleErrorIndicator(false,this.validation,this.validationLabel);if(!this.validateValidation(true)){errors.push({text:RightNow.Text.sprintf(attrs.label_validation_incorrect,RightNow.Text.sprintf(attrs.label_validation,attrs.label_input))});this.toggleErrorIndicator(true,this.validation,this.validationLabel);}}
return!errors.length;}},swapLabel:function(container,requiredness,label,template){var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,requiredMarkLabel:RightNow.Interface.getMessage("FIELD_REQUIRED_MARK_LBL"),requiredLabel:RightNow.Interface.getMessage("REQUIRED_LBL"),hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},constraintChange:function(evt,constraint){constraint=constraint[0];if(this.data.js.requirements||(constraint.required===this.data.attrs.required))return;this.toggleErrorIndicator(false,this.input,this.inputLabel);if(this.data.attrs.require_validation){this.toggleErrorIndicator(false,this.validation,this.validationLabel);}
if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);this.inputLabel=this.Y.one(this.baseSelector+"_Label");}
if(this.data.attrs.require_validation){var labelValidate=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_input);this.swapLabel(this.Y.one(this.baseSelector+'_LabelValidateContainer'),constraint.required,labelValidate,this.getStatic().templates.labelValidate);this.validationLabel=this.Y.one(this._inputSelector+"_LabelValidate");}
this.data.attrs.required=constraint.required;},initEvents:function(){var input=this.input;input.on("focus",this.showOverlay,this,'input');input.on("blur",this.blurValidation,this,'input');input.on("keyup",this.validateInput,this);input.on('keydown',function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB){this.blurValidation((e.shiftKey)?false:e,'input');}},this);if(this.data.attrs.require_validation){var validation=this.validation;validation.on("focus",function(e,type){if(!this.inputOverlay||!this.inputOverlay.get("visible")){this.showOverlay(e,type);}},this,'validation');validation.on("blur",this.blurValidation,this,'validation');validation.on("keyup",this.validateValidation,this);validation.on('keydown',function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB){this.blurValidation((e.shiftKey)?false:e,'validation');}},this);}},getVerificationValue:function(){return this._getTextFieldValue(this.Y.one(this._inputSelector+'_Validate'));},onValidate:function(type,args){var eventObject=this.createEventObject(),errors=[];if(!this.validate(errors)){this.lastErrorLocation=args[0].data.error_location;this.displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eventObject);return false;}
if(this.data.attrs.require_current_password&&this.currentPasswordField){eventObject.data.currentValue=this.currentPasswordField.get('value');}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);return eventObject;},displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),errorLength=errors.length;if(commonErrorDiv&&errorLength){for(var i=0,errorString="",message,id,defaultID=this.input.get("id");i<errorLength;i++){message=errors[i];id=defaultID;if(typeof message==='object'&&message.text){if(message.id){id=message.id;}
message=message.text;}
else{message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+" "+message;}
errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}},toggleErrorIndicator:function(showOrHide,fieldToHighlight,labelToHighlight){var method=((showOrHide)?"addClass":"removeClass");fieldToHighlight[method]("rn_ErrorField");labelToHighlight[method]("rn_ErrorLabel");},showOverlay:function(e,type){var name=type+"Overlay";if(!this[name]){var overlay,element=this[type],insertInto=this.Y.one(this.baseSelector+((type==='input')?'_PasswordHelp':'')),content;if(type==='input'){content=this.Y.Node.create('<div class="rn_PasswordOverlay" />').setHTML(new EJS({text:this.getStatic().templates.overlay}).render({title:this.data.attrs.label_validation_title,instanceID:this.instanceID,validations:this.data.js.requirements,passwordRequirementsLabel:RightNow.Interface.getMessage("PASSWD_VALIDATION_REQS_READ_L_MSG")}));}
else{content=this.Y.one(this.baseSelector+'_PasswordValidationHelp').addClass('rn_PasswordOverlay').removeClass('rn_ScreenReaderOnly');}
if(this.Y.Overlay){overlay=new this.Y.Overlay({bodyContent:content,visible:false,zIndex:1,align:{node:element,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.TR]}}).render(insertInto);}
else{insertInto.append(content);overlay={_body:content,show:function(){this._body.removeClass('rn_Hidden');},hide:function(){this._body.addClass('rn_Hidden');},get:function(what){if(what==='visible'){return!this._body.hasClass('rn_Hidden');}
if(what==='bodyContent'){return this._body;}}};}
this[name]=overlay;}
this[name].align&&this[name].align();this[name].show();},blurValidation:function(e,type){var overlay=this[type+"Overlay"];if(!overlay||this._alreadyBlurring)return;if(e===false){overlay.hide();return;}
this.toggleErrorIndicator(false,this[type],this[type+"Label"]);if(this["validate"+type.charAt(0).toUpperCase()+type.slice(1)](true)){overlay.hide();}
else if(overlay.get('visible')){this.toggleErrorIndicator(true,this[type],this[type+"Label"]);if(e.keyCode){var overlayBody=overlay.get('bodyContent');overlayBody=(overlayBody.item)?overlayBody.item(0):overlayBody.one('*');this._alreadyBlurring=true;this.Y.Node.getDOMNode(overlayBody.setAttribute("tabIndex","-1")).focus();this._alreadyBlurring=false;e.halt();}
else if(type==='validation'){overlay.hide();}}},validationClasses:function(){return this.validationClasses.classes||(this.validationClasses.classes={fail:'rn_Fail',pass:'rn_Pass',progress:[{className:'rn_NoValidations',label:RightNow.Interface.getMessage("PASSWORD_IS_TOO_SHORT_MSG")},{className:'rn_AllValidations',label:RightNow.Interface.getMessage("PERFECT_LBL")},{className:'rn_SomeValidations',label:RightNow.Interface.getMessage("PASSWORD_IS_TOO_INSECURE_MSG")}]});},validateInput:function(e){if(e.keyCode===RightNow.UI.KeyMap.TAB)return;var Y=this.Y,password=this.input.get("value"),passed=0,total=0,requirements=this.data.js.requirements,checks=this._getPasswordStats(password);Y.Object.each(checks,function(value,key,className,requirement){if(!(requirement=requirements[key]))return;if((requirement.bounds==='max'&&value>requirement.count)||(requirement.bounds==='min'&&value<requirement.count)){className='fail';}
else{passed++;className='pass';}
this.updatePasswordChecklist(key,className);total++;},this);var UI=RightNow.UI,baseSelector=this.baseSelector,quotient=passed/total,index=Math.round(quotient);if(quotient!==index&&quotient>0.3){index=2;}
index=this.validationClasses().progress[index];UI.show(baseSelector+" .rn_Strength");UI.hide(baseSelector+" .rn_Intro .rn_Text");var meter=Y.one(baseSelector+" .rn_Meter");if(meter){meter.setHTML('<div class="'+index.className+'"></div>');}
meter=Y.one(baseSelector+"_MeterLabel");if(meter){meter.set("innerHTML",index.label);}
return passed===total;},validateValidation:function(){var validationValue=this.validation.get('value'),addRemoveClassOrder=[this.validationClasses().fail,this.validationClasses().pass];if(validationValue===this.input.get("value")){addRemoveClassOrder.reverse();}
if(this.validationOverlay){this.validationOverlay.get("bodyContent").addClass(addRemoveClassOrder[0]).removeClass(addRemoveClassOrder[1]);}
return addRemoveClassOrder[0]===this.validationClasses().pass;},updatePasswordChecklist:function(name,action){if(!(this._passwordChecklist||(this._passwordChecklist=this.Y.one(this.baseSelector+" ul.rn_Requirements"))))return;var className=this.validationClasses()[action],label=((action==='pass')?RightNow.Interface.getMessage("COMPLETE_LBL"):RightNow.Interface.getMessage("INCOMPLETE_LBL"));this._passwordChecklist.one("li[data-validate='"+name+"']").set('className',className).one(".rn_ScreenReaderOnly").set("innerHTML",label);},_getPasswordStats:function(password){var checks={repetitions:0,occurrences:0,uppercase:0,lowercase:0,special:0,specialAndDigits:0,length:0},len=password.length,lastChar='',i,j,char,occur,reps,lc,uc;for(i=0;i<len;i++){occur=0;char=password[i]||password.substr(i,1);if(char===lastChar){reps++;if(reps>checks.repetitions){checks.repetitions=reps;}}
else{lastChar=char;reps=1;}
for(j=0;j<len;j++){if((password[j]||password.substr(j,1))===char){occur++;}}
if(occur>checks.occurrences){checks.occurrences=occur;}
uc=char.toLocaleUpperCase();lc=char.toLocaleLowerCase();if(uc===lc&&lc===char){if(!isNaN(parseInt(char,10))){checks.specialAndDigits++;}
else{checks.specialAndDigits++;checks.special++;}}
else if(lc===char){checks.lowercase++;}
else if(uc===char){checks.uppercase++;}}
checks.length=len;return checks;}});
RightNow.Widgets.FileListDisplay=RightNow.Widgets.extend({constructor:function(){this._currentAttachments=this.data.js.attachments;RightNow.Event.on('evt_editSuccessFileRefresh',this._renderFileList,this);},_renderFileList:function(event,origEventObj){if(this.instanceID===origEventObj[0].data.instanceID){var fileAttachments=JSON.parse(origEventObj[0].data.fileAttachments);if(fileAttachments.length>0){var updatedFiles=new EJS({text:this.getStatic().templates.refreshedFileList}).render({attrs:this.data.attrs,fileAttachments:fileAttachments,instanceID:this.instanceID,thumbnailAltText:RightNow.Interface.getMessage("THUMBNAIL_FOR_ATTACHED_IMAGE_MSG")});this.Y.one(this.baseSelector).insert(updatedFiles,'replace');if(this.data.attrs.display_thumbnail){var i,widget=this.Y.one(this.baseSelector);for(i=0;i<fileAttachments.length;i++){if(RightNow.Text.beginsWith(fileAttachments[i].ContentType,'image')){var image=new Image;image.id=fileAttachments[i].ID;image.onload=function(){widget.one('#rn_File_'+this.id).one(' .rn_FileTypeImageThumbnail').set('src',this.src);}
image.src=fileAttachments[i].AttachmentUrl;}}}
this._currentAttachments=fileAttachments;}
else{this.Y.one(this.baseSelector).setHTML('');}}}});
RightNow.Widgets.GuidedAssistant=RightNow.Widgets.extend({constructor:function(){if(this.data.attrs.popup_window_url)return;this._currentLevel=1;this._guide=[];this._map=RightNow.Url.convertToArray(RightNow.Url.getParameterSegment());this._currentGuideID=this.data.js.guidedAssistant.guideID;this._originalGuideID=this._currentGuideID;this._guide[this._currentGuideID]=this.data.js.guidedAssistant;this._currentQuestion=this._guide[this._currentGuideID].questions[0].questionID;this._previousQuestions=[];this._eo=new RightNow.Event.EventObject(this,{data:{guideID:this._currentGuideID}});delete this.data.js.guidedAssistant;this._hasRecordedInitialInteraction=false;this.env=this._getEnvironment();var RightNowEvent=RightNow.Event;RightNowEvent.subscribe("evt_GuidedAssistanceGoToResponse",this._goToResponse,this);RightNowEvent.subscribe("evt_GuidedAssistanceGoToQuestion",this._goToQuestion,this);RightNowEvent.subscribe("evt_GuidedAssistanceAnswerViewed",this._answerViewed,this);RightNow.Widgets.formTokenRegistration(this);this._liveNotificationArea=this.Y.Node.create("<div class='rn_ScreenReaderOnly' role='alert'></div>");new this.Y.Node(document.body).insert(this._liveNotificationArea,0);this._attachDomEvents();this._initHistoryManager();RightNowEvent.fire("evt_GuideLoaded",this._eo);},_attachDomEvents:function(){this.Y.Event.attach("click",this._goBackHelper,this.baseSelector+"_BackButton",this);var widget=this.Y.one(this.baseSelector);widget.delegate("click",this._onClick,"input, button, a",this);widget.delegate("change",this._onSelectChange,"select",this);widget.delegate("keydown",function(e){if((e.keyCode===RightNow.UI.KeyMap.TAB&&this._changeFired)||e.keyCode===RightNow.UI.KeyMap.ENTER){this._onClick(e);}},"select",this);widget.delegate("mousedown",function(e){this._mouseTriggered=true;},"select",this);if(this.Y.UA.ie&&this.Y.UA.ie<9){RightNow.Event.on('evt_GuideQuestionRendered',function(evt,args){args=args[0];var question=args.data.question;if(args.w_id===this.instanceID&&(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION)){this.Y.one(this.baseSelector+'_Response'+args.data.guideID+'_'+question.questionID).one('select').on('change',this._onSelectChange,this);}},this);var initialSelect=this.Y.one(this.baseSelector+' select');if(initialSelect){initialSelect.on('change',this._onSelectChange,this);}}},_onSelectChange:function(e){this._changeFired=true;if(this._mouseTriggered||this.Y.UA.ie&&e.target.get("size")==="0"){this._mouseTriggered=false;this._onClick(e);}},_onClick:function(evt){var target=evt.target,tagName=target.get('tagName').toLowerCase(),id=target.get('id');if(((tagName==='a'||tagName==='button')&&typeof target.get('onclick')==='function')||(tagName==='input'&&target.get('type')==='text')||id.indexOf('BackButton')>0||id.indexOf('RestartButton')>0){return;}
var questionID=parseInt(target.getAttribute("data-question"),10),responseID=parseInt(target.getAttribute("data-response"),10),guideID=parseInt(target.getAttribute("data-guide"),10),answerID=parseInt(target.getAttribute("data-answer"),10),level=parseInt(target.getAttribute("data-level"),10);if(guideID&&tagName==='a'){this._linkClicked(evt,{guideID:guideID,questionID:questionID,responseID:responseID,answerID:answerID});return;}
if(guideID)
this.answerQuestion(target,guideID,questionID,responseID,level);},answerQuestion:function(element,guideID,questionID,responseID,level,skipped){if(guideID!==this._currentGuideID){if(!this._guide[guideID])
throw new Error("Missing guide");else
this._currentGuideID=guideID;}
if(!this._hasRecordedInitialInteraction){RightNow.ActionCapture.record('guidedAssistance','interact',this._currentGuideID);this._hasRecordedInitialInteraction=true;}
this._setAriaLoading(true);var question=this._getQuestionByID(questionID),response=this._getResponseByID(question,responseID);if(question){this._currentLevel=level+1;this._previousQuestions[level]=questionID;this._removeElements(questionID);this._removePairs(questionID);if(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION){if(element.get("options").item(element.get("selectedIndex")).get("value")){responseID=parseInt(element.get("options").item(element.get("selectedIndex")).get("value"),10);response=this._getResponseByID(question,responseID);}
else{this._previousQuestions.pop();this._currentLevel--;this._setAriaLoading(false);return;}}
else if(question.type===this.data.js.types.TEXT_QUESTION){var input=this.Y.one(this.baseSelector+"_Response"+guideID+"_"+questionID+"_"+responseID);if(input){input.set("value",this.Y.Lang.trim(input.get("value")));if(input.get("value")===""){input.focus();this._setAriaLoading(false);this._currentLevel--;this._previousQuestions.pop();return;}
response.value=input.get("value");}
else{this._setAriaLoading(false);return;}}
this._addPairs(question,response.value,level);this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[guideID].guideSessionID,ga_id:guideID,q_id:questionID,r_id:responseID,skipped:skipped},true);this._eo.data={guideID:guideID,questionID:questionID,responseID:responseID,responseValue:response.value};RightNow.Event.fire("evt_GuideResponseSelected",this._eo);if(this.data.attrs.single_question_display){if(question.type===this.data.js.types.RADIO_QUESTION||question.type===this.data.js.types.IMAGE_QUESTION)
element.set("checked",false);else if(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION)
element.set("selectedIndex",0);else if(question.type===this.data.js.types.TEXT_QUESTION)
element.set("value","");if(this._guideAppended){this._hideFirstGuideQuestion(questionID);this._guideAppended=false;}
else{this._toggleQuestion(question);}
this._toggleBackButton(true);}
else{if(question.type===this.data.js.types.LINK_QUESTION||question.type===this.data.js.types.BUTTON_QUESTION){this._highlightResponse(element,question.type);}
else if(element&&element.get("type")==="radio"&&element.get("checked")===false){element.set("checked",true);}}
this._buildNextResult(response);this._changeFired=false;this._setAriaLoading(false);}},_goToResponse:function(evt,args){var levelOfQuestion=this._goToQuestion(evt,args);if(typeof levelOfQuestion==='undefined'){return;}
var data=args[0].data,guideID=data.guideID,questionID=data.questionID,responseID=data.responseID,goToResponse=function(level){var question=this._getQuestionByID(questionID);if(question&&question.responses){for(var i=0,response;i<question.responses.length;i++){response=question.responses[i];if(response.responseID===responseID&&!(this._restoringState&&response.url)){this._answerQuestion(guideID,question,response,level);}}}};if(levelOfQuestion.guideID){var levelUpToSubGuide=this._goToResponse(this.instanceID,[{data:levelOfQuestion}]),restoringState=this._restoringState;this._guideLoadedCallback=function(idOfLoadedGuide){if(guideID===idOfLoadedGuide){this._guideLoadedCallback=null;this._currentGuideID=guideID;this._restoringState=restoringState;levelOfQuestion=this._goToQuestion(this.instanceID,[{data:{guideID:guideID,questionID:questionID,level:levelUpToSubGuide}}]);goToResponse.call(this,levelOfQuestion+levelUpToSubGuide);this._restoringState=false;}};}
else{goToResponse.call(this,levelOfQuestion);return levelOfQuestion;}},_goToQuestion:function(evt,args){var data=args[0].data,guideID=data.guideID,questionID=data.questionID,startingLevel=(data.level||0)+1,i,response,j;if(this._guide[guideID]&&this._guide[guideID].questions[0]&&(guideID===this._currentGuideID||!this._guide[guideID].parentGuide)){this._currentGuideID=guideID;var nodeList=this._getPathToQuestion([this._guide[guideID].questions[0]],questionID);if(nodeList&&nodeList.length){if(nodeList.length===1){this._removeElements(nodeList[0].questionID);if(this.data.attrs.single_question_display){this._toggleQuestion(nodeList[0],true);this._toggleBackButton(false);}}
else{for(i=0;i<=nodeList.length-2;i++){for(j in nodeList[i].responses){if(nodeList[i].responses.hasOwnProperty(j)){response=nodeList[i].responses[j];if(response.childQuestionID===nodeList[i+1].questionID){this._answerQuestion(guideID,nodeList[i],response,i+startingLevel);}}}}}
return nodeList.length;}}
else{var parentGuide;for(i in this._guide){if(this._guide.hasOwnProperty(i)){response=this._getGuideParentResponse(this._guide[i].questions,guideID);if(response){return{guideID:this._guide[i].guideID,questionID:response.questionID,responseID:response.responseID};}}}}},_answerQuestion:function(guideID,question,response,level){var element;if(question.type===this.data.js.types.MENU_QUESTION||question.type===this.data.js.types.LIST_QUESTION){var parent=this.Y.one(this.baseSelector+"_Response"+guideID+"_"+question.questionID);element=(parent)?parent.one('select'):null;if(element){element.get("options").some(function(option,i){if(option.get("value")===(response.responseID+"")){element.set("selectedIndex",i);return true;}});}}
else{this.Y.one(this.baseSelector+"_Response"+guideID+"_"+response.parentQuestionID).all("input, button").some(function(node){if(node.getAttribute("data-response")===(response.responseID+"")){element=node;return true;}});if(element&&question.type===this.data.js.types.TEXT_QUESTION){element.set("value",RightNow.Interface.getMessage("RESPONSE_PLACEHOLDER_LBL"));}}
this.answerQuestion(element,guideID,response.parentQuestionID,response.responseID,level,true);},_buildNextResult:function(response){var result=this.Y.Node.create("<div class='rn_Result rn_Node'></div>"),deadEnd=true,question;if(!response||!response.type){result.set("innerHTML","<div class='rn_ResultText'>"+RightNow.Interface.getMessage("NO_ANSWERS_FOUND_MSG")+"</div>");}
else{this._currentResponse=response.responseID;if(response.url){RightNow.ActionCapture.record('guidedAssistance','finish',this._currentGuideID);RightNow.ActionCapture.flush();if(response.urlType===this.data.js.types.URL_GET&&this.env.samePage()&&this.data.attrs.call_url_new_window){RightNow.Ajax.CT.commitActions();this._callUrl(response);}
else{RightNow.Ajax.CT.commitActions(function(){this._callUrl(response);},this);}
if(this.env.preview){this._callUrl(response);}
if(!this.env.console||this.env.previewEnduser){return;}}
if(response.type&this.data.js.types.TEXT_RESPONSE){RightNow.ActionCapture.record('guidedAssistance','finish',this._currentGuideID);result.append(this._createTextResultHTML(response)+
this._createResolutionChatLink(this._currentGuideID,response.parentQuestionID,response.responseID)).addClass("rn_Text").set("id",this.baseDomID+"_Result"+this._currentGuideID+"_"+response.responseID);}
if(response.type&this.data.js.types.ANSWER_RESPONSE&&(!this.env.console||this.env.previewEnduser)){RightNow.ActionCapture.record('guidedAssistance','finish',this._currentGuideID);result.append(this._createAnswersHTML(response)).addClass("rn_Answers").set("id",this.baseDomID+"_Result"+this._currentGuideID+"_"+response.responseID);}
if(response.type&this.data.js.types.QUESTION_RESPONSE){question=this._getQuestionByID(response.childQuestionID);result.append(this._buildQuestionHTML(question)+
this._createQuestionChatLink(this._currentGuideID,response.childQuestionID)).addClass("rn_Question").set("id",this.baseDomID+"_Question"+this._currentGuideID+"_"+response.childQuestionID);this._currentQuestion=response.childQuestionID;this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,q_id:this._currentQuestion},true);deadEnd=false;}
if(response.type&this.data.js.types.GUIDE_RESPONSE&&response.childGuideID){if(result.get("innerHTML")){this._appendElement(result.removeClass("rn_Node"));}
RightNow.Ajax.CT.commitActions();this._getGuideByID(response.childGuideID,response.responseID,this._currentQuestion);return;}
this._saveState({guideID:this._currentGuideID,questionID:response.parentQuestionID,responseID:response.responseID,guideSession:this._guide[this._currentGuideID].guideSessionID,sessionID:this.data.js.session});}
RightNow.Ajax.CT.commitActions();this._appendElement(result);RightNow.Url.transformLinks(result);if(this.data.attrs.single_question_display&&deadEnd&&this._currentLevel>2){this._displayRestartButton();}
if(question){RightNow.Event.fire('evt_GuideQuestionRendered',new RightNow.Event.EventObject(this,{data:{question:question,guideID:this._currentGuideID}}));}
this._newContentAdded();},_buildQuestionHTML:function(question){var types=this.data.js.types,newQuestion,result,resultClass;switch(question.type){case types.BUTTON_QUESTION:result=this._createButtonHTML(question);resultClass="rn_ButtonQuestion";break;case types.MENU_QUESTION:case types.LIST_QUESTION:result=this._createMenuHTML(question);resultClass=(question.type===types.LIST_QUESTION)?"rn_ListQuestion":"rn_MenuQuestion";break;case types.LINK_QUESTION:result=this._createLinkHTML(question);resultClass="rn_LinkQuestion";break;case types.RADIO_QUESTION:result=this._createRadioHTML(question);resultClass="rn_RadioQuestion";break;case types.IMAGE_QUESTION:result=this._createImageHTML(question);resultClass="rn_ImageQuestion";break;case types.TEXT_QUESTION:result=this._createTextInputHTML(question);resultClass="rn_TextQuestion";break;}
return new EJS({text:this.getStatic().templates.question}).render({responseContent:result,responseClass:resultClass,questionText:question.text,responseID:this.baseDomID+"_Response"+this._currentGuideID+"_"+question.questionID})+
((this.env.console&&!this.env.previewEnduser&&question.agentText)?"<pre class='rn_AgentText'><em>"+RightNow.Interface.getMessage("AGT_TEXT_LBL")+"</em>"+question.agentText+"</pre>":"");},_createButtonHTML:function(question){return new EJS({text:this.getStatic().templates.buttonResponse}).render({guideID:this._currentGuideID,questionID:question.questionID,responses:question.responses,level:this._currentLevel});},_createMenuHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.menuResponse}).render({guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,size:(question.type===this.data.js.types.LIST_QUESTION)?(question.responses.length+1):0,level:this._currentLevel});},_createLinkHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.linkResponse}).render({id:this._buildResponseID(questionID),guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,className:(this.env.mobile)?"rn_TransparentScreenReaderOnly":"rn_ScreenReaderOnly",level:this._currentLevel});},_createRadioHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.radioResponse}).render({id:this._buildResponseID(questionID),guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,level:this._currentLevel});},_createImageHTML:function(question){var questionID=question.questionID;return new EJS({text:this.getStatic().templates.imageResponse}).render({id:this._buildResponseID(questionID),guideID:this._currentGuideID,questionID:questionID,accessibleText:question.taglessText,responses:question.responses,level:this._currentLevel});},_createTextInputHTML:function(question){this.Y.augment(this,RightNow.RequiredLabel);var response=question.responses[0],questionID=question.questionID;return new EJS({text:this.getStatic().templates.textResponse}).render({id:this._buildResponseID(questionID,response.responseID),guideID:this._currentGuideID,questionID:questionID,responseID:response.responseID,responseText:response.text,label:this.data.attrs.label_text_response_button,level:this._currentLevel});},_callUrl:function(response){this._map.session=this.data.js.session;if(response.urlType===this.data.js.types.URL_GET){this._navigate(response.url,this._map);}
else if(response.urlType===this.data.js.types.URL_POST){this._post(response.url,this._map);}},_navigate:function(url,paramMap,win){win||(win=window);var params="",separator=(url.indexOf("?")>-1)?"&":"?";this.Y.Object.each(paramMap,function(pair,key){params+=(separator+encodeURIComponent(key)+"="+encodeURIComponent(pair.value||pair));if(separator==="?")
separator="&";});url+=params;if(!this.env.samePage()&&(!this.Y.UA.ie||this.Y.UA.ie>10)){win.self.opener.location=url;win.close();}
else if((this.env.console&&!this.env.previewEnduser)||this.data.attrs.call_url_new_window){win.open(url);}
else{win.location=url;}},_post:function(url,paramMap,win){win||(win=window);var form=this.Y.Node.create("<form class='rn_Hidden' method='post'></form>").set("action",url);if(this.env.console&&!this.env.previewEnduser){form.set("target","_blank");}
this.Y.Object.each(paramMap,function(pair,name){form.append(this.Y.Node.create("<input type='text'>").set("name",name).set("value",pair.value||pair));},this);if(!this.env.samePage()&&!this.Y.UA.ie&&!this.env.mobile){form=this.Y.Node.getDOMNode(form);form=win.self.opener.document.body.appendChild(form);win.close();}
else{this._appendElement(form,this._currentGuideID);}
form.submit();},_createTextResultHTML:function(response){return new EJS({text:this.getStatic().templates.textResult}).render({heading:this.data.attrs.label_text_result,resultText:response.responseText||""});},_createAnswersHTML:function(response){var answers="";if(response.childAnswers){answers=new EJS({text:this.getStatic().templates.answerResult}).render({answers:response.childAnswers,guideID:this._currentGuideID,questionID:this._currentQuestion,responseID:response.responseID,target:this.data.attrs.target||((this.env.samePage()||this.env.mobile)?"_blank":"")||"_blank",heading:this.data.attrs.label_answer_result});}
return answers;},_createNewGuide:function(guide,parentGuideID){var question=guide.questions[0],questionID=question.questionID,result=this.Y.Node.create("<div class='rn_Guide rn_Result'></div>").set("id",this.baseDomID+"_Guide"+this._currentGuideID).append(this.Y.Node.create("<div class='rn_Question rn_Node'></div>").set("id",this.baseDomID+"_Question"+guide.guideID+"_"+questionID).append(this._buildQuestionHTML(question)+
this._createQuestionChatLink(this._currentGuideID,questionID)));this._currentQuestion=questionID;this._appendElement(result,parentGuideID);RightNow.Url.transformLinks(result);if(this.data.attrs.single_question_display){this._guideAppended=true;}
RightNow.Event.fire('evt_GuideQuestionRendered',new RightNow.Event.EventObject(this,{data:{question:question,guideID:this._currentGuideID}}));},_createQuestionChatLink:function(guideID,questionID){return(this.data.js.isChatAgent)?"<a class='rn_ChatLink' href='javascript:void(0);' data-guide='"+guideID+"' data-question='"+questionID+"'>"+
RightNow.Interface.getMessage("ADD_TO_CHAT_CMD")+"</a>":"";},_createResolutionChatLink:function(guideID,questionID,responseID){return(this.data.js.isChatAgent)?"<a class='rn_ChatLink' href='javascript:void(0);' data-guide='"+guideID+"' data-question='"+questionID+"' data-response='"+responseID+"'>"+
RightNow.Interface.getMessage("ADD_TO_CHAT_CMD")+"</a>":"";},_displayRestartButton:function(){if(this._restartButton){RightNow.UI.show(this._restartButton);}
else{this._restartButton=this.Y.Node.create("<button class='rn_RestartButton'></button>").set("id",this.baseDomID+"_RestartButton").set("innerHTML",this.data.attrs.label_start_over);this._restartButton.on("click",function(){this._setAriaLoading(true);while(this._currentLevel!==1){this._goBack();}
this._setAriaLoading(false);this._focusTopOfGuide();},this);this.Y.one(this.baseSelector+"_BackButton").insert(this._restartButton,'after');}},_removeElements:function(questionID){var question=this._get("Question",questionID),next=(question)?question.next():null;while(next){next.remove();next=question.next();}},_appendElement:function(element,parentGuideID){var guide=this.Y.one(this.baseSelector+"_Guide"+(parentGuideID||this._currentGuideID));if(guide){guide.appendChild(element).scrollIntoView();window.scrollTo(this.Y.DOM.docScrollX()-20,this.Y.DOM.docScrollY());}},_newContentAdded:function(){if(this.data.attrs.single_question_display){this._focusTopOfGuide();}
else if(this._liveNotificationArea){this._liveNotificationArea.set("innerHTML",RightNow.Interface.getMessage("NEW_CONTENT_ADDED_BELOW_MSG"));}},_focusTopOfGuide:function(){var anchor=this.Y.one(this.baseSelector+"_SamePageAnchor");if(anchor){anchor.setAttribute("tabindex",-1);try{anchor.focus();}
catch(ex){}}
RightNow.UI.updateVirtualBuffer();this._liveNotificationArea.set("innerHTML",RightNow.Interface.getMessage("TOP_CONTENT_CONTENT_ADDED_MSG"));this._setAriaLoading(false);},_getEnvironment:function(){return{mobile:this.data.js.mobile,console:(typeof this.data.js.agentMode!=="undefined"),agent:(this.data.js.agentMode==="agent"),preview:(this.data.js.agentMode&&this.data.js.agentMode.toLowerCase().indexOf("preview")>-1),previewEnduser:(this.data.js.agentMode&&this.data.js.agentMode==="enduserPreview"),samePage:function(win){win||(win=window);if(this._samePageCachedResult){return this._samePageCachedResult;}
try{this._samePageCachedResult=!win.opener||win.opener===win.self||(win.opener.RightNow&&win.opener.RightNow.Chat)||(win.opener.RightNow&&win.opener.RightNow.Widgets.SmartAssistantDialog)||(win.opener.location.href.search(/admin\/live\/agent.php/i)!==-1);}
catch(e){this._samePageCachedResult=true;}
return this._samePageCachedResult;}};},_goBackHelper:function(){this._setAriaLoading(true);this._goBack();this._focusTopOfGuide();this._setAriaLoading(false);},_goBack:function(){this._currentLevel--;var prevQuestionID=this._previousQuestions[this._currentLevel],prevSibling;if(this._toggleQuestion(prevQuestionID,true)){this._removeElements(prevQuestionID);if(prevQuestionID===1&&this._guide[this._currentGuideID].parentGuide){prevSibling=this._get("Guide").previous();if(prevSibling&&prevSibling.get("id").indexOf("Result")>-1){RightNow.UI.show(prevSibling);}
this._guideAppended=true;}}
else{this._currentGuideID=this._guide[this._currentGuideID].parentGuide;this._toggleQuestion(prevQuestionID,true);this._removeElements(prevQuestionID);}
RightNow.UI.hide(this._restartButton);if(this._currentLevel===1){this._toggleBackButton();}},_addPairs:function(question,responseValue,level){for(var name in question.nameValuePairs){if(question.nameValuePairs.hasOwnProperty(name)){this._map[name]={value:question.nameValuePairs[name],level:level};}}
if(question.name){if(typeof responseValue!=="undefined"){this._map[question.name]={value:responseValue,level:level};}
else if(this._map[question.name]&&this._map[question.name].level===level){delete this._map[question.name];}}},_removePairs:function(){for(var i in this._map){if(this._map.hasOwnProperty(i)&&this._map[i].level>=this._currentLevel){delete this._map[i];}}},_getQuestionByID:function(domNodeID){if(this._guide&&this._guide[this._currentGuideID]&&this._guide[this._currentGuideID].questions){var questions=this._guide[this._currentGuideID].questions;for(var question in questions){if(questions[question].questionID===domNodeID)
return questions[question];}}},_getResponseByID:function(question,responseID){if(question&&question.responses){for(var response in question.responses){if(question.responses[response].responseID===responseID)
return question.responses[response];}}},_getPathToQuestion:function(nodes,questionID){var node,i,found,child;if(nodes.length){node=nodes.shift();if(node.questionID===questionID)return[node];for(i in node.responses){if(node.responses.hasOwnProperty(i)&&node.responses[i].childQuestionID){child=this._getQuestionByID(node.responses[i].childQuestionID);child.parent=node.questionID;nodes.push(child);}}
found=this._getPathToQuestion(nodes,questionID);if(found){return(found[0].parent===node.questionID)?[node].concat(found):found;}}},_getGuideParentResponse:function(questions,guideID){var i,quesLen,j,respLen;for(i=0,quesLen=questions.length;i<quesLen;i++){for(j=0,respLen=questions[i].responses.length;j<respLen;j++){if(questions[i].responses[j].childGuideID===guideID){return{responseID:questions[i].responses[j].responseID,questionID:questions[i].questionID};}}}},_get:function(type,id){var suffix=id?("_"+id):"";return this.Y.one(this.baseSelector+"_"+type+this._currentGuideID+suffix);},_submitStats:function(action,details,queue,callback,scope){if(!this.env.preview&&!this._restoringState&&!this.data.js.isSpider){if(queue){RightNow.Ajax.CT.addAction(action,details);}
else{RightNow.Ajax.CT.submitAction(action,details,callback,scope);}}},_answerViewed:function(evt,args){var data=args[0].data;this._recordAnswerViewed(data.guideID,data.questionID,data.responseID,data.answerID);},_linkClicked:function(evt,ids){var link=evt.target,callback;if(link.hasClass("rn_ChatLink")){if(ids.responseID){this._addResolutionToChat(ids.guideID,ids.questionID,ids.responseID);}
else{this._addQuestionToChat(ids.guideID,ids.questionID);}}
else{if(!link.getAttribute("target")||link.getAttribute("target")==="_self"){evt.halt();callback=function(){RightNow.Url.navigate(link.get("href"));};}
else if(!this.env.samePage()){try{window.self.opener.location=link.get("href");window.self.opener.focus();evt.halt();}
catch(e){}}
this._recordAnswerViewed(ids.guideID,ids.questionID,ids.responseID,ids.answerID,callback);}},_addQuestionToChat:function(guideID,questionID){this._eo.data={guideID:guideID,questionID:questionID};RightNow.Event.fire("evt_GuideAddQuestionToChat",this._eo);},_addResolutionToChat:function(guideID,questionID,responseID){this._eo.data={guideID:guideID,questionID:questionID,responseID:responseID};RightNow.Event.fire("evt_GuideAddResolutionToChat",this._eo);},_recordAnswerViewed:function(guideID,questionID,responseID,answerID,callback){RightNow.ActionCapture.record('guidedAssistanceAnswer','view',guideID);if(callback){RightNow.ActionCapture.flush();}
this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[guideID].guideSessionID,ga_id:guideID,q_id:questionID,r_id:responseID,a_id:answerID},false,callback);},_buildResponseID:function(questionID,responseID){return this.baseDomID+'_Response'+this._currentGuideID+'_'+questionID+'_'+(responseID||'');},_highlightResponse:function(chosenResponse,questionType){var cssClass="rn_HighlightResponse";if(questionType===this.data.js.types.LINK_QUESTION){chosenResponse.get("parentNode").get("parentNode").all("label").removeClass(cssClass);chosenResponse.get("parentNode").all("label").addClass(cssClass);}
else{cssClass+=(this.env.console)?"":" rn_SelectedButton";chosenResponse.get("parentNode").all("button").removeClass(cssClass);chosenResponse.addClass(cssClass);}},_toggleBackButton:function(show){this.Y.one(this.baseSelector+"_BackButton")[((show)?"removeClass":"addClass")]("rn_Hidden");},_toggleQuestion:function(question,show){if(!question)return false;if(typeof question==="number"){var previousQuestion=this._guide[this._currentGuideID].questions[question-1],numberOfPreviousResponses=previousQuestion?previousQuestion.responses.length:0;if(numberOfPreviousResponses>0&&previousQuestion.type===this.data.js.types.TEXT_QUESTION){for(var i=0,input;i<numberOfPreviousResponses;i++){input=this.Y.one(this.baseSelector+"_Response"+this._originalGuideID+"_"+question+"_"+previousQuestion.responses[i].responseID);if(input){input.set("value","");}}}}
var element=this._get("Question",((typeof question==="number")?question:question.questionID)),elementIsHidden;if(element){elementIsHidden=element.hasClass('rn_Hidden');if((show&&!elementIsHidden)||(!show&&elementIsHidden))return false;element[((show)?"removeClass":"addClass")]("rn_Hidden");return true;}
return false;},_hideFirstGuideQuestion:function(questionID){this._get("Question",questionID).addClass("rn_Hidden");this._get("Guide").previous('*').addClass("rn_Hidden");},_setAriaLoading:function(loadingOrNot){this._outerGuideDiv=this._outerGuideDiv||this.Y.one(this.baseSelector);this._outerGuideDiv.setAttribute("aria-busy",((loadingOrNot)?"true":"false"));},_getGuideByID:function(guideID,responseID,questionID){if(this._guide[guideID]){var parentGuideID=this._currentGuideID;this._currentGuideID=guideID;this._createNewGuide(this._guide[guideID],parentGuideID);this._currentGuideID=parentGuideID;}
else if(!this._retrievingNewGuide){this._retrievingNewGuide=true;if(this._restoringState){this._restoringNewGuideState=true;}
var eo=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,guideID:guideID,responseID:responseID,questionID:questionID,langID:this.data.js.langID,f_tok:this.data.js.f_tok}});if(RightNow.Event.fire("evt_GuidedAssistanceRequest",eo)){RightNow.Ajax.makeRequest(this.data.attrs.guide_request_ajax,eo.data,{successHandler:this._getGuideResponse,scope:this,json:true,data:eo});}}},_getGuideResponse:function(response,origEventObject){if(RightNow.Event.fire("evt_GuidedAssistanceResponse",{response:response,data:origEventObject})){var newGuide=response,prevGuideID=this._currentGuideID;newGuide.parentGuide=prevGuideID;this._currentGuideID=newGuide.guideID;this._guide[this._currentGuideID]=newGuide;if(!this._restoringNewGuideState){this._submitStats(RightNow.Ajax.CT.GA_SESSIONS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,sid:this.data.js.session,acct_id:parseInt(this.data.js.accountID,10),channel:this.data.js.channel},true);}
this._createNewGuide(newGuide,prevGuideID);if(!this._restoringNewGuideState){this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,q_id:this._currentQuestion});}
else{this._restoringNewGuideState=false;}
this._retrievingNewGuide=false;if(this._guideLoadedCallback){this._guideLoadedCallback.call(this,this._currentGuideID);}
this._newContentAdded();}},_initHistoryManager:function(){if(this._history)return;var recordGuideSessionStart=function(){this._submitStats(RightNow.Ajax.CT.GA_SESSIONS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,sid:this.data.js.session,acct_id:parseInt(this.data.js.accountID,10),channel:this.data.js.channel},true);this._submitStats(RightNow.Ajax.CT.GA_SESSION_DETAILS,{ga_sid:this._guide[this._currentGuideID].guideSessionID,ga_id:this._currentGuideID,q_id:this._currentQuestion});RightNow.ActionCapture.record('guidedAssistance','load',this._currentGuideID);};if(top===self&&!this.env.console){this._stateKey="gs";this._history=new this.Y.History();this._history.on("change",function(e){var src=e.src,currentState;if(src!==this.Y.HistoryHash.SRC_HASH&&src!==this.Y.HistoryHTML5.SRC_POPSTATE){return;}
currentState=e.newVal[this._stateKey]||"";if(!this._restoreState(currentState)){recordGuideSessionStart.call(this);}},this,true);var initialState;if(this.Y.HistoryBase.html5){initialState=window.location.toString().match(new RegExp("(#"+this._stateKey+"=)([A-Za-z0-9_/.]+)"));if(initialState&&initialState[2]){initialState=initialState[2];}
else{initialState=null;}}
else{initialState=this._history.get(this._stateKey);}
if(initialState&&this._restoreState(initialState)){return;}}
recordGuideSessionStart.call(this);},_restoreState:function(state){if(state){try{state=RightNow.JSON.parse(RightNow.Text.Encoding.base64Decode(state));if(state.sessionID!==this.data.js.session){return false;}
if((this._currentGuideID!==state.guideID||this._currentResponse!==state.responseID||this._previousQuestions[this._currentLevel-1]!==state.questionID)){this._restoringState=true;this._guide[this._currentGuideID].guideSessionID=state.guideSession;this._goToResponse(this.instanceID,[{data:{guideID:state.guideID,questionID:state.questionID,responseID:state.responseID}}]);this._restoringState=false;}}
catch(e){}}
else if(this._currentLevel>1){this._currentResponse=null;this._goToQuestion(this.instanceID,[{data:{guideID:this._originalGuideID,questionID:this._guide[this._originalGuideID].questions[0].questionID}}]);}
return true;},_saveState:function(state){if(this._history&&!this._restoringState){var savedOffState=RightNow.Text.Encoding.base64Encode(RightNow.JSON.stringify(state)),hash="#"+this._stateKey+"="+savedOffState,saveThis={};saveThis[this._stateKey]=savedOffState;this._history.add(saveThis,{url:((window.location.hash)?window.location.toString().replace(window.location.hash,hash):window.location+hash)});}}});
RightNow.Widgets.SocialBookmarkLink=RightNow.Widgets.extend({constructor:function(){this.Y.Event.attach("click",this._onClick,this.baseSelector+"_Link",this);this.Y.Event.attach("click",this._togglePanel,this.baseSelector+"_Panel li a",this);RightNow.Event.subscribe('evt_inlineModerationStatusUpdate',this._onStatusUpdate,this);},_onClick:function(event){event.halt();if(this.data.attrs.object_type==='answer'){this._togglePanel();return;}
var eventObject=new RightNow.Event.EventObject(this,{data:{qid:RightNow.Url.getParameter('qid'),}});RightNow.Ajax.makeRequest(this.data.attrs.check_question_exist_ajax,eventObject.data,{data:eventObject,json:true,scope:this,successHandler:this._onResponseReceived});},_onResponseReceived:function(response){if(response.errors){if(!RightNow.Ajax.indicatesSocialUserError(response)){var dialogParameters={exitCallback:{fn:function(){messageDialog.hide();},scope:this}},messageDialog;dialogParameters.icon='WARN';messageDialog=RightNow.UI.Dialog.messageDialog(response.errors[0].externalMessage,dialogParameters).show();}}
else{this._togglePanel();}},_createPanel:function(panelElement){var widget=this.Y.one(this.baseSelector);RightNow.UI.show(panelElement);var panel=new this.Y.Panel({srcNode:panelElement,align:{node:widget,points:[this.Y.WidgetPositionAlign.TC,this.Y.WidgetPositionAlign.BC]},render:widget,visible:false,zIndex:10,buttons:[],alignOn:[{node:'win',eventName:'resize'}],hideOn:[{eventName:"clickoutside"},{node:panelElement.all("a").slice(-1).item(0),eventName:"keydown",keyCode:RightNow.UI.KeyMap.TAB}]});panel.after('visibleChange',function(e){if(e.newVal){this._focusFirstLink();}},this);return panel;},_focusFirstLink:function(){this._panel.get('contentBox').one('a').focus();},_onStatusUpdate:function(evt,args){if(args[0].data.object_data.updatedObject.objectType==='CommunityQuestion'&&args[0].data.object_data.updatedObject.ID===parseInt(this.data.js.objectID,10)){if(parseInt(args[0].data.object_data.updatedObject.statusWithTypeID,10)!==this.data.js.activeStatusWithTypeID){RightNow.UI.hide(this.baseSelector);}
else{RightNow.UI.show(this.baseSelector);}}},_togglePanel:function(){var panelElement=this.Y.one(this.baseSelector+"_Panel");if(!panelElement){return false;}
this._panel=this._panel||this._createPanel(panelElement);if(this._panel.get("visible")){this._panel.hide();}
else{this._panel.show();}}});
RightNow.Widgets.EmailAnswerLink=RightNow.Widgets.extend({constructor:function(){this._dialogElement=this.Y.one(this.baseSelector+'_EmailAnswerLinkForm');if(this._dialogElement)
{this.Y.Event.attach("click",this._onEmailLinkClick,this.baseSelector+"_Link",this);}
RightNow.Event.subscribe('evt_inlineModerationStatusUpdate',this._onStatusUpdate,this);},_onEmailLinkClick:function(e)
{if(this.data.attrs.object_type==="question"&&!RightNow.Profile.isSocialUser())
{this.requestAuthentication(e);}
else
{if(!this._dialog)
{var buttons=[{text:this.data.attrs.label_send_button,handler:{fn:this._submitClicked,scope:this},isDefault:true},{text:this.data.attrs.label_cancel_button,handler:{fn:this._closeDialog,scope:this},isDefault:false}];this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,this._dialogElement,{"buttons":buttons});this._dialogElement.removeClass("rn_Hidden").addClass("rn_EmailLinkDialog");this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._submitClicked,this);}
this._recipientEmailElement=this._recipientEmailElement||this.Y.one(this.baseSelector+"_InputRecipientEmail");this._senderEmailElement=this._senderEmailElement||this.Y.one(this.baseSelector+"_InputSenderEmail");this._senderNameElement=this._senderNameElement||this.Y.one(this.baseSelector+"_InputSenderName");this._errorDisplay=this._errorDisplay||this.Y.one(this.baseSelector+"_ErrorMessage");if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
this._dialog.show();RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener,this._recipientEmailElement);}},requestAuthentication:function(e){if(!RightNow.Profile.isLoggedIn()){RightNow.Event.fire('evt_requireLogin',new RightNow.Event.EventObject(this,{data:{isSocialAction:true,title:RightNow.Interface.getMessage("PLEASE_LOG_CREATE_AN_ACCOUNT_CONTINUE_LBL")}}));}
else{RightNow.Event.fire("evt_userInfoRequired");}
e.halt();},_closeDialog:function()
{if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._dialog.hide();},_shouldIgnoreEvent:function(name,event){if(name==="keyPressed"){var target=(event&&event[1])?(event[1].target||event[1].srcElement):null,targetContents=target?target.getHTML():null;return(!target||target.get('tagName')==='A'||targetContents===this.data.attrs.label_send_button||targetContents===this.data.attrs.label_cancel_button);}
return false;},_submitClicked:function(type,args)
{if(this._shouldIgnoreEvent(type,args))return;RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);if(this._validateFormData())
{this._submitRequest();}
else
{RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);}},_validateFormData:function()
{if(this._errorDisplay)
{this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
var toEmailIsValid=this._validateEmailAddress(this._recipientEmailElement,this.data.attrs.label_to),fromEmailIsValid=!this._senderEmailElement||this._validateEmailAddress(this._senderEmailElement,this.data.attrs.label_sender_email),senderNameIsValid=!this._senderNameElement||this._validateSenderName(this._senderNameElement,this.data.attrs.label_sender_name);return toEmailIsValid&&fromEmailIsValid&&senderNameIsValid;},_validateSenderName:function(senderInput,label){var nameValue=this.Y.Lang.trim(senderInput.get("value")),id=senderInput.get("id"),errors=[];if(nameValue===""){errors.push(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"));}
else{if(nameValue.indexOf("<")>-1||nameValue.indexOf(">")>-1){errors.push(RightNow.Interface.getMessage("PCT_S_CONTAIN_THAN_MSG"));}
if(nameValue.indexOf("'")>-1||nameValue.indexOf('"')>-1){errors.push(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_QUOTES_MSG"));}
if(nameValue.indexOf("&")>-1){errors.push(RightNow.Interface.getMessage("PCT_S_MUST_NOT_CONTAIN_MSG"));}}
this.Y.Array.each(errors,function(message){this._addErrorMessage(RightNow.Text.sprintf(message,label),id);},this);return!errors.length;},_validateEmailAddress:function(emailField,label)
{if(emailField)
{var emailFieldValue=this.Y.Lang.trim(emailField.get("value")),id=emailField.get("id");if(emailFieldValue==="")
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),label),id);return false;}
if(emailFieldValue.indexOf(";")>=0||emailFieldValue.indexOf(",")>=0||emailFieldValue.indexOf(" ")>=0)
{this._addErrorMessage(RightNow.Interface.getMessage("PLEASE_ENTER_SINGLE_EMAIL_ADDRESS_MSG"),id);return false;}
if(!RightNow.Text.isValidEmailAddress(emailFieldValue))
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_INVALID_MSG"),label),id);return false;}
if(emailFieldValue.length>80)
{this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_TOO_LONG_MSG"),label),id);return false;}
return true;}
return false;},_submitRequest:function()
{var eventObject,requestURL;if(this.data.attrs.object_type==="question"){eventObject=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,to:this._recipientEmailElement.get("value"),qid:this.data.js.objectID}});requestURL=this.data.attrs.send_discussion_email_ajax;}
else{var name=((this._senderNameElement)?this._senderNameElement.get("value"):"")||this.data.js.senderName;eventObject=new RightNow.Event.EventObject(this,{data:{w_id:this.data.info.w_id,to:this._recipientEmailElement.get("value"),a_id:this.data.js.objectID,emailAnswerToken:this.data.js.emailAnswerToken,from:((this._senderEmailElement)?this._senderEmailElement.get("value"):"")||this.data.js.senderEmail,name:name.substring(0,80)}});requestURL=this.data.attrs.send_email_ajax;}
if(RightNow.Event.fire("evt_emailLinkRequest",eventObject)){RightNow.Ajax.makeRequest(requestURL,eventObject.data,{successHandler:this._onResponseReceived,scope:this,data:eventObject,json:true});}},_onResponseReceived:function(response,originalEventObj)
{if(RightNow.Event.fire("evt_emailLinkSubmitResponse",{data:originalEventObj,response:response})){if(response.ajaxError){this._closeDialog();}
else{var dialogParameters={exitCallback:{fn:function(){messageDialog.hide();this._closeDialog();},scope:this}},messageDialog,message;if(typeof response==="string"){message=response;}
else if(response.errors){if(!RightNow.Ajax.indicatesSocialUserError(response)){message=response.errors[0].externalMessage||response.suggestedErrorMessage||RightNow.Interface.getMessage("THERE_PROB_REQ_ACTION_COULD_COMPLETED_MSG");dialogParameters.icon='WARN';}}
else{message=this.data.attrs.label_email_sent;}
messageDialog=RightNow.UI.Dialog.messageDialog(message,dialogParameters);}}},_addErrorMessage:function(message,focusElement){if(this._errorDisplay){this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage');var newMessage='<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>';var oldMessage=this._errorDisplay.get("innerHTML");if(oldMessage!=="")
newMessage=oldMessage+'<br/>'+newMessage;this._errorDisplay.set("innerHTML",newMessage);this._errorDisplay.one('a').focus();this._errorDisplay.one("h2")?this._errorDisplay.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):this._errorDisplay.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorDisplay.one("h2").setAttribute('role','alert');}},_onStatusUpdate:function(evt,args){if(args[0].data.object_data.updatedObject.objectType==='CommunityQuestion'){if(parseInt(args[0].data.object_data.updatedObject.statusWithTypeID,10)!==this.data.js.activeStatusWithTypeID){RightNow.UI.hide(this.baseSelector);}
else{RightNow.UI.show(this.baseSelector);}}}});
RightNow.Widgets.AnswerNotificationIcon=RightNow.Widgets.extend({constructor:function()
{if(this.data.js.pta)
return false;if(!RightNow.Interface.getConfig("ANS_NOTIF_ENABLED"))
return false;this._submitting=false;if(RightNow.Profile.isLoggedIn())
this.Y.one(this.baseSelector+'_Trigger').on('click',this._onTriggerClick,this,null);if(this.data.js.autoOpen==1)
this._onTriggerClick();RightNow.Widgets.formTokenRegistration(this);},_onTriggerClick:function(type,args)
{if(!this._submitting)
{this._submitting=true;this._createNotification();}
return false;},_createNotification:function()
{var eventObject=new RightNow.Event.EventObject(this,{data:{filter_type:'answer',id:this.data.js.answerID,cid:this.data.js.contactID,f_tok:this.data.js.f_tok}});if(RightNow.Event.fire('evt_answerNotificationUpdateRequest',eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.add_or_renew_notification_ajax,eventObject.data,{successHandler:this._onNotificationResponse,scope:this,data:eventObject,json:true});}},_onNotificationResponse:function(response,originalEventObj)
{var triggerLink=this.Y.one(this.baseSelector+'_Trigger');if(RightNow.Event.fire('evt_answerNotificationResponse',{data:originalEventObj,response:response})){if(response.error){RightNow.UI.displayBanner(this.data.attrs.label_error,{type:'ERROR',focusElement:triggerLink});}
else{RightNow.UI.displayBanner(response.action==='renew'?this.data.attrs.label_renewed:this.data.attrs.label_subscribed,{focusElement:triggerLink});}
this._submitting=false;return false;}}});
RightNow.Widgets.AnswerFeedback=RightNow.Widgets.extend({constructor:function(){this._dialog=this._keyListener=this._thanksLabel=null;this._rate=0;var Event=this.Y.Event;if(this.data.js.buttonView){var noButton=this.Y.one(this.baseSelector+"_RatingNoButton"),yesButton=this.Y.one(this.baseSelector+"_RatingYesButton");Event.attach("click",this._onClick,noButton,this,1);Event.attach("click",this._onClick,yesButton,this,2);}
else if(this.data.attrs.use_rank_labels){var ratingButton=this.baseSelector+"_RatingButton_";for(var i=1,ids=[];i<=this.data.attrs.options_count;++i){ids.push(ratingButton+i);}
this.Y.Array.each(ids,function(id,i){Event.attach("click",this._onClick,id,this,i+1);},this);}
else{var ratingCell=this.baseSelector+"_RatingCell_";for(i=1,ids=[];i<=this.data.attrs.options_count;++i){ids.push(ratingCell+i);}
this.Y.Array.each(ids,function(id,i){var j=i+1;Event.attach("mouseover",this._onCellOver,id,this,j);Event.attach("focus",this._onCellOver,id,this,j);Event.attach("mouseout",this._onCellOut,id,this,j);Event.attach("blur",this._onCellOut,id,this,j);Event.attach("click",this._onClick,id,this,j);},this);}
RightNow.Event.subscribe("evt_formTokenUpdate",RightNow.Widgets.onFormTokenUpdate,this);},_onClick:function(event,rating){this._rate=rating;this._submitAnswerRating();if(this._rate<=this.data.attrs.dialog_threshold){if(this.data.attrs.feedback_page_url){var pageString=this.data.attrs.feedback_page_url;pageString=RightNow.Url.addParameter(pageString,"a_id",this.data.js.answerID);pageString=RightNow.Url.addParameter(pageString,"session",RightNow.Url.getSession());window.open(pageString,'',"resizable, scrollbars, width=630, height=400");}
else{this._showDialog();}}},_showDialog:function(){RightNow.Event.fire("evt_formTokenRequest",new RightNow.Event.EventObject(this,{data:{formToken:this.data.js.f_tok}}));if(!this._dialog){this.Y.augment(this,RightNow.RequiredLabel);var buttons=[{text:this.data.attrs.label_send_button,handler:{fn:this._onSubmit,scope:this},isDefault:true},{text:this.data.attrs.label_cancel_button,handler:{fn:this._onCancel,scope:this},isDefault:false}],templateData={domPrefix:this.baseDomID,labelDialogDescription:this.data.attrs.label_dialog_description,labelEmailAddress:this.data.attrs.label_email_address,labelCommentBox:this.data.attrs.label_comment_box,isProfile:this.data.js.isProfile,userEmail:this.data.js.email},dialogForm=this.Y.Node.create(new EJS({text:this.getStatic().templates.feedbackForm}).render(templateData));this._dialog=RightNow.UI.Dialog.actionDialog(this.data.attrs.label_dialog_title,dialogForm,{"buttons":buttons,"dialogDescription":this.baseDomID+"_DialogDescription","width":this.data.attrs.dialog_width||''});this._keyListener=RightNow.UI.Dialog.addDialogEnterKeyListener(this._dialog,this._onSubmit,this);RightNow.UI.show(dialogForm);this.Y.one('#'+this._dialog.id).addClass('rn_AnswerFeedbackDialog');}
this._emailField=this._emailField||this.Y.one(this.baseSelector+"_EmailInput");this._errorDisplay=this._errorDisplay||this.Y.one(this.baseSelector+"_ErrorMessage");this._feedbackField=this._feedbackField||this.Y.one(this.baseSelector+"_FeedbackTextarea");if(this._errorDisplay){this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
this._dialog.show();var focusElement;if(this._emailField&&this._emailField.get("value")==='')
focusElement=this._emailField;else
focusElement=this._feedbackField;focusElement.focus();RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);},_onSubmit:function(type,args){var target=(args&&args[1])?(args[1].target||args[1].srcElement):null;if(type==="keyPressed"&&target){var tag=target.get('tagName'),innerHTML=target.get('innerHTML');if(tag==='A'||tag==='TEXTAREA'||innerHTML===this.data.attrs.label_send_button||innerHTML===this.data.attrs.label_cancel_button){return;}}
if(!this._validateDialogData()){return;}
RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._incidentCreateFlag=true;this._submitFeedback();},_onCancel:function(){RightNow.UI.Dialog.disableDialogControls(this._dialog,this._keyListener);this._closeDialog(true);},_validateDialogData:function(){this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');var returnValue=true;if(this._emailField){this._emailField.set("value",this.Y.Lang.trim(this._emailField.get("value")));if(this._emailField.get("value")===""){this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),this.data.attrs.label_email_address),this._emailField.get("id"));returnValue=false;}
else if(!RightNow.Text.isValidEmailAddress(this._emailField.get("value"))){this._addErrorMessage(this.data.attrs.label_email_address+' '+RightNow.Interface.getMessage("FIELD_IS_NOT_A_VALID_EMAIL_ADDRESS_MSG"),this._emailField.get("id"));returnValue=false;}}
this._feedbackField.set("value",this.Y.Lang.trim(this._feedbackField.get("value")));if(this._feedbackField.get("value")===""){this._addErrorMessage(RightNow.Text.sprintf(RightNow.Interface.getMessage("PCT_S_IS_REQUIRED_MSG"),this.data.attrs.label_comment_box),this._feedbackField.get("id"));returnValue=false;}
return returnValue;},_closeDialog:function(cancelled){if(!cancelled){this._feedbackField.set("value","");}
if(this._errorDisplay){this._errorDisplay.set("innerHTML","").removeClass('rn_MessageBox rn_ErrorMessage');}
if(this._dialog){this._dialog.hide();}},_submitFeedback:function(){var eventObject=new RightNow.Event.EventObject(this,{data:{a_id:this.data.js.answerID,rate:this._rate,threshold:this.data.attrs.dialog_threshold,options_count:this.data.attrs.options_count,message:this._feedbackField.get('value'),email:(this._emailField)?this._emailField.get('value'):this.data.js.email,f_tok:this.data.js.f_tok}});if(RightNow.Event.fire("evt_answerFeedbackRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.submit_feedback_ajax,eventObject.data,{successHandler:this._onResponseReceived,scope:this,data:eventObject,json:true});}},_onResponseReceived:function(response,originalEventObj){if(RightNow.Event.fire("evt_answerFeedbackResponse",response,originalEventObj)){if(this._incidentCreateFlag){this._incidentCreateFlag=false;if(response&&response.ID){this._closeDialog();RightNow.UI.displayBanner(this.data.attrs.label_feedback_submitted,{focusElement:this._thanksLabel,baseClass:"rn_ThanksLabel"});}
else{var message=(response&&response.error)?response.error:response;this._addErrorMessage(message,null);RightNow.UI.Dialog.enableDialogControls(this._dialog,this._keyListener);}}
else{this._closeDialog();}}},_submitAnswerRating:function(){var eventObject=new RightNow.Event.EventObject(this,{data:{a_id:this.data.js.answerID,rate:this._rate,options_count:this.data.attrs.options_count}});RightNow.ActionCapture.record('answer','rate',this.data.js.answerID);RightNow.ActionCapture.record('answer','rated',((this._rate-1)/(this.data.attrs.options_count-1))*100);if(RightNow.Event.fire("evt_answerRatingRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.submit_rating_ajax,eventObject.data,{successHandler:this._onRatingResponseReceived,scope:this,data:{eventName:"evt_answerRatingResponse",data:eventObject},json:true});this._replaceRatingElementsWithMessage();}},_replaceRatingElementsWithMessage:function(){var ratingElement=this.Y.one(this.baseSelector+((this.data.js.buttonView||this.data.attrs.use_rank_labels)?"_RatingButtons":"_RatingMeter"));if(ratingElement){this._thanksLabel=this.Y.Node.create('<div id="rn_'+this.instanceID+'_ThanksLabel" class="rn_ThanksLabel">');this._thanksLabel.set('innerHTML',this.data.attrs.label_feedback_thanks).set('tabIndex',-1);ratingElement.replace(this._thanksLabel);this._thanksLabel.focus();}},_onRatingResponseReceived:function(response,originalEventObj){RightNow.Event.fire("evt_answerRatingResponse",response,originalEventObj);},_addErrorMessage:function(message,focusElement){if(this._errorDisplay){this._errorDisplay.addClass('rn_MessageBox rn_ErrorMessage');var newMessage=focusElement?'<a href="javascript:void(0);" onclick="document.getElementById(\''+focusElement+'\').focus(); return false;">'+message+'</a>':message,oldMessage=this._errorDisplay.get("innerHTML");if(oldMessage!==""){newMessage=oldMessage+'<br>'+newMessage;}
this._errorDisplay.set("innerHTML",newMessage);this._errorDisplay.one("h2")?this._errorDisplay.one("h2").setHTML(RightNow.Interface.getMessage("ERRORS_LBL")):this._errorDisplay.prepend("<h2>"+RightNow.Interface.getMessage("ERROR_LBL")+"</h2>");this._errorDisplay.one("h2").setAttribute('role','alert');if(focusElement){this._errorDisplay.one('a').focus();}}},_onCellOver:function(event,chosenRating){if(this._rate<1){this._updateCellClass(1,chosenRating,"add");this._updateCellClass(chosenRating+1,this.data.attrs.options_count,"remove");}},_updateCellClass:function(minBound,maxBound,removeOrAddClass){var elementID=this.baseSelector+"_RatingCell_";for(var i=minBound;i<=maxBound;i++){if(removeOrAddClass==="add"){this.Y.one(elementID+i).addClass('rn_RatingCellOver');}else{this.Y.one(elementID+i).removeClass('rn_RatingCellOver');}}},_onCellOut:function(event,args){if(this._rate<1)
this._updateCellClass(1,this.data.attrs.options_count,"remove");}});
RightNow.Widgets.TextInput=RightNow.Field.extend({overrides:{constructor:function(){if(this.data.js.readOnly)return;this.parent();this._seenValues=[];this.input=this.Y.one(this._inputSelector);if(!this.input)return;if(this.data.attrs.hint&&!this.data.attrs.hide_hint&&!this.data.attrs.always_show_hint){this._initializeHint();}
if(this.data.attrs.initial_focus&&this.input.focus)
this.politeFocus(this.input);if(this.data.js.mask){this._initializeMask();}
if(RightNow.Text.beginsWith(this._fieldName,"Contact.Phones.")||this._fieldName==="Contact.Address.PostalCode"){RightNow.Event.on("evt_provinceResponse",this.onProvinceChange,this);}
if(this.data.attrs.validate_on_blur){this.input.on("blur",this._blurValidate,this);if(this.data.attrs.require_validation){this.Y.Event.attach("blur",this._blurValidate,this._inputSelector+'_Validate',this,true);}}
this.input.on('change',function(){RightNow.Event.fire("evt_formInputDataChanged",null);this.fire('change',this);},this);if(this.data.attrs.require_validation){this.Y.one(this._inputSelector+'_Validate').on('change',function(){this.fire('change',this);},this);}
this._isFormSubmitting=false;this.parentForm().on("submit",this.onValidate,this).on("send",this._toggleFormSubmittingFlag,this).on("response",this._toggleFormSubmittingFlag,this);this._subscribedToFormValidation=true;this.on("constraintChange",this.constraintChange,this);RightNow.Event.on("evt_formValidateFailure",this._onValidateFailure,this);}},swapLabel:function(container,requiredness,label,template){this.Y.augment(this,RightNow.RequiredLabel);var templateObject={label:label,instanceID:this.instanceID,fieldName:this._fieldName,required:requiredness,hint:this.data.attrs.hint};container.setHTML('');container.append(new EJS({text:template}).render(templateObject));},setLabel:function(newLabel){if(newLabel){this.Y.one(this.baseSelector+' label.rn_Label').set('text',newLabel);}},reload:function(content,readOnly){this.data.js.initialValue=content||'';this.data.readOnly=typeof readOnly==='undefined'?this.data.attrs.read_only:readOnly;content=typeof content!=='undefined'?content:'';this._subscribeToFormValidation();this.Y.one('#rn_'+this.instanceID+' textarea.rn_TextArea').set('value',content);},_subscribeToFormValidation:function(){if(this.data.readOnly||this._subscribedToFormValidation)return;this.parentForm().on('submit',this.onValidate,this);this._subscribedToFormValidation=true;},constraintChange:function(evt,constraint){constraint=constraint[0];if(constraint.required===this.data.attrs.required)return;this.toggleErrorIndicator(false);if(this.data.attrs.require_validation){this.toggleErrorIndicator(false,this.Y.one(this._inputSelector+'_Validate'),this.Y.one(this._inputSelector+'_LabelValidate'));}
if(this.data.attrs.required&&this.lastErrorLocation){this.Y.one('#'+this.lastErrorLocation).all("[data-field='"+this._fieldName+"']").remove();}
if(this.data.attrs.label_input){this.swapLabel(this.Y.one(this.baseSelector+'_LabelContainer'),constraint.required,this.data.attrs.label_input,this.getStatic().templates.label);}
if(this.data.attrs.require_validation){var labelValidate=RightNow.Text.sprintf(this.data.attrs.label_validation,this.data.attrs.label_input);this.swapLabel(this.Y.one(this.baseSelector+'_LabelValidateContainer'),constraint.required,labelValidate,this.getStatic().templates.labelValidate);}
this.data.attrs.required=constraint.required;},getVerificationValue:function(){return this._getTextFieldValue(this.Y.one(this._inputSelector+'_Validate'));},onValidate:function(type,args){var eventObject=this.createEventObject(),errors=[];this.toggleErrorIndicator(false);if(!this.validate(errors)||(this.data.attrs.require_validation&&!this._validateVerifyField(errors))||!this._compareInputToMask(true)){this.lastErrorLocation=args[0].data.error_location;this._displayError(errors,this.lastErrorLocation);RightNow.Event.fire("evt_formFieldValidateFailure",eventObject);return false;}
RightNow.Event.fire("evt_formFieldValidatePass",eventObject);this._seenValues.push(this._massageValueForModificationCheck(eventObject.data.value));return eventObject;},_displayError:function(errors,errorLocation){var commonErrorDiv=this.Y.one("#"+errorLocation),verifyField;if(commonErrorDiv){for(var i=0,errorString="",message,id=this.input.get("id");i<errors.length;i++){message=errors[i];if(typeof message==="object"&&message!==null&&message.id&&message.message){id=verifyField=message.id;message=message.message;}
else if(this.data.attrs.name==='CommunityQuestion.Body'||this.data.attrs.name==='CommunityComment.Body'){message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):message;}
else{message=(message.indexOf("%s")>-1)?RightNow.Text.sprintf(message,this.data.attrs.label_input):this.data.attrs.label_input+": "+message;}
errorString+="<div data-field=\""+this._fieldName+"\"><b><a href='javascript:void(0);' onclick='document.getElementById(\""+id+"\").focus(); return false;'>"+message+"</a></b></div> ";}
commonErrorDiv.append(errorString);}
if(!verifyField||errors.length>1){this.toggleErrorIndicator(true);}},toggleErrorIndicator:function(showOrHide,fieldToHighlight,labelToHighlight){var method=((showOrHide)?"addClass":"removeClass");if(fieldToHighlight&&labelToHighlight){fieldToHighlight[method]("rn_ErrorField");labelToHighlight[method]("rn_ErrorLabel");}
else{this.input[method]("rn_ErrorField");this.Y.one(this.baseSelector+"_Label")[method]("rn_ErrorLabel");}},_toggleFormSubmittingFlag:function(event){this._isFormSubmitting=(event==='send');},_blurValidate:function(event,validateVerifyField){if(this._dialogShowing)
return;this._trimField();if(validateVerifyField){this._validateVerifyField();}
else{var valid=this.validate();if(valid){if(this._fieldName==="Contact.Login"||this.isCommonEmailType()){this._checkExistingAccount();}}
this.toggleErrorIndicator(!valid);}},_validateVerifyField:function(errors){errors=errors||[];var valid=true,verifyField=this.Y.one(this._inputSelector+'_Validate'),verifyLabel=this.Y.one(this._inputSelector+'_LabelValidate');if(verifyField&&this.data.attrs.require_validation){if(this.getVerificationValue()!==this.getValue()){errors.push({message:RightNow.Text.sprintf(this.data.attrs.label_validation_incorrect,this.data.attrs.label_input),id:verifyField.get("id")});valid=false;}
this.toggleErrorIndicator(!valid,verifyField,verifyLabel);}
return valid;},_checkExistingAccount:function(){var massagedNewValue=this._massageValueForModificationCheck(this._value);if(this._value===""||this._seenValues.indexOf(massagedNewValue)!==-1||(this.data.js.previousValue&&this._value.replace('&','&amp;').replace("'",'&#039;')===this.data.js.previousValue))
return;this._seenValues.push(massagedNewValue);var eventObject=new RightNow.Event.EventObject(this,{data:{contactToken:this.data.js.contactToken}});if(this.isCommonEmailType())
eventObject.data.email=this._value;else if(this._fieldName==="Contact.Login")
eventObject.data.login=this._value;if(RightNow.Event.fire("evt_accountExistsRequest",eventObject)){RightNow.Ajax.makeRequest(this.data.attrs.existing_contact_check_ajax,eventObject.data,{successHandler:this._onAccountExistsResponse,scope:this,data:eventObject,json:true});}},_massageValueForModificationCheck:function(value){if(this.Y.Lang.isUndefined(value)||value===null||value===""){return"";}
if(this.isCommonEmailType()){value=value.toLowerCase();}
return value;},_onAccountExistsResponse:function(response,originalEventObject){if(RightNow.Event.fire("evt_accountExistsResponse",response,originalEventObject)){if(response!==false&&this._isFormSubmitting===false){this.toggleErrorIndicator(true);var warnDialog,handleOK=function(){warnDialog.hide();this._dialogShowing=false;this.input.focus();};warnDialog=RightNow.UI.Dialog.messageDialog(response.message,{icon:"WARN",exitCallback:{fn:handleOK,scope:this}});this._dialogShowing=true;warnDialog.show();}}},onProvinceChange:function(type,args)
{var eventObj=args[0],resetMask=false;if(!eventObj.ProvincesLength)
this.data.js.mask="";if(this._fieldName==="Contact.Address.PostalCode"&&"PostalMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PostalMask;}
else if("PhoneMask"in eventObj)
{resetMask=true;this.data.js.mask=eventObj.PhoneMask;}
if(this._maskNodeOnPage)
this._maskNodeOnPage.remove();if(resetMask&&this.data.js.mask)
this._initializeMask();},_initializeMask:function()
{this.input.on("keyup",this._compareInputToMask,this);this.input.on("blur",this._hideMaskMessage,this);this.input.on("focus",this._compareInputToMask,this);this.data.js.mask=this._createMaskArray(this.data.js.mask);var overlay=this.Y.Node.create("<div class='rn_MaskOverlay'>");if(this.Y.Overlay){this._maskNode=new this.Y.Overlay({bodyContent:overlay,visible:false,zIndex:1,align:{node:this.input,points:[this.Y.WidgetPositionAlign.TL,this.Y.WidgetPositionAlign.BL]}});this._maskNode.render(this.baseSelector);}
else{this._maskNode=overlay.addClass("rn_Hidden");this.input.insert(this._maskNode,"after");}
if(this.data.attrs.always_show_mask){var maskMessageOnPage=this._getSimpleMaskString(),widgetContainer=this.Y.one(this.baseSelector);if(maskMessageOnPage&&widgetContainer){var messageNode=this.Y.Node.create("<div class='rn_Mask'>"+RightNow.Interface.getMessage("EXPECTED_INPUT_LBL")+": "+maskMessageOnPage+"</div>");if(widgetContainer.get("lastChild").hasClass("rn_HintText")){messageNode.addClass("rn_MaskBuffer");}
this._maskNodeOnPage=messageNode;widgetContainer.append(messageNode);}}},_createMaskArray:function(mask)
{if(!mask)return;var maskArray=[];for(var i=0,j=0,size=mask.length/2;i<size;i++)
{maskArray[i]=mask.substring(j,j+2);j+=2;}
return maskArray;},_getSimpleMaskString:function(){if(!this.data.js.mask)return"";var maskString="";for(var i=0;i<this.data.js.mask.length;i++){switch(this.data.js.mask[i].charAt(0)){case"F":maskString+=this.data.js.mask[i].charAt(1);break;case"U":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="A";break;}
break;case"L":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":maskString+="@";break;case"L":maskString+="a";break;}
break;case"M":switch(this.data.js.mask[i].charAt(1)){case"#":maskString+="#";break;case"A":case"C":case"L":maskString+="@";break;}
break;}}
return maskString;},_compareInputToMask:function(submitting){if(!this.data.js.mask)return true;var error=[],value=this.input.get("value");if(value.length>0){for(var i=0,tempRegExVal;i<value.length;i++){if(i<this.data.js.mask.length){tempRegExVal="";switch(this.data.js.mask[i].charAt(0)){case'F':if(value.charAt(i)!==this.data.js.mask[i].charAt(1))
error.push([i,this.data.js.mask[i]]);break;case'U':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9A-Z]+$/;break;case'L':tempRegExVal=/^[A-Z]+$/;break;case'C':tempRegExVal=/^[^a-z]+$/;break;}
break;case'L':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-z]+$/;break;case'L':tempRegExVal=/^[a-z]+$/;break;case'C':tempRegExVal=/^[^A-Z]+$/;break;}
break;case'M':switch(this.data.js.mask[i].charAt(1)){case'#':tempRegExVal=/^[0-9]+$/;break;case'A':tempRegExVal=/^[0-9a-zA-Z]+$/;break;case'L':tempRegExVal=/^[a-zA-Z]+$/;break;}
break;}
if((tempRegExVal!=="")&&!(tempRegExVal.test(value.charAt(i))))
error.push([i,this.data.js.mask[i]]);}
else
{error.push([i,"LEN"]);}}
if((!error.length)&&(value.length<this.data.js.mask.length)&&(!this.data.attrs.always_show_mask||submitting===true))
{for(i=value.length;i<this.data.js.mask.length;i++)
error.push([i,"MISS"]);}
if(error.length>0)
{this._showMaskMessage(error);if(submitting===true)
this._reportError(RightNow.Interface.getMessage("PCT_S_DIDNT_MATCH_EXPECTED_INPUT_LBL"));return false;}
this._showMaskMessage(null);return true;}
if(!this.data.attrs.always_show_mask&&submitting!==true)
this._showMaskMessage(error);return true;},_showMaskMessage:function(error){if(error===null){this._hideMaskMessage();}
else{if(!this._showMaskMessage._maskMessages){this._showMaskMessage._maskMessages={"F":RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL'),"U#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"L#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"M#":RightNow.Interface.getMessage('PLEASE_TYPE_A_NUMBER_MSG'),"UA":RightNow.Interface.getMessage('PLEASE_ENTER_UPPERCASE_LETTER_MSG'),"UL":RightNow.Interface.getMessage('PLEASE_ENTER_AN_UPPERCASE_LETTER_MSG'),"UC":RightNow.Interface.getMessage('PLS_ENTER_UPPERCASE_LETTER_SPECIAL_MSG'),"LA":RightNow.Interface.getMessage('PLEASE_ENTER_LOWERCASE_LETTER_MSG'),"LL":RightNow.Interface.getMessage('PLEASE_ENTER_A_LOWERCASE_LETTER_MSG'),"LC":RightNow.Interface.getMessage('PLS_ENTER_LOWERCASE_LETTER_SPECIAL_MSG'),"MA":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_OR_A_NUMBER_MSG'),"ML":RightNow.Interface.getMessage('PLEASE_ENTER_A_LETTER_MSG'),"MC":RightNow.Interface.getMessage('PLEASE_ENTER_LETTER_SPECIAL_CHAR_MSG'),"LEN":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_LONG_MSG'),"MISS":RightNow.Interface.getMessage('THE_INPUT_IS_TOO_SHORT_MSG')};}
var message="",sampleMaskString=this._getSimpleMaskString().split("");for(var i=0,type;i<error.length;i++){type=error[i][1];if(type.charAt(0)==="F"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+RightNow.Interface.getMessage('WAITING_FOR_CHARACTER_LBL')+type.charAt(1)+" ' <br>";sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{if(type!=="MISS"){message+="<b>"+RightNow.Interface.getMessage('CHARACTER_LBL')+" "+(error[i][0]+1)+"</b> "+this._showMaskMessage._maskMessages[type]+"<br>";if(type!=="LEN"){sampleMaskString[(error[i][0])]="<span style='color:#E80000;'>"+sampleMaskString[(error[i][0])]+"</span>";}
else{break;}}}}
sampleMaskString=sampleMaskString.join("");this._setMaskMessage(RightNow.Interface.getMessage('EXPECTED_INPUT_LBL')+": "+sampleMaskString+"<br>"+message);this._showMask();}},_setMaskMessage:function(message)
{var overlayContent=this._maskNode.get('bodyContent');if(overlayContent){overlayContent.set('innerHTML',message);}
else{this._maskNode.set('innerHTML',message);}},_showMask:function()
{if(this.Y.Overlay)
this._maskNode.show();else
RightNow.UI.show(this._maskNode);},_hideMaskMessage:function()
{if(this.Y.Overlay&&this._maskNode.get("visible")!==false)
this._maskNode.hide();else
RightNow.UI.hide(this._maskNode);},_onValidateFailure:function()
{if(this.data.js.mask&&this._maskNode.align&&this.Y.Overlay&&this._maskNode.get("visible")!==false){this._maskNode.align();}}});