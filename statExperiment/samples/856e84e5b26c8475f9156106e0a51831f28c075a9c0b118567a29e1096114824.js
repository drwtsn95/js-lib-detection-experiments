!function(e){"use strict";var t=function(e){this.view=new t.View({model:new t.Model(e)})};t.View=Backbone.View.extend({events:{"click #lp-remove-upload-photo":"_removePhoto","click #lp-upload-photo":"_upload","click .lp-cancel-upload":"_cancel"},el:"#lp-user-edit-avatar",uploader:null,initialize(){_.bindAll(this,"filesAdded","uploadProgress","uploadError","fileUploaded","crop"),this._getUploader()},_removePhoto(e){e.preventDefault(),this.$(".profile-picture").toggle().filter(".profile-avatar-current").remove(),this.$("#lp-remove-upload-photo").hide(),this.$("#submit").prop("disabled",!1)},_upload(e){e.preventDefault()},_cancel(e){e.preventDefault(),this.$crop&&this.$crop.remove(),this.$(".lp-avatar-preview").removeClass("croping")},filesAdded(e,t){e.files.splice(0,e.files.length-1),this.$(".lp-avatar-preview").addClass("uploading"),this.$(".lp-avatar-upload-progress-value").width(0),this.uploader.start()},uploadProgress(e,t){this.$(".lp-avatar-upload-progress-value").css("width",t.percent+"%")},uploadError(e,t){this.$(".lp-avatar-preview").addClass("upload-error").removeClass("uploading"),this.$(".lp-avatar-upload-error").html(t)},fileUploaded(t,i,a){this.$(".lp-avatar-preview").removeClass("upload-error").removeClass("uploading");const r=this,s=LP.parseJSON(a.response);s.url&&(this.avatar=s.url,e("<img/>").attr("src",s.url).load((function(){r.model.set(e.extend(s,{width:this.width,height:this.height})),r.crop()})))},crop(){this.model.set("r",Math.random()),new t.Crop(this),this.$("#submit").prop("disabled",!1)},_getUploader(){return this.uploader||(this.uploader=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:"lp-upload-photo",container:e("#lp-user-edit-avatar").get(0),url:("undefined"!=typeof lpGlobalSettings?lpGlobalSettings.ajax:"").addQueryVar("action","learnpress_upload-user-avatar"),filters:{max_file_size:"10mb",mime_types:[{title:"Image",extensions:"png,jpg,bmp,gif"}]},file_data_name:"lp-upload-avatar",init:{PostInit(){},FilesAdded:this.filesAdded,UploadProgress:this.uploadProgress,FileUploaded:this.fileUploaded,Error:this.uploadError}}),this.uploader.init()),this.uploader}}),t.Model=Backbone.Model.extend({}),t.Crop=function(t){const i=this,a=t.model.toJSON(),r=e(LP.template("tmpl-crop-user-avatar")(a));r.appendTo(t.$(".lp-avatar-preview").addClass("croping")),t.$crop=r;let s=r.find("img"),o=0,l=0,d=0,n=0,p=0,h=0;this.initCrop=function(){a.viewWidth/a.viewHeight>=a.width/a.height?(o=a.viewWidth,l=a.height*a.viewWidth/a.width,d=0,n=-(l-a.viewHeight)/2):(l=a.viewHeight,o=a.width*a.viewHeight/a.height,n=0,d=-(o-a.viewWidth)/2),p=o,h=l,s.draggable({drag(t,i){i.position.left>0&&(i.position.left=0),i.position.top>0&&(i.position.top=0);const r=a.viewWidth-p,s=a.viewHeight-h;r>i.position.left&&(i.position.left=r),s>i.position.top&&(i.position.top=s),e(document.body).addClass("profile-dragging")},stop(r,o){d=parseInt(s.css("left")),n=parseInt(s.css("top")),t=(Math.abs(d)+a.viewWidth/2)/p,u=(Math.abs(n)+a.viewHeight/2)/h,i.update({width:p,height:h,top:n,left:d}),e(document.body).removeClass("profile-dragging")}});var t=(Math.abs(d)+a.viewWidth/2)/o,u=(Math.abs(n)+a.viewHeight/2)/l;r.find(".lp-zoom > div").slider({create(){i.update({width:o,height:l,top:n,left:d})},slide(r,s){p=o+s.value/100*a.width*2,h=l+s.value/100*a.height*2;let c=a.viewWidth/2-p*t,f=a.viewHeight/2-h*u;c>0&&(c=0),f>0&&(f=0);const v=parseInt(a.viewWidth-p),g=parseInt(a.viewHeight-h);v>c&&(c=d=v),g>f&&(f=n=g),i.update({width:p,height:h,top:f,left:c}),e(document.body).addClass("profile-resizing"),console.log(s.value,a)},stop(){e(document.body).removeClass("profile-resizing")}})},this.update=function(t){s.css({width:t.width,height:t.height,top:t.top,left:t.left});const i=t.width/a.width,o=parseInt(Math.abs(t.left/i)),l=parseInt(Math.abs(t.top/i)),d=o+parseInt(a.viewWidth/i),n=l+parseInt(a.viewHeight/i),p=e.extend(t,{width:a.viewWidth,height:a.viewHeight,r:i,points:[o,l,d,n].join(",")});r.find('input[name^="lp-user-avatar-crop"]').each((function(){const t=e(this),i=t.data("name");"name"!=i&&t.val(p[i])}))},this.initCrop()},e(document).on("submit","#learn-press-form-login",(function(t){const i=e(this),a=i.serialize();return i.find(".learn-press-error, .learn-press-notice, .learn-press-message").fadeOut(),i.find("input").attr("disabled",!0),LP.doAjax({data:{"lp-ajax":"login",data:a},success(t,a){LP.showMessages(t.message,i,"LOGIN_ERROR"),"error"==t.result&&(i.find("input").attr("disabled",!1),e('#learn-press-form-login input[type="text"]').focus()),t.redirect&&LP.reload(t.redirect)},error(){LP.showMessages("",i,"LOGIN_ERROR"),i.find("input").attr("disabled",!1),e('#learn-press-form-login input[type="text"]').focus()}}),!1})),e(document).on("click",".table-orders .cancel-order",(function(t){t.preventDefault();const i=e(this).attr("href");return LP.alert(learn_press_js_localize.confirm_cancel_order,(function(e){e&&(window.location.href=i)})),!1})),e(document).ready((function(){let a=e("#lp-user-profile-form form"),r=a.serialize(),s=null,o=a.find("#lp-profile-edit-password-form");function l(){a.find("#submit").prop("disabled",!(a.serialize()!=r))}0==o.length?a.on("keyup change","input, textarea, select",(function(){s&&clearTimeout(s),s=setTimeout(l,300)})):o.on("change keyup","input",(function(t){e(t.target).attr("name");const i=a.find("#pass0"),r=a.find("#pass1"),s=a.find("#pass2"),o=!((r.val()||s.val())&&r.val()!=s.val());a.find("#lp-password-not-match").toggleClass("hide-if-js",o),a.find("#submit").prop("disabled",!(o&&i.val()&&r.val()&&s.val()))}));const d={};"undefined"!=typeof lpProfileUserSettings&&(d.viewWidth=parseInt(lpProfileUserSettings.avatar_size.width),d.viewHeight=parseInt(lpProfileUserSettings.avatar_size.height)),new t(d),i.recoverOrder()}));var i={recoverOrder(t){const i=e(".order-recover"),a=i.find(".button-recover-order"),r=i.find('input[name="order-key"]');a.on("click",(function(){a.addClass("disabled").attr("disabled","disabled"),i.find(".learn-press-message").remove(),e.post({url:"",data:i.serializeJSON(),success(t){if((t=LP.parseJSON(t)).message){const a=e('<div class="learn-press-message icon"><i class="fa"></i> '+t.message+"</div>");"error"==t.result&&a.addClass("error"),i.prepend(a)}t.redirect&&(window.location.href=t.redirect),a.removeClass("disabled").removeAttr("disabled","")}})})),r.on("change",(function(){a.prop("disabled",!this.value)}))}}}(jQuery);